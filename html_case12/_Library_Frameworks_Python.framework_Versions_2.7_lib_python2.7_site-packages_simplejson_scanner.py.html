source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/simplejson/scanner.py</b><br>


file stats: <b>96 lines, 19 executed: 19.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;JSON token scanner</font>
<font color="green">   2. &quot;&quot;&quot;</font>
<font color="green">   3. import re</font>
<font color="green">   4. def _import_c_make_scanner():</font>
<font color="green">   5.     try:</font>
<font color="green">   6.         from simplejson._speedups import make_scanner</font>
<font color="green">   7.         return make_scanner</font>
<font color="red">   8.     except ImportError:</font>
<font color="red">   9.         return None</font>
<font color="green">  10. c_make_scanner = _import_c_make_scanner()</font>
<font color="black">  11. </font>
<font color="green">  12. __all__ = ['make_scanner', 'JSONDecodeError']</font>
<font color="black">  13. </font>
<font color="green">  14. NUMBER_RE = re.compile(</font>
<font color="green">  15.     r'(-?(?:0|[1-9]\d*))(\.\d+)?([eE][-+]?\d+)?',</font>
<font color="green">  16.     (re.VERBOSE | re.MULTILINE | re.DOTALL))</font>
<font color="black">  17. </font>
<font color="green">  18. class JSONDecodeError(ValueError):</font>
<font color="black">  19.     &quot;&quot;&quot;Subclass of ValueError with the following additional properties:</font>
<font color="black">  20. </font>
<font color="black">  21.     msg: The unformatted error message</font>
<font color="black">  22.     doc: The JSON document being parsed</font>
<font color="black">  23.     pos: The start index of doc where parsing failed</font>
<font color="black">  24.     end: The end index of doc where parsing failed (may be None)</font>
<font color="black">  25.     lineno: The line corresponding to pos</font>
<font color="black">  26.     colno: The column corresponding to pos</font>
<font color="black">  27.     endlineno: The line corresponding to end (may be None)</font>
<font color="black">  28.     endcolno: The column corresponding to end (may be None)</font>
<font color="black">  29. </font>
<font color="green">  30.     &quot;&quot;&quot;</font>
<font color="black">  31.     # Note that this exception is used from _speedups</font>
<font color="green">  32.     def __init__(self, msg, doc, pos, end=None):</font>
<font color="red">  33.         ValueError.__init__(self, errmsg(msg, doc, pos, end=end))</font>
<font color="red">  34.         self.msg = msg</font>
<font color="red">  35.         self.doc = doc</font>
<font color="red">  36.         self.pos = pos</font>
<font color="red">  37.         self.end = end</font>
<font color="red">  38.         self.lineno, self.colno = linecol(doc, pos)</font>
<font color="red">  39.         if end is not None:</font>
<font color="red">  40.             self.endlineno, self.endcolno = linecol(doc, end)</font>
<font color="black">  41.         else:</font>
<font color="red">  42.             self.endlineno, self.endcolno = None, None</font>
<font color="black">  43. </font>
<font color="green">  44.     def __reduce__(self):</font>
<font color="red">  45.         return self.__class__, (self.msg, self.doc, self.pos, self.end)</font>
<font color="black">  46. </font>
<font color="black">  47. </font>
<font color="green">  48. def linecol(doc, pos):</font>
<font color="red">  49.     lineno = doc.count('\n', 0, pos) + 1</font>
<font color="red">  50.     if lineno == 1:</font>
<font color="red">  51.         colno = pos + 1</font>
<font color="black">  52.     else:</font>
<font color="red">  53.         colno = pos - doc.rindex('\n', 0, pos)</font>
<font color="red">  54.     return lineno, colno</font>
<font color="black">  55. </font>
<font color="black">  56. </font>
<font color="green">  57. def errmsg(msg, doc, pos, end=None):</font>
<font color="red">  58.     lineno, colno = linecol(doc, pos)</font>
<font color="red">  59.     msg = msg.replace('%r', repr(doc[pos:pos + 1]))</font>
<font color="red">  60.     if end is None:</font>
<font color="red">  61.         fmt = '%s: line %d column %d (char %d)'</font>
<font color="red">  62.         return fmt % (msg, lineno, colno, pos)</font>
<font color="red">  63.     endlineno, endcolno = linecol(doc, end)</font>
<font color="red">  64.     fmt = '%s: line %d column %d - line %d column %d (char %d - %d)'</font>
<font color="red">  65.     return fmt % (msg, lineno, colno, endlineno, endcolno, pos, end)</font>
<font color="black">  66. </font>
<font color="black">  67. </font>
<font color="green">  68. def py_make_scanner(context):</font>
<font color="red">  69.     parse_object = context.parse_object</font>
<font color="red">  70.     parse_array = context.parse_array</font>
<font color="red">  71.     parse_string = context.parse_string</font>
<font color="red">  72.     match_number = NUMBER_RE.match</font>
<font color="red">  73.     encoding = context.encoding</font>
<font color="red">  74.     strict = context.strict</font>
<font color="red">  75.     parse_float = context.parse_float</font>
<font color="red">  76.     parse_int = context.parse_int</font>
<font color="red">  77.     parse_constant = context.parse_constant</font>
<font color="red">  78.     object_hook = context.object_hook</font>
<font color="red">  79.     object_pairs_hook = context.object_pairs_hook</font>
<font color="red">  80.     memo = context.memo</font>
<font color="black">  81. </font>
<font color="red">  82.     def _scan_once(string, idx):</font>
<font color="red">  83.         errmsg = 'Expecting value'</font>
<font color="red">  84.         try:</font>
<font color="red">  85.             nextchar = string[idx]</font>
<font color="red">  86.         except IndexError:</font>
<font color="red">  87.             raise JSONDecodeError(errmsg, string, idx)</font>
<font color="black">  88. </font>
<font color="red">  89.         if nextchar == '&quot;':</font>
<font color="red">  90.             return parse_string(string, idx + 1, encoding, strict)</font>
<font color="red">  91.         elif nextchar == '{':</font>
<font color="red">  92.             return parse_object((string, idx + 1), encoding, strict,</font>
<font color="red">  93.                 _scan_once, object_hook, object_pairs_hook, memo)</font>
<font color="red">  94.         elif nextchar == '[':</font>
<font color="red">  95.             return parse_array((string, idx + 1), _scan_once)</font>
<font color="red">  96.         elif nextchar == 'n' and string[idx:idx + 4] == 'null':</font>
<font color="red">  97.             return None, idx + 4</font>
<font color="red">  98.         elif nextchar == 't' and string[idx:idx + 4] == 'true':</font>
<font color="red">  99.             return True, idx + 4</font>
<font color="red"> 100.         elif nextchar == 'f' and string[idx:idx + 5] == 'false':</font>
<font color="red"> 101.             return False, idx + 5</font>
<font color="black"> 102. </font>
<font color="red"> 103.         m = match_number(string, idx)</font>
<font color="red"> 104.         if m is not None:</font>
<font color="red"> 105.             integer, frac, exp = m.groups()</font>
<font color="red"> 106.             if frac or exp:</font>
<font color="red"> 107.                 res = parse_float(integer + (frac or '') + (exp or ''))</font>
<font color="black"> 108.             else:</font>
<font color="red"> 109.                 res = parse_int(integer)</font>
<font color="red"> 110.             return res, m.end()</font>
<font color="red"> 111.         elif nextchar == 'N' and string[idx:idx + 3] == 'NaN':</font>
<font color="red"> 112.             return parse_constant('NaN'), idx + 3</font>
<font color="red"> 113.         elif nextchar == 'I' and string[idx:idx + 8] == 'Infinity':</font>
<font color="red"> 114.             return parse_constant('Infinity'), idx + 8</font>
<font color="red"> 115.         elif nextchar == '-' and string[idx:idx + 9] == '-Infinity':</font>
<font color="red"> 116.             return parse_constant('-Infinity'), idx + 9</font>
<font color="black"> 117.         else:</font>
<font color="red"> 118.             raise JSONDecodeError(errmsg, string, idx)</font>
<font color="black"> 119. </font>
<font color="red"> 120.     def scan_once(string, idx):</font>
<font color="red"> 121.         if idx &lt; 0:</font>
<font color="black"> 122.             # Ensure the same behavior as the C speedup, otherwise</font>
<font color="black"> 123.             # this would work for *some* negative string indices due</font>
<font color="black"> 124.             # to the behavior of __getitem__ for strings. #98</font>
<font color="red"> 125.             raise JSONDecodeError('Expecting value', string, idx)</font>
<font color="red"> 126.         try:</font>
<font color="red"> 127.             return _scan_once(string, idx)</font>
<font color="black"> 128.         finally:</font>
<font color="red"> 129.             memo.clear()</font>
<font color="black"> 130. </font>
<font color="red"> 131.     return scan_once</font>
<font color="black"> 132. </font>
<font color="green"> 133. make_scanner = c_make_scanner or py_make_scanner</font>
</pre>

