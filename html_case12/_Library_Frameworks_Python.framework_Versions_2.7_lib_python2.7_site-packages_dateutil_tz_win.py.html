source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/dateutil/tz/win.py</b><br>


file stats: <b>183 lines, 3 executed: 1.6% covered</b>
<pre>
<font color="black">   1. # This code was originally contributed by Jeffrey Harris.</font>
<font color="green">   2. import datetime</font>
<font color="green">   3. import struct</font>
<font color="black">   4. </font>
<font color="green">   5. from six.moves import winreg</font>
<font color="red">   6. from six import text_type</font>
<font color="black">   7. </font>
<font color="red">   8. try:</font>
<font color="red">   9.     import ctypes</font>
<font color="red">  10.     from ctypes import wintypes</font>
<font color="red">  11. except ValueError:</font>
<font color="black">  12.     # ValueError is raised on non-Windows systems for some horrible reason.</font>
<font color="red">  13.     raise ImportError(&quot;Running tzwin on non-Windows system&quot;)</font>
<font color="black">  14. </font>
<font color="red">  15. from ._common import tzname_in_python2</font>
<font color="black">  16. </font>
<font color="red">  17. __all__ = [&quot;tzwin&quot;, &quot;tzwinlocal&quot;, &quot;tzres&quot;]</font>
<font color="black">  18. </font>
<font color="red">  19. ONEWEEK = datetime.timedelta(7)</font>
<font color="black">  20. </font>
<font color="red">  21. TZKEYNAMENT = r&quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time Zones&quot;</font>
<font color="red">  22. TZKEYNAME9X = r&quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Time Zones&quot;</font>
<font color="red">  23. TZLOCALKEYNAME = r&quot;SYSTEM\CurrentControlSet\Control\TimeZoneInformation&quot;</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="red">  26. def _settzkeyname():</font>
<font color="red">  27.     handle = winreg.ConnectRegistry(None, winreg.HKEY_LOCAL_MACHINE)</font>
<font color="red">  28.     try:</font>
<font color="red">  29.         winreg.OpenKey(handle, TZKEYNAMENT).Close()</font>
<font color="red">  30.         TZKEYNAME = TZKEYNAMENT</font>
<font color="red">  31.     except WindowsError:</font>
<font color="red">  32.         TZKEYNAME = TZKEYNAME9X</font>
<font color="red">  33.     handle.Close()</font>
<font color="red">  34.     return TZKEYNAME</font>
<font color="black">  35. </font>
<font color="red">  36. TZKEYNAME = _settzkeyname()</font>
<font color="black">  37. </font>
<font color="black">  38. </font>
<font color="red">  39. class tzres(object):</font>
<font color="black">  40.     &quot;&quot;&quot;</font>
<font color="black">  41.     Class for accessing `tzres.dll`, which contains timezone name related</font>
<font color="black">  42.     resources.</font>
<font color="black">  43. </font>
<font color="black">  44.     ..versionadded:: 2.5.0</font>
<font color="red">  45.     &quot;&quot;&quot;</font>
<font color="red">  46.     p_wchar = ctypes.POINTER(wintypes.WCHAR)        # Pointer to a wide char</font>
<font color="black">  47. </font>
<font color="red">  48.     def __init__(self, tzres_loc='tzres.dll'):</font>
<font color="black">  49.         # Load the user32 DLL so we can load strings from tzres</font>
<font color="red">  50.         user32 = ctypes.WinDLL('user32')</font>
<font color="black">  51. </font>
<font color="black">  52.         # Specify the LoadStringW function</font>
<font color="red">  53.         user32.LoadStringW.argtypes = (wintypes.HINSTANCE,</font>
<font color="red">  54.                                        wintypes.UINT,</font>
<font color="red">  55.                                        wintypes.LPWSTR,</font>
<font color="red">  56.                                        ctypes.c_int)</font>
<font color="black">  57. </font>
<font color="red">  58.         self.LoadStringW = user32.LoadStringW</font>
<font color="red">  59.         self._tzres = ctypes.WinDLL(tzres_loc)</font>
<font color="red">  60.         self.tzres_loc = tzres_loc</font>
<font color="black">  61. </font>
<font color="red">  62.     def load_name(self, offset):</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="black">  64.         Load a timezone name from a DLL offset (integer).</font>
<font color="black">  65. </font>
<font color="black">  66.         &gt;&gt;&gt; from dateutil.tzwin import tzres</font>
<font color="black">  67.         &gt;&gt;&gt; tzr = tzres()</font>
<font color="black">  68.         &gt;&gt;&gt; print(tzr.load_name(112))</font>
<font color="black">  69.         'Eastern Standard Time'</font>
<font color="black">  70. </font>
<font color="black">  71.         :param offset:</font>
<font color="black">  72.             A positive integer value referring to a string from the tzres dll.</font>
<font color="black">  73. </font>
<font color="black">  74.         ..note:</font>
<font color="black">  75.             Offsets found in the registry are generally of the form</font>
<font color="black">  76.             `@tzres.dll,-114`. The offset in this case if 114, not -114.</font>
<font color="black">  77. </font>
<font color="black">  78.         &quot;&quot;&quot;</font>
<font color="red">  79.         resource = self.p_wchar()</font>
<font color="red">  80.         lpBuffer = ctypes.cast(ctypes.byref(resource), wintypes.LPWSTR)</font>
<font color="red">  81.         nchar = self.LoadStringW(self._tzres._handle, offset, lpBuffer, 0)</font>
<font color="red">  82.         return resource[:nchar]</font>
<font color="black">  83. </font>
<font color="red">  84.     def name_from_string(self, tzname_str):</font>
<font color="black">  85.         &quot;&quot;&quot;</font>
<font color="black">  86.         Parse strings as returned from the Windows registry into the time zone</font>
<font color="black">  87.         name as defined in the registry.</font>
<font color="black">  88. </font>
<font color="black">  89.         &gt;&gt;&gt; from dateutil.tzwin import tzres</font>
<font color="black">  90.         &gt;&gt;&gt; tzr = tzres()</font>
<font color="black">  91.         &gt;&gt;&gt; print(tzr.name_from_string('@tzres.dll,-251'))</font>
<font color="black">  92.         'Dateline Daylight Time'</font>
<font color="black">  93.         &gt;&gt;&gt; print(tzr.name_from_string('Eastern Standard Time'))</font>
<font color="black">  94.         'Eastern Standard Time'</font>
<font color="black">  95. </font>
<font color="black">  96.         :param tzname_str:</font>
<font color="black">  97.             A timezone name string as returned from a Windows registry key.</font>
<font color="black">  98. </font>
<font color="black">  99.         :return:</font>
<font color="black"> 100.             Returns the localized timezone string from tzres.dll if the string</font>
<font color="black"> 101.             is of the form `@tzres.dll,-offset`, else returns the input string.</font>
<font color="black"> 102.         &quot;&quot;&quot;</font>
<font color="red"> 103.         if not tzname_str.startswith('@'):</font>
<font color="red"> 104.             return tzname_str</font>
<font color="black"> 105. </font>
<font color="red"> 106.         name_splt = tzname_str.split(',-')</font>
<font color="red"> 107.         try:</font>
<font color="red"> 108.             offset = int(name_splt[1])</font>
<font color="red"> 109.         except:</font>
<font color="red"> 110.             raise ValueError(&quot;Malformed timezone string.&quot;)</font>
<font color="black"> 111. </font>
<font color="red"> 112.         return self.load_name(offset)</font>
<font color="black"> 113. </font>
<font color="black"> 114. </font>
<font color="red"> 115. class tzwinbase(datetime.tzinfo):</font>
<font color="red"> 116.     &quot;&quot;&quot;tzinfo class based on win32's timezones available in the registry.&quot;&quot;&quot;</font>
<font color="red"> 117.     def __eq__(self, other):</font>
<font color="black"> 118.         # Compare on all relevant dimensions, including name.</font>
<font color="red"> 119.         return (isinstance(other, tzwinbase) and</font>
<font color="red"> 120.                 (self._stdoffset == other._stdoffset and</font>
<font color="red"> 121.                  self._dstoffset == other._dstoffset and</font>
<font color="red"> 122.                  self._stddayofweek == other._stddayofweek and</font>
<font color="red"> 123.                  self._dstdayofweek == other._dstdayofweek and</font>
<font color="red"> 124.                  self._stdweeknumber == other._stdweeknumber and</font>
<font color="red"> 125.                  self._dstweeknumber == other._dstweeknumber and</font>
<font color="red"> 126.                  self._stdhour == other._stdhour and</font>
<font color="red"> 127.                  self._dsthour == other._dsthour and</font>
<font color="red"> 128.                  self._stdminute == other._stdminute and</font>
<font color="red"> 129.                  self._dstminute == other._dstminute and</font>
<font color="red"> 130.                  self._stdname == other._stdname and</font>
<font color="red"> 131.                  self._dstname == other._dstname))</font>
<font color="black"> 132. </font>
<font color="red"> 133.     def __ne__(self, other):</font>
<font color="red"> 134.         return not self.__eq__(other)</font>
<font color="black"> 135. </font>
<font color="red"> 136.     def utcoffset(self, dt):</font>
<font color="red"> 137.         isdst = self._isdst(dt)</font>
<font color="black"> 138. </font>
<font color="red"> 139.         if isdst is None:</font>
<font color="red"> 140.             return None</font>
<font color="red"> 141.         elif isdst:</font>
<font color="red"> 142.             return datetime.timedelta(minutes=self._dstoffset)</font>
<font color="black"> 143.         else:</font>
<font color="red"> 144.             return datetime.timedelta(minutes=self._stdoffset)</font>
<font color="black"> 145. </font>
<font color="red"> 146.     def dst(self, dt):</font>
<font color="red"> 147.         isdst = self._isdst(dt)</font>
<font color="black"> 148. </font>
<font color="red"> 149.         if isdst is None:</font>
<font color="red"> 150.             return None</font>
<font color="red"> 151.         elif isdst:</font>
<font color="red"> 152.             minutes = self._dstoffset - self._stdoffset</font>
<font color="red"> 153.             return datetime.timedelta(minutes=minutes)</font>
<font color="black"> 154.         else:</font>
<font color="red"> 155.             return datetime.timedelta(0)</font>
<font color="black"> 156. </font>
<font color="red"> 157.     @tzname_in_python2</font>
<font color="black"> 158.     def tzname(self, dt):</font>
<font color="red"> 159.         if self._isdst(dt):</font>
<font color="red"> 160.             return self._dstname</font>
<font color="black"> 161.         else:</font>
<font color="red"> 162.             return self._stdname</font>
<font color="black"> 163. </font>
<font color="red"> 164.     @staticmethod</font>
<font color="black"> 165.     def list():</font>
<font color="black"> 166.         &quot;&quot;&quot;Return a list of all time zones known to the system.&quot;&quot;&quot;</font>
<font color="red"> 167.         handle = winreg.ConnectRegistry(None, winreg.HKEY_LOCAL_MACHINE)</font>
<font color="red"> 168.         tzkey = winreg.OpenKey(handle, TZKEYNAME)</font>
<font color="red"> 169.         result = [winreg.EnumKey(tzkey, i)</font>
<font color="red"> 170.                   for i in range(winreg.QueryInfoKey(tzkey)[0])]</font>
<font color="red"> 171.         tzkey.Close()</font>
<font color="red"> 172.         handle.Close()</font>
<font color="red"> 173.         return result</font>
<font color="black"> 174. </font>
<font color="red"> 175.     def display(self):</font>
<font color="red"> 176.         return self._display</font>
<font color="black"> 177. </font>
<font color="red"> 178.     def _isdst(self, dt):</font>
<font color="red"> 179.         if not self._dstmonth:</font>
<font color="black"> 180.             # dstmonth == 0 signals the zone has no daylight saving time</font>
<font color="red"> 181.             return False</font>
<font color="red"> 182.         elif dt is None:</font>
<font color="red"> 183.             return None</font>
<font color="black"> 184. </font>
<font color="red"> 185.         dston = picknthweekday(dt.year, self._dstmonth, self._dstdayofweek,</font>
<font color="red"> 186.                                self._dsthour, self._dstminute,</font>
<font color="red"> 187.                                self._dstweeknumber)</font>
<font color="red"> 188.         dstoff = picknthweekday(dt.year, self._stdmonth, self._stddayofweek,</font>
<font color="red"> 189.                                 self._stdhour, self._stdminute,</font>
<font color="red"> 190.                                 self._stdweeknumber)</font>
<font color="red"> 191.         if dston &lt; dstoff:</font>
<font color="red"> 192.             return dston &lt;= dt.replace(tzinfo=None) &lt; dstoff</font>
<font color="black"> 193.         else:</font>
<font color="red"> 194.             return not dstoff &lt;= dt.replace(tzinfo=None) &lt; dston</font>
<font color="black"> 195. </font>
<font color="black"> 196. </font>
<font color="red"> 197. class tzwin(tzwinbase):</font>
<font color="black"> 198. </font>
<font color="red"> 199.     def __init__(self, name):</font>
<font color="red"> 200.         self._name = name</font>
<font color="black"> 201. </font>
<font color="black"> 202.         # multiple contexts only possible in 2.7 and 3.1, we still support 2.6</font>
<font color="red"> 203.         with winreg.ConnectRegistry(None, winreg.HKEY_LOCAL_MACHINE) as handle:</font>
<font color="red"> 204.             tzkeyname = text_type(&quot;{kn}\{name}&quot;).format(kn=TZKEYNAME, name=name)</font>
<font color="red"> 205.             with winreg.OpenKey(handle, tzkeyname) as tzkey:</font>
<font color="red"> 206.                 keydict = valuestodict(tzkey)</font>
<font color="black"> 207. </font>
<font color="red"> 208.         self._stdname = keydict[&quot;Std&quot;]</font>
<font color="red"> 209.         self._dstname = keydict[&quot;Dlt&quot;]</font>
<font color="black"> 210. </font>
<font color="red"> 211.         self._display = keydict[&quot;Display&quot;]</font>
<font color="black"> 212. </font>
<font color="black"> 213.         # See http://ww_winreg.jsiinc.com/SUBA/tip0300/rh0398.htm</font>
<font color="red"> 214.         tup = struct.unpack(&quot;=3l16h&quot;, keydict[&quot;TZI&quot;])</font>
<font color="red"> 215.         self._stdoffset = -tup[0]-tup[1]          # Bias + StandardBias * -1</font>
<font color="red"> 216.         self._dstoffset = self._stdoffset-tup[2]  # + DaylightBias * -1</font>
<font color="black"> 217. </font>
<font color="black"> 218.         # for the meaning see the win32 TIME_ZONE_INFORMATION structure docs</font>
<font color="black"> 219.         # http://msdn.microsoft.com/en-us/library/windows/desktop/ms725481(v=vs.85).aspx</font>
<font color="black"> 220.         (self._stdmonth,</font>
<font color="black"> 221.          self._stddayofweek,   # Sunday = 0</font>
<font color="black"> 222.          self._stdweeknumber,  # Last = 5</font>
<font color="black"> 223.          self._stdhour,</font>
<font color="red"> 224.          self._stdminute) = tup[4:9]</font>
<font color="black"> 225. </font>
<font color="black"> 226.         (self._dstmonth,</font>
<font color="black"> 227.          self._dstdayofweek,   # Sunday = 0</font>
<font color="black"> 228.          self._dstweeknumber,  # Last = 5</font>
<font color="black"> 229.          self._dsthour,</font>
<font color="red"> 230.          self._dstminute) = tup[12:17]</font>
<font color="black"> 231. </font>
<font color="red"> 232.     def __repr__(self):</font>
<font color="red"> 233.         return &quot;tzwin(%s)&quot; % repr(self._name)</font>
<font color="black"> 234. </font>
<font color="red"> 235.     def __reduce__(self):</font>
<font color="red"> 236.         return (self.__class__, (self._name,))</font>
<font color="black"> 237. </font>
<font color="black"> 238. </font>
<font color="red"> 239. class tzwinlocal(tzwinbase):</font>
<font color="black"> 240. </font>
<font color="red"> 241.     def __init__(self):</font>
<font color="red"> 242.         with winreg.ConnectRegistry(None, winreg.HKEY_LOCAL_MACHINE) as handle:</font>
<font color="black"> 243. </font>
<font color="red"> 244.             with winreg.OpenKey(handle, TZLOCALKEYNAME) as tzlocalkey:</font>
<font color="red"> 245.                 keydict = valuestodict(tzlocalkey)</font>
<font color="black"> 246. </font>
<font color="red"> 247.             self._stdname = keydict[&quot;StandardName&quot;]</font>
<font color="red"> 248.             self._dstname = keydict[&quot;DaylightName&quot;]</font>
<font color="black"> 249. </font>
<font color="red"> 250.             try:</font>
<font color="red"> 251.                 tzkeyname = text_type('{kn}\{sn}').format(kn=TZKEYNAME,</font>
<font color="red"> 252.                                                           sn=self._stdname)</font>
<font color="red"> 253.                 with winreg.OpenKey(handle, tzkeyname) as tzkey:</font>
<font color="red"> 254.                     _keydict = valuestodict(tzkey)</font>
<font color="red"> 255.                     self._display = _keydict[&quot;Display&quot;]</font>
<font color="red"> 256.             except OSError:</font>
<font color="red"> 257.                 self._display = None</font>
<font color="black"> 258. </font>
<font color="red"> 259.         self._stdoffset = -keydict[&quot;Bias&quot;]-keydict[&quot;StandardBias&quot;]</font>
<font color="red"> 260.         self._dstoffset = self._stdoffset-keydict[&quot;DaylightBias&quot;]</font>
<font color="black"> 261. </font>
<font color="black"> 262.         # For reasons unclear, in this particular key, the day of week has been</font>
<font color="black"> 263.         # moved to the END of the SYSTEMTIME structure.</font>
<font color="red"> 264.         tup = struct.unpack(&quot;=8h&quot;, keydict[&quot;StandardStart&quot;])</font>
<font color="black"> 265. </font>
<font color="black"> 266.         (self._stdmonth,</font>
<font color="black"> 267.          self._stdweeknumber,  # Last = 5</font>
<font color="black"> 268.          self._stdhour,</font>
<font color="red"> 269.          self._stdminute) = tup[1:5]</font>
<font color="black"> 270. </font>
<font color="red"> 271.         self._stddayofweek = tup[7]</font>
<font color="black"> 272. </font>
<font color="red"> 273.         tup = struct.unpack(&quot;=8h&quot;, keydict[&quot;DaylightStart&quot;])</font>
<font color="black"> 274. </font>
<font color="black"> 275.         (self._dstmonth,</font>
<font color="black"> 276.          self._dstweeknumber,  # Last = 5</font>
<font color="black"> 277.          self._dsthour,</font>
<font color="red"> 278.          self._dstminute) = tup[1:5]</font>
<font color="black"> 279. </font>
<font color="red"> 280.         self._dstdayofweek = tup[7]</font>
<font color="black"> 281. </font>
<font color="red"> 282.     def __repr__(self):</font>
<font color="red"> 283.         return &quot;tzwinlocal()&quot;</font>
<font color="black"> 284. </font>
<font color="red"> 285.     def __str__(self):</font>
<font color="black"> 286.         # str will return the standard name, not the daylight name.</font>
<font color="red"> 287.         return &quot;tzwinlocal(%s)&quot; % repr(self._stdname)</font>
<font color="black"> 288. </font>
<font color="red"> 289.     def __reduce__(self):</font>
<font color="red"> 290.         return (self.__class__, ())</font>
<font color="black"> 291. </font>
<font color="black"> 292. </font>
<font color="red"> 293. def picknthweekday(year, month, dayofweek, hour, minute, whichweek):</font>
<font color="black"> 294.     &quot;&quot;&quot; dayofweek == 0 means Sunday, whichweek 5 means last instance &quot;&quot;&quot;</font>
<font color="red"> 295.     first = datetime.datetime(year, month, 1, hour, minute)</font>
<font color="black"> 296. </font>
<font color="black"> 297.     # This will work if dayofweek is ISO weekday (1-7) or Microsoft-style (0-6),</font>
<font color="black"> 298.     # Because 7 % 7 = 0</font>
<font color="red"> 299.     weekdayone = first.replace(day=((dayofweek - first.isoweekday()) % 7) + 1)</font>
<font color="red"> 300.     wd = weekdayone + ((whichweek - 1) * ONEWEEK)</font>
<font color="red"> 301.     if (wd.month != month):</font>
<font color="red"> 302.         wd -= ONEWEEK</font>
<font color="black"> 303. </font>
<font color="red"> 304.     return wd</font>
<font color="black"> 305. </font>
<font color="black"> 306. </font>
<font color="red"> 307. def valuestodict(key):</font>
<font color="black"> 308.     &quot;&quot;&quot;Convert a registry key's values to a dictionary.&quot;&quot;&quot;</font>
<font color="red"> 309.     dout = {}</font>
<font color="red"> 310.     size = winreg.QueryInfoKey(key)[1]</font>
<font color="red"> 311.     tz_res = None</font>
<font color="black"> 312. </font>
<font color="red"> 313.     for i in range(size):</font>
<font color="red"> 314.         key_name, value, dtype = winreg.EnumValue(key, i)</font>
<font color="red"> 315.         if dtype == winreg.REG_DWORD or dtype == winreg.REG_DWORD_LITTLE_ENDIAN:</font>
<font color="black"> 316.             # If it's a DWORD (32-bit integer), it's stored as unsigned - convert</font>
<font color="black"> 317.             # that to a proper signed integer</font>
<font color="red"> 318.             if value &amp; (1 &lt;&lt; 31):</font>
<font color="red"> 319.                 value = value - (1 &lt;&lt; 32)</font>
<font color="red"> 320.         elif dtype == winreg.REG_SZ:</font>
<font color="black"> 321.             # If it's a reference to the tzres DLL, load the actual string</font>
<font color="red"> 322.             if value.startswith('@tzres'):</font>
<font color="red"> 323.                 tz_res = tz_res or tzres()</font>
<font color="red"> 324.                 value = tz_res.name_from_string(value)</font>
<font color="black"> 325. </font>
<font color="red"> 326.             value = value.rstrip('\x00')    # Remove trailing nulls</font>
<font color="black"> 327. </font>
<font color="red"> 328.         dout[key_name] = value</font>
<font color="black"> 329. </font>
<font color="red"> 330.     return dout</font>
</pre>

