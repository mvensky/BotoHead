source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/packaging/version.py</b><br>


file stats: <b>184 lines, 53 executed: 28.8% covered</b>
<pre>
<font color="black">   1. # This file is dual licensed under the terms of the Apache License, Version</font>
<font color="black">   2. # 2.0, and the BSD License. See the LICENSE file in the root of this repository</font>
<font color="black">   3. # for complete details.</font>
<font color="green">   4. from __future__ import absolute_import, division, print_function</font>
<font color="black">   5. </font>
<font color="green">   6. import collections</font>
<font color="green">   7. import itertools</font>
<font color="green">   8. import re</font>
<font color="black">   9. </font>
<font color="green">  10. from ._structures import Infinity</font>
<font color="black">  11. </font>
<font color="black">  12. </font>
<font color="black">  13. __all__ = [</font>
<font color="green">  14.     &quot;parse&quot;, &quot;Version&quot;, &quot;LegacyVersion&quot;, &quot;InvalidVersion&quot;, &quot;VERSION_PATTERN&quot;</font>
<font color="black">  15. ]</font>
<font color="black">  16. </font>
<font color="black">  17. </font>
<font color="green">  18. _Version = collections.namedtuple(</font>
<font color="green">  19.     &quot;_Version&quot;,</font>
<font color="green">  20.     [&quot;epoch&quot;, &quot;release&quot;, &quot;dev&quot;, &quot;pre&quot;, &quot;post&quot;, &quot;local&quot;],</font>
<font color="black">  21. )</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. def parse(version):</font>
<font color="black">  25.     &quot;&quot;&quot;</font>
<font color="black">  26.     Parse the given version string and return either a :class:`Version` object</font>
<font color="black">  27.     or a :class:`LegacyVersion` object depending on if the given version is</font>
<font color="black">  28.     a valid PEP 440 version or a legacy version.</font>
<font color="black">  29.     &quot;&quot;&quot;</font>
<font color="red">  30.     try:</font>
<font color="red">  31.         return Version(version)</font>
<font color="red">  32.     except InvalidVersion:</font>
<font color="red">  33.         return LegacyVersion(version)</font>
<font color="black">  34. </font>
<font color="black">  35. </font>
<font color="green">  36. class InvalidVersion(ValueError):</font>
<font color="black">  37.     &quot;&quot;&quot;</font>
<font color="black">  38.     An invalid version was found, users should refer to PEP 440.</font>
<font color="green">  39.     &quot;&quot;&quot;</font>
<font color="black">  40. </font>
<font color="black">  41. </font>
<font color="green">  42. class _BaseVersion(object):</font>
<font color="black">  43. </font>
<font color="green">  44.     def __hash__(self):</font>
<font color="red">  45.         return hash(self._key)</font>
<font color="black">  46. </font>
<font color="green">  47.     def __lt__(self, other):</font>
<font color="red">  48.         return self._compare(other, lambda s, o: s &lt; o)</font>
<font color="black">  49. </font>
<font color="green">  50.     def __le__(self, other):</font>
<font color="red">  51.         return self._compare(other, lambda s, o: s &lt;= o)</font>
<font color="black">  52. </font>
<font color="green">  53.     def __eq__(self, other):</font>
<font color="red">  54.         return self._compare(other, lambda s, o: s == o)</font>
<font color="black">  55. </font>
<font color="green">  56.     def __ge__(self, other):</font>
<font color="red">  57.         return self._compare(other, lambda s, o: s &gt;= o)</font>
<font color="black">  58. </font>
<font color="green">  59.     def __gt__(self, other):</font>
<font color="red">  60.         return self._compare(other, lambda s, o: s &gt; o)</font>
<font color="black">  61. </font>
<font color="green">  62.     def __ne__(self, other):</font>
<font color="red">  63.         return self._compare(other, lambda s, o: s != o)</font>
<font color="black">  64. </font>
<font color="green">  65.     def _compare(self, other, method):</font>
<font color="red">  66.         if not isinstance(other, _BaseVersion):</font>
<font color="red">  67.             return NotImplemented</font>
<font color="black">  68. </font>
<font color="red">  69.         return method(self._key, other._key)</font>
<font color="black">  70. </font>
<font color="black">  71. </font>
<font color="green">  72. class LegacyVersion(_BaseVersion):</font>
<font color="black">  73. </font>
<font color="green">  74.     def __init__(self, version):</font>
<font color="red">  75.         self._version = str(version)</font>
<font color="red">  76.         self._key = _legacy_cmpkey(self._version)</font>
<font color="black">  77. </font>
<font color="green">  78.     def __str__(self):</font>
<font color="red">  79.         return self._version</font>
<font color="black">  80. </font>
<font color="green">  81.     def __repr__(self):</font>
<font color="red">  82.         return &quot;&lt;LegacyVersion({0})&gt;&quot;.format(repr(str(self)))</font>
<font color="black">  83. </font>
<font color="green">  84.     @property</font>
<font color="black">  85.     def public(self):</font>
<font color="red">  86.         return self._version</font>
<font color="black">  87. </font>
<font color="green">  88.     @property</font>
<font color="black">  89.     def base_version(self):</font>
<font color="red">  90.         return self._version</font>
<font color="black">  91. </font>
<font color="green">  92.     @property</font>
<font color="black">  93.     def local(self):</font>
<font color="red">  94.         return None</font>
<font color="black">  95. </font>
<font color="green">  96.     @property</font>
<font color="black">  97.     def is_prerelease(self):</font>
<font color="red">  98.         return False</font>
<font color="black">  99. </font>
<font color="green"> 100.     @property</font>
<font color="black"> 101.     def is_postrelease(self):</font>
<font color="red"> 102.         return False</font>
<font color="black"> 103. </font>
<font color="black"> 104. </font>
<font color="green"> 105. _legacy_version_component_re = re.compile(</font>
<font color="green"> 106.     r&quot;(\d+ | [a-z]+ | \.| -)&quot;, re.VERBOSE,</font>
<font color="black"> 107. )</font>
<font color="black"> 108. </font>
<font color="green"> 109. _legacy_version_replacement_map = {</font>
<font color="green"> 110.     &quot;pre&quot;: &quot;c&quot;, &quot;preview&quot;: &quot;c&quot;, &quot;-&quot;: &quot;final-&quot;, &quot;rc&quot;: &quot;c&quot;, &quot;dev&quot;: &quot;@&quot;,</font>
<font color="black"> 111. }</font>
<font color="black"> 112. </font>
<font color="black"> 113. </font>
<font color="green"> 114. def _parse_version_parts(s):</font>
<font color="red"> 115.     for part in _legacy_version_component_re.split(s):</font>
<font color="red"> 116.         part = _legacy_version_replacement_map.get(part, part)</font>
<font color="black"> 117. </font>
<font color="red"> 118.         if not part or part == &quot;.&quot;:</font>
<font color="red"> 119.             continue</font>
<font color="black"> 120. </font>
<font color="red"> 121.         if part[:1] in &quot;0123456789&quot;:</font>
<font color="black"> 122.             # pad for numeric comparison</font>
<font color="red"> 123.             yield part.zfill(8)</font>
<font color="black"> 124.         else:</font>
<font color="red"> 125.             yield &quot;*&quot; + part</font>
<font color="black"> 126. </font>
<font color="black"> 127.     # ensure that alpha/beta/candidate are before final</font>
<font color="red"> 128.     yield &quot;*final&quot;</font>
<font color="black"> 129. </font>
<font color="black"> 130. </font>
<font color="green"> 131. def _legacy_cmpkey(version):</font>
<font color="black"> 132.     # We hardcode an epoch of -1 here. A PEP 440 version can only have a epoch</font>
<font color="black"> 133.     # greater than or equal to 0. This will effectively put the LegacyVersion,</font>
<font color="black"> 134.     # which uses the defacto standard originally implemented by setuptools,</font>
<font color="black"> 135.     # as before all PEP 440 versions.</font>
<font color="red"> 136.     epoch = -1</font>
<font color="black"> 137. </font>
<font color="black"> 138.     # This scheme is taken from pkg_resources.parse_version setuptools prior to</font>
<font color="black"> 139.     # it's adoption of the packaging library.</font>
<font color="red"> 140.     parts = []</font>
<font color="red"> 141.     for part in _parse_version_parts(version.lower()):</font>
<font color="red"> 142.         if part.startswith(&quot;*&quot;):</font>
<font color="black"> 143.             # remove &quot;-&quot; before a prerelease tag</font>
<font color="red"> 144.             if part &lt; &quot;*final&quot;:</font>
<font color="red"> 145.                 while parts and parts[-1] == &quot;*final-&quot;:</font>
<font color="red"> 146.                     parts.pop()</font>
<font color="black"> 147. </font>
<font color="black"> 148.             # remove trailing zeros from each series of numeric parts</font>
<font color="red"> 149.             while parts and parts[-1] == &quot;00000000&quot;:</font>
<font color="red"> 150.                 parts.pop()</font>
<font color="black"> 151. </font>
<font color="red"> 152.         parts.append(part)</font>
<font color="red"> 153.     parts = tuple(parts)</font>
<font color="black"> 154. </font>
<font color="red"> 155.     return epoch, parts</font>
<font color="black"> 156. </font>
<font color="black"> 157. # Deliberately not anchored to the start and end of the string, to make it</font>
<font color="black"> 158. # easier for 3rd party code to reuse</font>
<font color="black"> 159. VERSION_PATTERN = r&quot;&quot;&quot;</font>
<font color="black"> 160.     v?</font>
<font color="black"> 161.     (?:</font>
<font color="black"> 162.         (?:(?P&lt;epoch&gt;[0-9]+)!)?                           # epoch</font>
<font color="black"> 163.         (?P&lt;release&gt;[0-9]+(?:\.[0-9]+)*)                  # release segment</font>
<font color="black"> 164.         (?P&lt;pre&gt;                                          # pre-release</font>
<font color="black"> 165.             [-_\.]?</font>
<font color="black"> 166.             (?P&lt;pre_l&gt;(a|b|c|rc|alpha|beta|pre|preview))</font>
<font color="black"> 167.             [-_\.]?</font>
<font color="black"> 168.             (?P&lt;pre_n&gt;[0-9]+)?</font>
<font color="black"> 169.         )?</font>
<font color="black"> 170.         (?P&lt;post&gt;                                         # post release</font>
<font color="black"> 171.             (?:-(?P&lt;post_n1&gt;[0-9]+))</font>
<font color="black"> 172.             |</font>
<font color="black"> 173.             (?:</font>
<font color="black"> 174.                 [-_\.]?</font>
<font color="black"> 175.                 (?P&lt;post_l&gt;post|rev|r)</font>
<font color="black"> 176.                 [-_\.]?</font>
<font color="black"> 177.                 (?P&lt;post_n2&gt;[0-9]+)?</font>
<font color="black"> 178.             )</font>
<font color="black"> 179.         )?</font>
<font color="black"> 180.         (?P&lt;dev&gt;                                          # dev release</font>
<font color="black"> 181.             [-_\.]?</font>
<font color="black"> 182.             (?P&lt;dev_l&gt;dev)</font>
<font color="black"> 183.             [-_\.]?</font>
<font color="black"> 184.             (?P&lt;dev_n&gt;[0-9]+)?</font>
<font color="black"> 185.         )?</font>
<font color="black"> 186.     )</font>
<font color="black"> 187.     (?:\+(?P&lt;local&gt;[a-z0-9]+(?:[-_\.][a-z0-9]+)*))?       # local version</font>
<font color="green"> 188. &quot;&quot;&quot;</font>
<font color="black"> 189. </font>
<font color="black"> 190. </font>
<font color="green"> 191. class Version(_BaseVersion):</font>
<font color="black"> 192. </font>
<font color="green"> 193.     _regex = re.compile(</font>
<font color="green"> 194.         r&quot;^\s*&quot; + VERSION_PATTERN + r&quot;\s*$&quot;,</font>
<font color="green"> 195.         re.VERBOSE | re.IGNORECASE,</font>
<font color="black"> 196.     )</font>
<font color="black"> 197. </font>
<font color="green"> 198.     def __init__(self, version):</font>
<font color="black"> 199.         # Validate the version and parse it into pieces</font>
<font color="red"> 200.         match = self._regex.search(version)</font>
<font color="red"> 201.         if not match:</font>
<font color="red"> 202.             raise InvalidVersion(&quot;Invalid version: '{0}'&quot;.format(version))</font>
<font color="black"> 203. </font>
<font color="black"> 204.         # Store the parsed out pieces of the version</font>
<font color="red"> 205.         self._version = _Version(</font>
<font color="red"> 206.             epoch=int(match.group(&quot;epoch&quot;)) if match.group(&quot;epoch&quot;) else 0,</font>
<font color="red"> 207.             release=tuple(int(i) for i in match.group(&quot;release&quot;).split(&quot;.&quot;)),</font>
<font color="red"> 208.             pre=_parse_letter_version(</font>
<font color="red"> 209.                 match.group(&quot;pre_l&quot;),</font>
<font color="red"> 210.                 match.group(&quot;pre_n&quot;),</font>
<font color="black"> 211.             ),</font>
<font color="red"> 212.             post=_parse_letter_version(</font>
<font color="red"> 213.                 match.group(&quot;post_l&quot;),</font>
<font color="red"> 214.                 match.group(&quot;post_n1&quot;) or match.group(&quot;post_n2&quot;),</font>
<font color="black"> 215.             ),</font>
<font color="red"> 216.             dev=_parse_letter_version(</font>
<font color="red"> 217.                 match.group(&quot;dev_l&quot;),</font>
<font color="red"> 218.                 match.group(&quot;dev_n&quot;),</font>
<font color="black"> 219.             ),</font>
<font color="red"> 220.             local=_parse_local_version(match.group(&quot;local&quot;)),</font>
<font color="black"> 221.         )</font>
<font color="black"> 222. </font>
<font color="black"> 223.         # Generate a key which will be used for sorting</font>
<font color="red"> 224.         self._key = _cmpkey(</font>
<font color="red"> 225.             self._version.epoch,</font>
<font color="red"> 226.             self._version.release,</font>
<font color="red"> 227.             self._version.pre,</font>
<font color="red"> 228.             self._version.post,</font>
<font color="red"> 229.             self._version.dev,</font>
<font color="red"> 230.             self._version.local,</font>
<font color="black"> 231.         )</font>
<font color="black"> 232. </font>
<font color="green"> 233.     def __repr__(self):</font>
<font color="red"> 234.         return &quot;&lt;Version({0})&gt;&quot;.format(repr(str(self)))</font>
<font color="black"> 235. </font>
<font color="green"> 236.     def __str__(self):</font>
<font color="red"> 237.         parts = []</font>
<font color="black"> 238. </font>
<font color="black"> 239.         # Epoch</font>
<font color="red"> 240.         if self._version.epoch != 0:</font>
<font color="red"> 241.             parts.append(&quot;{0}!&quot;.format(self._version.epoch))</font>
<font color="black"> 242. </font>
<font color="black"> 243.         # Release segment</font>
<font color="red"> 244.         parts.append(&quot;.&quot;.join(str(x) for x in self._version.release))</font>
<font color="black"> 245. </font>
<font color="black"> 246.         # Pre-release</font>
<font color="red"> 247.         if self._version.pre is not None:</font>
<font color="red"> 248.             parts.append(&quot;&quot;.join(str(x) for x in self._version.pre))</font>
<font color="black"> 249. </font>
<font color="black"> 250.         # Post-release</font>
<font color="red"> 251.         if self._version.post is not None:</font>
<font color="red"> 252.             parts.append(&quot;.post{0}&quot;.format(self._version.post[1]))</font>
<font color="black"> 253. </font>
<font color="black"> 254.         # Development release</font>
<font color="red"> 255.         if self._version.dev is not None:</font>
<font color="red"> 256.             parts.append(&quot;.dev{0}&quot;.format(self._version.dev[1]))</font>
<font color="black"> 257. </font>
<font color="black"> 258.         # Local version segment</font>
<font color="red"> 259.         if self._version.local is not None:</font>
<font color="red"> 260.             parts.append(</font>
<font color="red"> 261.                 &quot;+{0}&quot;.format(&quot;.&quot;.join(str(x) for x in self._version.local))</font>
<font color="black"> 262.             )</font>
<font color="black"> 263. </font>
<font color="red"> 264.         return &quot;&quot;.join(parts)</font>
<font color="black"> 265. </font>
<font color="green"> 266.     @property</font>
<font color="black"> 267.     def public(self):</font>
<font color="red"> 268.         return str(self).split(&quot;+&quot;, 1)[0]</font>
<font color="black"> 269. </font>
<font color="green"> 270.     @property</font>
<font color="black"> 271.     def base_version(self):</font>
<font color="red"> 272.         parts = []</font>
<font color="black"> 273. </font>
<font color="black"> 274.         # Epoch</font>
<font color="red"> 275.         if self._version.epoch != 0:</font>
<font color="red"> 276.             parts.append(&quot;{0}!&quot;.format(self._version.epoch))</font>
<font color="black"> 277. </font>
<font color="black"> 278.         # Release segment</font>
<font color="red"> 279.         parts.append(&quot;.&quot;.join(str(x) for x in self._version.release))</font>
<font color="black"> 280. </font>
<font color="red"> 281.         return &quot;&quot;.join(parts)</font>
<font color="black"> 282. </font>
<font color="green"> 283.     @property</font>
<font color="black"> 284.     def local(self):</font>
<font color="red"> 285.         version_string = str(self)</font>
<font color="red"> 286.         if &quot;+&quot; in version_string:</font>
<font color="red"> 287.             return version_string.split(&quot;+&quot;, 1)[1]</font>
<font color="black"> 288. </font>
<font color="green"> 289.     @property</font>
<font color="black"> 290.     def is_prerelease(self):</font>
<font color="red"> 291.         return bool(self._version.dev or self._version.pre)</font>
<font color="black"> 292. </font>
<font color="green"> 293.     @property</font>
<font color="black"> 294.     def is_postrelease(self):</font>
<font color="red"> 295.         return bool(self._version.post)</font>
<font color="black"> 296. </font>
<font color="black"> 297. </font>
<font color="green"> 298. def _parse_letter_version(letter, number):</font>
<font color="red"> 299.     if letter:</font>
<font color="black"> 300.         # We consider there to be an implicit 0 in a pre-release if there is</font>
<font color="black"> 301.         # not a numeral associated with it.</font>
<font color="red"> 302.         if number is None:</font>
<font color="red"> 303.             number = 0</font>
<font color="black"> 304. </font>
<font color="black"> 305.         # We normalize any letters to their lower case form</font>
<font color="red"> 306.         letter = letter.lower()</font>
<font color="black"> 307. </font>
<font color="black"> 308.         # We consider some words to be alternate spellings of other words and</font>
<font color="black"> 309.         # in those cases we want to normalize the spellings to our preferred</font>
<font color="black"> 310.         # spelling.</font>
<font color="red"> 311.         if letter == &quot;alpha&quot;:</font>
<font color="red"> 312.             letter = &quot;a&quot;</font>
<font color="red"> 313.         elif letter == &quot;beta&quot;:</font>
<font color="red"> 314.             letter = &quot;b&quot;</font>
<font color="red"> 315.         elif letter in [&quot;c&quot;, &quot;pre&quot;, &quot;preview&quot;]:</font>
<font color="red"> 316.             letter = &quot;rc&quot;</font>
<font color="red"> 317.         elif letter in [&quot;rev&quot;, &quot;r&quot;]:</font>
<font color="red"> 318.             letter = &quot;post&quot;</font>
<font color="black"> 319. </font>
<font color="red"> 320.         return letter, int(number)</font>
<font color="red"> 321.     if not letter and number:</font>
<font color="black"> 322.         # We assume if we are given a number, but we are not given a letter</font>
<font color="black"> 323.         # then this is using the implicit post release syntax (e.g. 1.0-1)</font>
<font color="red"> 324.         letter = &quot;post&quot;</font>
<font color="black"> 325. </font>
<font color="red"> 326.         return letter, int(number)</font>
<font color="black"> 327. </font>
<font color="black"> 328. </font>
<font color="green"> 329. _local_version_seperators = re.compile(r&quot;[\._-]&quot;)</font>
<font color="black"> 330. </font>
<font color="black"> 331. </font>
<font color="green"> 332. def _parse_local_version(local):</font>
<font color="black"> 333.     &quot;&quot;&quot;</font>
<font color="black"> 334.     Takes a string like abc.1.twelve and turns it into (&quot;abc&quot;, 1, &quot;twelve&quot;).</font>
<font color="black"> 335.     &quot;&quot;&quot;</font>
<font color="red"> 336.     if local is not None:</font>
<font color="red"> 337.         return tuple(</font>
<font color="red"> 338.             part.lower() if not part.isdigit() else int(part)</font>
<font color="red"> 339.             for part in _local_version_seperators.split(local)</font>
<font color="black"> 340.         )</font>
<font color="black"> 341. </font>
<font color="black"> 342. </font>
<font color="green"> 343. def _cmpkey(epoch, release, pre, post, dev, local):</font>
<font color="black"> 344.     # When we compare a release version, we want to compare it with all of the</font>
<font color="black"> 345.     # trailing zeros removed. So we'll use a reverse the list, drop all the now</font>
<font color="black"> 346.     # leading zeros until we come to something non zero, then take the rest</font>
<font color="black"> 347.     # re-reverse it back into the correct order and make it a tuple and use</font>
<font color="black"> 348.     # that for our sorting key.</font>
<font color="red"> 349.     release = tuple(</font>
<font color="red"> 350.         reversed(list(</font>
<font color="red"> 351.             itertools.dropwhile(</font>
<font color="red"> 352.                 lambda x: x == 0,</font>
<font color="red"> 353.                 reversed(release),</font>
<font color="black"> 354.             )</font>
<font color="black"> 355.         ))</font>
<font color="black"> 356.     )</font>
<font color="black"> 357. </font>
<font color="black"> 358.     # We need to &quot;trick&quot; the sorting algorithm to put 1.0.dev0 before 1.0a0.</font>
<font color="black"> 359.     # We'll do this by abusing the pre segment, but we _only_ want to do this</font>
<font color="black"> 360.     # if there is not a pre or a post segment. If we have one of those then</font>
<font color="black"> 361.     # the normal sorting rules will handle this case correctly.</font>
<font color="red"> 362.     if pre is None and post is None and dev is not None:</font>
<font color="red"> 363.         pre = -Infinity</font>
<font color="black"> 364.     # Versions without a pre-release (except as noted above) should sort after</font>
<font color="black"> 365.     # those with one.</font>
<font color="red"> 366.     elif pre is None:</font>
<font color="red"> 367.         pre = Infinity</font>
<font color="black"> 368. </font>
<font color="black"> 369.     # Versions without a post segment should sort before those with one.</font>
<font color="red"> 370.     if post is None:</font>
<font color="red"> 371.         post = -Infinity</font>
<font color="black"> 372. </font>
<font color="black"> 373.     # Versions without a development segment should sort after those with one.</font>
<font color="red"> 374.     if dev is None:</font>
<font color="red"> 375.         dev = Infinity</font>
<font color="black"> 376. </font>
<font color="red"> 377.     if local is None:</font>
<font color="black"> 378.         # Versions without a local segment should sort before those with one.</font>
<font color="red"> 379.         local = -Infinity</font>
<font color="black"> 380.     else:</font>
<font color="black"> 381.         # Versions with a local segment need that segment parsed to implement</font>
<font color="black"> 382.         # the sorting rules in PEP440.</font>
<font color="black"> 383.         # - Alpha numeric segments sort before numeric segments</font>
<font color="black"> 384.         # - Alpha numeric segments sort lexicographically</font>
<font color="black"> 385.         # - Numeric segments sort numerically</font>
<font color="black"> 386.         # - Shorter versions sort before longer versions when the prefixes</font>
<font color="black"> 387.         #   match exactly</font>
<font color="red"> 388.         local = tuple(</font>
<font color="red"> 389.             (i, &quot;&quot;) if isinstance(i, int) else (-Infinity, i)</font>
<font color="red"> 390.             for i in local</font>
<font color="black"> 391.         )</font>
<font color="black"> 392. </font>
<font color="red"> 393.     return epoch, release, pre, post, dev, local</font>
</pre>

