source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/dateutil/relativedelta.py</b><br>


file stats: <b>368 lines, 44 executed: 12.0% covered</b>
<pre>
<font color="black">   1. # -*- coding: utf-8 -*-</font>
<font color="green">   2. import datetime</font>
<font color="green">   3. import calendar</font>
<font color="black">   4. </font>
<font color="green">   5. import operator</font>
<font color="green">   6. from math import copysign</font>
<font color="black">   7. </font>
<font color="green">   8. from six import integer_types</font>
<font color="green">   9. from warnings import warn</font>
<font color="black">  10. </font>
<font color="green">  11. __all__ = [&quot;relativedelta&quot;, &quot;MO&quot;, &quot;TU&quot;, &quot;WE&quot;, &quot;TH&quot;, &quot;FR&quot;, &quot;SA&quot;, &quot;SU&quot;]</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. class weekday(object):</font>
<font color="green">  15.     __slots__ = [&quot;weekday&quot;, &quot;n&quot;]</font>
<font color="black">  16. </font>
<font color="green">  17.     def __init__(self, weekday, n=None):</font>
<font color="green">  18.         self.weekday = weekday</font>
<font color="green">  19.         self.n = n</font>
<font color="black">  20. </font>
<font color="green">  21.     def __call__(self, n):</font>
<font color="red">  22.         if n == self.n:</font>
<font color="red">  23.             return self</font>
<font color="black">  24.         else:</font>
<font color="red">  25.             return self.__class__(self.weekday, n)</font>
<font color="black">  26. </font>
<font color="green">  27.     def __eq__(self, other):</font>
<font color="red">  28.         try:</font>
<font color="red">  29.             if self.weekday != other.weekday or self.n != other.n:</font>
<font color="red">  30.                 return False</font>
<font color="red">  31.         except AttributeError:</font>
<font color="red">  32.             return False</font>
<font color="red">  33.         return True</font>
<font color="black">  34. </font>
<font color="green">  35.     def __repr__(self):</font>
<font color="red">  36.         s = (&quot;MO&quot;, &quot;TU&quot;, &quot;WE&quot;, &quot;TH&quot;, &quot;FR&quot;, &quot;SA&quot;, &quot;SU&quot;)[self.weekday]</font>
<font color="red">  37.         if not self.n:</font>
<font color="red">  38.             return s</font>
<font color="black">  39.         else:</font>
<font color="red">  40.             return &quot;%s(%+d)&quot; % (s, self.n)</font>
<font color="black">  41. </font>
<font color="green">  42. MO, TU, WE, TH, FR, SA, SU = weekdays = tuple([weekday(x) for x in range(7)])</font>
<font color="black">  43. </font>
<font color="black">  44. </font>
<font color="green">  45. class relativedelta(object):</font>
<font color="black">  46.     &quot;&quot;&quot;</font>
<font color="black">  47.     The relativedelta type is based on the specification of the excellent</font>
<font color="black">  48.     work done by M.-A. Lemburg in his</font>
<font color="black">  49.     `mx.DateTime &lt;http://www.egenix.com/files/python/mxDateTime.html&gt;`_ extension.</font>
<font color="black">  50.     However, notice that this type does *NOT* implement the same algorithm as</font>
<font color="black">  51.     his work. Do *NOT* expect it to behave like mx.DateTime's counterpart.</font>
<font color="black">  52. </font>
<font color="black">  53.     There are two different ways to build a relativedelta instance. The</font>
<font color="black">  54.     first one is passing it two date/datetime classes::</font>
<font color="black">  55. </font>
<font color="black">  56.         relativedelta(datetime1, datetime2)</font>
<font color="black">  57. </font>
<font color="black">  58.     The second one is passing it any number of the following keyword arguments::</font>
<font color="black">  59. </font>
<font color="black">  60.         relativedelta(arg1=x,arg2=y,arg3=z...)</font>
<font color="black">  61. </font>
<font color="black">  62.         year, month, day, hour, minute, second, microsecond:</font>
<font color="black">  63.             Absolute information (argument is singular); adding or subtracting a</font>
<font color="black">  64.             relativedelta with absolute information does not perform an aritmetic</font>
<font color="black">  65.             operation, but rather REPLACES the corresponding value in the</font>
<font color="black">  66.             original datetime with the value(s) in relativedelta.</font>
<font color="black">  67. </font>
<font color="black">  68.         years, months, weeks, days, hours, minutes, seconds, microseconds:</font>
<font color="black">  69.             Relative information, may be negative (argument is plural); adding</font>
<font color="black">  70.             or subtracting a relativedelta with relative information performs</font>
<font color="black">  71.             the corresponding aritmetic operation on the original datetime value</font>
<font color="black">  72.             with the information in the relativedelta.</font>
<font color="black">  73. </font>
<font color="black">  74.         weekday:</font>
<font color="black">  75.             One of the weekday instances (MO, TU, etc). These instances may</font>
<font color="black">  76.             receive a parameter N, specifying the Nth weekday, which could</font>
<font color="black">  77.             be positive or negative (like MO(+1) or MO(-2). Not specifying</font>
<font color="black">  78.             it is the same as specifying +1. You can also use an integer,</font>
<font color="black">  79.             where 0=MO.</font>
<font color="black">  80. </font>
<font color="black">  81.         leapdays:</font>
<font color="black">  82.             Will add given days to the date found, if year is a leap</font>
<font color="black">  83.             year, and the date found is post 28 of february.</font>
<font color="black">  84. </font>
<font color="black">  85.         yearday, nlyearday:</font>
<font color="black">  86.             Set the yearday or the non-leap year day (jump leap days).</font>
<font color="black">  87.             These are converted to day/month/leapdays information.</font>
<font color="black">  88. </font>
<font color="black">  89.     Here is the behavior of operations with relativedelta:</font>
<font color="black">  90. </font>
<font color="black">  91.     1. Calculate the absolute year, using the 'year' argument, or the</font>
<font color="black">  92.        original datetime year, if the argument is not present.</font>
<font color="black">  93. </font>
<font color="black">  94.     2. Add the relative 'years' argument to the absolute year.</font>
<font color="black">  95. </font>
<font color="black">  96.     3. Do steps 1 and 2 for month/months.</font>
<font color="black">  97. </font>
<font color="black">  98.     4. Calculate the absolute day, using the 'day' argument, or the</font>
<font color="black">  99.        original datetime day, if the argument is not present. Then,</font>
<font color="black"> 100.        subtract from the day until it fits in the year and month</font>
<font color="black"> 101.        found after their operations.</font>
<font color="black"> 102. </font>
<font color="black"> 103.     5. Add the relative 'days' argument to the absolute day. Notice</font>
<font color="black"> 104.        that the 'weeks' argument is multiplied by 7 and added to</font>
<font color="black"> 105.        'days'.</font>
<font color="black"> 106. </font>
<font color="black"> 107.     6. Do steps 1 and 2 for hour/hours, minute/minutes, second/seconds,</font>
<font color="black"> 108.        microsecond/microseconds.</font>
<font color="black"> 109. </font>
<font color="black"> 110.     7. If the 'weekday' argument is present, calculate the weekday,</font>
<font color="black"> 111.        with the given (wday, nth) tuple. wday is the index of the</font>
<font color="black"> 112.        weekday (0-6, 0=Mon), and nth is the number of weeks to add</font>
<font color="black"> 113.        forward or backward, depending on its signal. Notice that if</font>
<font color="black"> 114.        the calculated date is already Monday, for example, using</font>
<font color="black"> 115.        (0, 1) or (0, -1) won't change the day.</font>
<font color="green"> 116.     &quot;&quot;&quot;</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def __init__(self, dt1=None, dt2=None,</font>
<font color="green"> 119.                  years=0, months=0, days=0, leapdays=0, weeks=0,</font>
<font color="green"> 120.                  hours=0, minutes=0, seconds=0, microseconds=0,</font>
<font color="green"> 121.                  year=None, month=None, day=None, weekday=None,</font>
<font color="green"> 122.                  yearday=None, nlyearday=None,</font>
<font color="green"> 123.                  hour=None, minute=None, second=None, microsecond=None):</font>
<font color="black"> 124. </font>
<font color="black"> 125.         # Check for non-integer values in integer-only quantities</font>
<font color="red"> 126.         if any(x is not None and x != int(x) for x in (years, months)):</font>
<font color="red"> 127.             raise ValueError(&quot;Non-integer years and months are &quot;</font>
<font color="black"> 128.                              &quot;ambiguous and not currently supported.&quot;)</font>
<font color="black"> 129. </font>
<font color="red"> 130.         if dt1 and dt2:</font>
<font color="black"> 131.             # datetime is a subclass of date. So both must be date</font>
<font color="red"> 132.             if not (isinstance(dt1, datetime.date) and</font>
<font color="red"> 133.                     isinstance(dt2, datetime.date)):</font>
<font color="red"> 134.                 raise TypeError(&quot;relativedelta only diffs datetime/date&quot;)</font>
<font color="black"> 135. </font>
<font color="black"> 136.             # We allow two dates, or two datetimes, so we coerce them to be</font>
<font color="black"> 137.             # of the same type</font>
<font color="red"> 138.             if (isinstance(dt1, datetime.datetime) !=</font>
<font color="red"> 139.                     isinstance(dt2, datetime.datetime)):</font>
<font color="red"> 140.                 if not isinstance(dt1, datetime.datetime):</font>
<font color="red"> 141.                     dt1 = datetime.datetime.fromordinal(dt1.toordinal())</font>
<font color="red"> 142.                 elif not isinstance(dt2, datetime.datetime):</font>
<font color="red"> 143.                     dt2 = datetime.datetime.fromordinal(dt2.toordinal())</font>
<font color="black"> 144. </font>
<font color="red"> 145.             self.years = 0</font>
<font color="red"> 146.             self.months = 0</font>
<font color="red"> 147.             self.days = 0</font>
<font color="red"> 148.             self.leapdays = 0</font>
<font color="red"> 149.             self.hours = 0</font>
<font color="red"> 150.             self.minutes = 0</font>
<font color="red"> 151.             self.seconds = 0</font>
<font color="red"> 152.             self.microseconds = 0</font>
<font color="red"> 153.             self.year = None</font>
<font color="red"> 154.             self.month = None</font>
<font color="red"> 155.             self.day = None</font>
<font color="red"> 156.             self.weekday = None</font>
<font color="red"> 157.             self.hour = None</font>
<font color="red"> 158.             self.minute = None</font>
<font color="red"> 159.             self.second = None</font>
<font color="red"> 160.             self.microsecond = None</font>
<font color="red"> 161.             self._has_time = 0</font>
<font color="black"> 162. </font>
<font color="black"> 163.             # Get year / month delta between the two</font>
<font color="red"> 164.             months = (dt1.year - dt2.year) * 12 + (dt1.month - dt2.month)</font>
<font color="red"> 165.             self._set_months(months)</font>
<font color="black"> 166. </font>
<font color="black"> 167.             # Remove the year/month delta so the timedelta is just well-defined</font>
<font color="black"> 168.             # time units (seconds, days and microseconds)</font>
<font color="red"> 169.             dtm = self.__radd__(dt2)</font>
<font color="black"> 170. </font>
<font color="black"> 171.             # If we've overshot our target, make an adjustment</font>
<font color="red"> 172.             if dt1 &lt; dt2:</font>
<font color="red"> 173.                 compare = operator.gt</font>
<font color="red"> 174.                 increment = 1</font>
<font color="black"> 175.             else:</font>
<font color="red"> 176.                 compare = operator.lt</font>
<font color="red"> 177.                 increment = -1</font>
<font color="black"> 178. </font>
<font color="red"> 179.             while compare(dt1, dtm):</font>
<font color="red"> 180.                 months += increment</font>
<font color="red"> 181.                 self._set_months(months)</font>
<font color="red"> 182.                 dtm = self.__radd__(dt2)</font>
<font color="black"> 183. </font>
<font color="black"> 184.             # Get the timedelta between the &quot;months-adjusted&quot; date and dt1</font>
<font color="red"> 185.             delta = dt1 - dtm</font>
<font color="red"> 186.             self.seconds = delta.seconds + delta.days * 86400</font>
<font color="red"> 187.             self.microseconds = delta.microseconds</font>
<font color="black"> 188.         else:</font>
<font color="black"> 189.             # Relative information</font>
<font color="red"> 190.             self.years = years</font>
<font color="red"> 191.             self.months = months</font>
<font color="red"> 192.             self.days = days + weeks * 7</font>
<font color="red"> 193.             self.leapdays = leapdays</font>
<font color="red"> 194.             self.hours = hours</font>
<font color="red"> 195.             self.minutes = minutes</font>
<font color="red"> 196.             self.seconds = seconds</font>
<font color="red"> 197.             self.microseconds = microseconds</font>
<font color="black"> 198. </font>
<font color="black"> 199.             # Absolute information</font>
<font color="red"> 200.             self.year = year</font>
<font color="red"> 201.             self.month = month</font>
<font color="red"> 202.             self.day = day</font>
<font color="red"> 203.             self.hour = hour</font>
<font color="red"> 204.             self.minute = minute</font>
<font color="red"> 205.             self.second = second</font>
<font color="red"> 206.             self.microsecond = microsecond</font>
<font color="black"> 207. </font>
<font color="red"> 208.             if any(x is not None and int(x) != x</font>
<font color="red"> 209.                    for x in (year, month, day, hour,</font>
<font color="red"> 210.                              minute, second, microsecond)):</font>
<font color="black"> 211.                 # For now we'll deprecate floats - later it'll be an error.</font>
<font color="red"> 212.                 warn(&quot;Non-integer value passed as absolute information. &quot; +</font>
<font color="red"> 213.                      &quot;This is not a well-defined condition and will raise &quot; +</font>
<font color="red"> 214.                      &quot;errors in future versions.&quot;, DeprecationWarning)</font>
<font color="black"> 215. </font>
<font color="black"> 216. </font>
<font color="red"> 217.             if isinstance(weekday, integer_types):</font>
<font color="red"> 218.                 self.weekday = weekdays[weekday]</font>
<font color="black"> 219.             else:</font>
<font color="red"> 220.                 self.weekday = weekday</font>
<font color="black"> 221. </font>
<font color="red"> 222.             yday = 0</font>
<font color="red"> 223.             if nlyearday:</font>
<font color="red"> 224.                 yday = nlyearday</font>
<font color="red"> 225.             elif yearday:</font>
<font color="red"> 226.                 yday = yearday</font>
<font color="red"> 227.                 if yearday &gt; 59:</font>
<font color="red"> 228.                     self.leapdays = -1</font>
<font color="red"> 229.             if yday:</font>
<font color="red"> 230.                 ydayidx = [31, 59, 90, 120, 151, 181, 212,</font>
<font color="red"> 231.                            243, 273, 304, 334, 366]</font>
<font color="red"> 232.                 for idx, ydays in enumerate(ydayidx):</font>
<font color="red"> 233.                     if yday &lt;= ydays:</font>
<font color="red"> 234.                         self.month = idx+1</font>
<font color="red"> 235.                         if idx == 0:</font>
<font color="red"> 236.                             self.day = yday</font>
<font color="black"> 237.                         else:</font>
<font color="red"> 238.                             self.day = yday-ydayidx[idx-1]</font>
<font color="red"> 239.                         break</font>
<font color="black"> 240.                 else:</font>
<font color="red"> 241.                     raise ValueError(&quot;invalid year day (%d)&quot; % yday)</font>
<font color="black"> 242. </font>
<font color="red"> 243.         self._fix()</font>
<font color="black"> 244. </font>
<font color="green"> 245.     def _fix(self):</font>
<font color="red"> 246.         if abs(self.microseconds) &gt; 999999:</font>
<font color="red"> 247.             s = _sign(self.microseconds)</font>
<font color="red"> 248.             div, mod = divmod(self.microseconds * s, 1000000)</font>
<font color="red"> 249.             self.microseconds = mod * s</font>
<font color="red"> 250.             self.seconds += div * s</font>
<font color="red"> 251.         if abs(self.seconds) &gt; 59:</font>
<font color="red"> 252.             s = _sign(self.seconds)</font>
<font color="red"> 253.             div, mod = divmod(self.seconds * s, 60)</font>
<font color="red"> 254.             self.seconds = mod * s</font>
<font color="red"> 255.             self.minutes += div * s</font>
<font color="red"> 256.         if abs(self.minutes) &gt; 59:</font>
<font color="red"> 257.             s = _sign(self.minutes)</font>
<font color="red"> 258.             div, mod = divmod(self.minutes * s, 60)</font>
<font color="red"> 259.             self.minutes = mod * s</font>
<font color="red"> 260.             self.hours += div * s</font>
<font color="red"> 261.         if abs(self.hours) &gt; 23:</font>
<font color="red"> 262.             s = _sign(self.hours)</font>
<font color="red"> 263.             div, mod = divmod(self.hours * s, 24)</font>
<font color="red"> 264.             self.hours = mod * s</font>
<font color="red"> 265.             self.days += div * s</font>
<font color="red"> 266.         if abs(self.months) &gt; 11:</font>
<font color="red"> 267.             s = _sign(self.months)</font>
<font color="red"> 268.             div, mod = divmod(self.months * s, 12)</font>
<font color="red"> 269.             self.months = mod * s</font>
<font color="red"> 270.             self.years += div * s</font>
<font color="red"> 271.         if (self.hours or self.minutes or self.seconds or self.microseconds</font>
<font color="red"> 272.                 or self.hour is not None or self.minute is not None or</font>
<font color="red"> 273.                 self.second is not None or self.microsecond is not None):</font>
<font color="red"> 274.             self._has_time = 1</font>
<font color="black"> 275.         else:</font>
<font color="red"> 276.             self._has_time = 0</font>
<font color="black"> 277. </font>
<font color="green"> 278.     @property</font>
<font color="black"> 279.     def weeks(self):</font>
<font color="red"> 280.         return self.days // 7</font>
<font color="green"> 281.     @weeks.setter</font>
<font color="black"> 282.     def weeks(self, value):</font>
<font color="red"> 283.         self.days = self.days - (self.weeks * 7) + value * 7</font>
<font color="black"> 284. </font>
<font color="green"> 285.     def _set_months(self, months):</font>
<font color="red"> 286.         self.months = months</font>
<font color="red"> 287.         if abs(self.months) &gt; 11:</font>
<font color="red"> 288.             s = _sign(self.months)</font>
<font color="red"> 289.             div, mod = divmod(self.months * s, 12)</font>
<font color="red"> 290.             self.months = mod * s</font>
<font color="red"> 291.             self.years = div * s</font>
<font color="black"> 292.         else:</font>
<font color="red"> 293.             self.years = 0</font>
<font color="black"> 294. </font>
<font color="green"> 295.     def normalized(self):</font>
<font color="black"> 296.         &quot;&quot;&quot;</font>
<font color="black"> 297.         Return a version of this object represented entirely using integer</font>
<font color="black"> 298.         values for the relative attributes.</font>
<font color="black"> 299. </font>
<font color="black"> 300.         &gt;&gt;&gt; relativedelta(days=1.5, hours=2).normalized()</font>
<font color="black"> 301.         relativedelta(days=1, hours=14)</font>
<font color="black"> 302. </font>
<font color="black"> 303.         :return:</font>
<font color="black"> 304.             Returns a :class:`dateutil.relativedelta.relativedelta` object.</font>
<font color="black"> 305.         &quot;&quot;&quot;</font>
<font color="black"> 306.         # Cascade remainders down (rounding each to roughly nearest microsecond)</font>
<font color="red"> 307.         days = int(self.days)</font>
<font color="black"> 308. </font>
<font color="red"> 309.         hours_f = round(self.hours + 24 * (self.days - days), 11)</font>
<font color="red"> 310.         hours = int(hours_f)</font>
<font color="black"> 311. </font>
<font color="red"> 312.         minutes_f = round(self.minutes + 60 * (hours_f - hours), 10)</font>
<font color="red"> 313.         minutes = int(minutes_f)</font>
<font color="black"> 314. </font>
<font color="red"> 315.         seconds_f = round(self.seconds + 60 * (minutes_f - minutes), 8)</font>
<font color="red"> 316.         seconds = int(seconds_f)</font>
<font color="black"> 317. </font>
<font color="red"> 318.         microseconds = round(self.microseconds + 1e6 * (seconds_f - seconds))</font>
<font color="black"> 319. </font>
<font color="black"> 320.         # Constructor carries overflow back up with call to _fix()</font>
<font color="red"> 321.         return self.__class__(years=self.years, months=self.months,</font>
<font color="red"> 322.                               days=days, hours=hours, minutes=minutes,</font>
<font color="red"> 323.                               seconds=seconds, microseconds=microseconds,</font>
<font color="red"> 324.                               leapdays=self.leapdays, year=self.year,</font>
<font color="red"> 325.                               month=self.month, day=self.day,</font>
<font color="red"> 326.                               weekday=self.weekday, hour=self.hour,</font>
<font color="red"> 327.                               minute=self.minute, second=self.second,</font>
<font color="red"> 328.                               microsecond=self.microsecond)</font>
<font color="black"> 329. </font>
<font color="green"> 330.     def __add__(self, other):</font>
<font color="red"> 331.         if isinstance(other, relativedelta):</font>
<font color="red"> 332.             return self.__class__(years=other.years + self.years,</font>
<font color="red"> 333.                                  months=other.months + self.months,</font>
<font color="red"> 334.                                  days=other.days + self.days,</font>
<font color="red"> 335.                                  hours=other.hours + self.hours,</font>
<font color="red"> 336.                                  minutes=other.minutes + self.minutes,</font>
<font color="red"> 337.                                  seconds=other.seconds + self.seconds,</font>
<font color="red"> 338.                                  microseconds=(other.microseconds +</font>
<font color="red"> 339.                                                self.microseconds),</font>
<font color="red"> 340.                                  leapdays=other.leapdays or self.leapdays,</font>
<font color="red"> 341.                                  year=other.year or self.year,</font>
<font color="red"> 342.                                  month=other.month or self.month,</font>
<font color="red"> 343.                                  day=other.day or self.day,</font>
<font color="red"> 344.                                  weekday=other.weekday or self.weekday,</font>
<font color="red"> 345.                                  hour=other.hour or self.hour,</font>
<font color="red"> 346.                                  minute=other.minute or self.minute,</font>
<font color="red"> 347.                                  second=other.second or self.second,</font>
<font color="red"> 348.                                  microsecond=(other.microsecond or</font>
<font color="red"> 349.                                               self.microsecond))</font>
<font color="red"> 350.         if not isinstance(other, datetime.date):</font>
<font color="red"> 351.             raise TypeError(&quot;unsupported type for add operation&quot;)</font>
<font color="red"> 352.         elif self._has_time and not isinstance(other, datetime.datetime):</font>
<font color="red"> 353.             other = datetime.datetime.fromordinal(other.toordinal())</font>
<font color="red"> 354.         year = (self.year or other.year)+self.years</font>
<font color="red"> 355.         month = self.month or other.month</font>
<font color="red"> 356.         if self.months:</font>
<font color="red"> 357.             assert 1 &lt;= abs(self.months) &lt;= 12</font>
<font color="red"> 358.             month += self.months</font>
<font color="red"> 359.             if month &gt; 12:</font>
<font color="red"> 360.                 year += 1</font>
<font color="red"> 361.                 month -= 12</font>
<font color="red"> 362.             elif month &lt; 1:</font>
<font color="red"> 363.                 year -= 1</font>
<font color="red"> 364.                 month += 12</font>
<font color="red"> 365.         day = min(calendar.monthrange(year, month)[1],</font>
<font color="red"> 366.                   self.day or other.day)</font>
<font color="red"> 367.         repl = {&quot;year&quot;: year, &quot;month&quot;: month, &quot;day&quot;: day}</font>
<font color="red"> 368.         for attr in [&quot;hour&quot;, &quot;minute&quot;, &quot;second&quot;, &quot;microsecond&quot;]:</font>
<font color="red"> 369.             value = getattr(self, attr)</font>
<font color="red"> 370.             if value is not None:</font>
<font color="red"> 371.                 repl[attr] = value</font>
<font color="red"> 372.         days = self.days</font>
<font color="red"> 373.         if self.leapdays and month &gt; 2 and calendar.isleap(year):</font>
<font color="red"> 374.             days += self.leapdays</font>
<font color="red"> 375.         ret = (other.replace(**repl)</font>
<font color="red"> 376.                + datetime.timedelta(days=days,</font>
<font color="red"> 377.                                     hours=self.hours,</font>
<font color="red"> 378.                                     minutes=self.minutes,</font>
<font color="red"> 379.                                     seconds=self.seconds,</font>
<font color="red"> 380.                                     microseconds=self.microseconds))</font>
<font color="red"> 381.         if self.weekday:</font>
<font color="red"> 382.             weekday, nth = self.weekday.weekday, self.weekday.n or 1</font>
<font color="red"> 383.             jumpdays = (abs(nth) - 1) * 7</font>
<font color="red"> 384.             if nth &gt; 0:</font>
<font color="red"> 385.                 jumpdays += (7 - ret.weekday() + weekday) % 7</font>
<font color="black"> 386.             else:</font>
<font color="red"> 387.                 jumpdays += (ret.weekday() - weekday) % 7</font>
<font color="red"> 388.                 jumpdays *= -1</font>
<font color="red"> 389.             ret += datetime.timedelta(days=jumpdays)</font>
<font color="red"> 390.         return ret</font>
<font color="black"> 391. </font>
<font color="green"> 392.     def __radd__(self, other):</font>
<font color="red"> 393.         return self.__add__(other)</font>
<font color="black"> 394. </font>
<font color="green"> 395.     def __rsub__(self, other):</font>
<font color="red"> 396.         return self.__neg__().__radd__(other)</font>
<font color="black"> 397. </font>
<font color="green"> 398.     def __sub__(self, other):</font>
<font color="red"> 399.         if not isinstance(other, relativedelta):</font>
<font color="red"> 400.             raise TypeError(&quot;unsupported type for sub operation&quot;)</font>
<font color="red"> 401.         return self.__class__(years=self.years - other.years,</font>
<font color="red"> 402.                              months=self.months - other.months,</font>
<font color="red"> 403.                              days=self.days - other.days,</font>
<font color="red"> 404.                              hours=self.hours - other.hours,</font>
<font color="red"> 405.                              minutes=self.minutes - other.minutes,</font>
<font color="red"> 406.                              seconds=self.seconds - other.seconds,</font>
<font color="red"> 407.                              microseconds=self.microseconds - other.microseconds,</font>
<font color="red"> 408.                              leapdays=self.leapdays or other.leapdays,</font>
<font color="red"> 409.                              year=self.year or other.year,</font>
<font color="red"> 410.                              month=self.month or other.month,</font>
<font color="red"> 411.                              day=self.day or other.day,</font>
<font color="red"> 412.                              weekday=self.weekday or other.weekday,</font>
<font color="red"> 413.                              hour=self.hour or other.hour,</font>
<font color="red"> 414.                              minute=self.minute or other.minute,</font>
<font color="red"> 415.                              second=self.second or other.second,</font>
<font color="red"> 416.                              microsecond=self.microsecond or other.microsecond)</font>
<font color="black"> 417. </font>
<font color="green"> 418.     def __neg__(self):</font>
<font color="red"> 419.         return self.__class__(years=-self.years,</font>
<font color="red"> 420.                              months=-self.months,</font>
<font color="red"> 421.                              days=-self.days,</font>
<font color="red"> 422.                              hours=-self.hours,</font>
<font color="red"> 423.                              minutes=-self.minutes,</font>
<font color="red"> 424.                              seconds=-self.seconds,</font>
<font color="red"> 425.                              microseconds=-self.microseconds,</font>
<font color="red"> 426.                              leapdays=self.leapdays,</font>
<font color="red"> 427.                              year=self.year,</font>
<font color="red"> 428.                              month=self.month,</font>
<font color="red"> 429.                              day=self.day,</font>
<font color="red"> 430.                              weekday=self.weekday,</font>
<font color="red"> 431.                              hour=self.hour,</font>
<font color="red"> 432.                              minute=self.minute,</font>
<font color="red"> 433.                              second=self.second,</font>
<font color="red"> 434.                              microsecond=self.microsecond)</font>
<font color="black"> 435. </font>
<font color="green"> 436.     def __bool__(self):</font>
<font color="red"> 437.         return not (not self.years and</font>
<font color="red"> 438.                     not self.months and</font>
<font color="red"> 439.                     not self.days and</font>
<font color="red"> 440.                     not self.hours and</font>
<font color="red"> 441.                     not self.minutes and</font>
<font color="red"> 442.                     not self.seconds and</font>
<font color="red"> 443.                     not self.microseconds and</font>
<font color="red"> 444.                     not self.leapdays and</font>
<font color="red"> 445.                     self.year is None and</font>
<font color="red"> 446.                     self.month is None and</font>
<font color="red"> 447.                     self.day is None and</font>
<font color="red"> 448.                     self.weekday is None and</font>
<font color="red"> 449.                     self.hour is None and</font>
<font color="red"> 450.                     self.minute is None and</font>
<font color="red"> 451.                     self.second is None and</font>
<font color="red"> 452.                     self.microsecond is None)</font>
<font color="black"> 453.     # Compatibility with Python 2.x</font>
<font color="green"> 454.     __nonzero__ = __bool__</font>
<font color="black"> 455. </font>
<font color="green"> 456.     def __mul__(self, other):</font>
<font color="red"> 457.         f = float(other)</font>
<font color="red"> 458.         return self.__class__(years=int(self.years * f),</font>
<font color="red"> 459.                              months=int(self.months * f),</font>
<font color="red"> 460.                              days=int(self.days * f),</font>
<font color="red"> 461.                              hours=int(self.hours * f),</font>
<font color="red"> 462.                              minutes=int(self.minutes * f),</font>
<font color="red"> 463.                              seconds=int(self.seconds * f),</font>
<font color="red"> 464.                              microseconds=int(self.microseconds * f),</font>
<font color="red"> 465.                              leapdays=self.leapdays,</font>
<font color="red"> 466.                              year=self.year,</font>
<font color="red"> 467.                              month=self.month,</font>
<font color="red"> 468.                              day=self.day,</font>
<font color="red"> 469.                              weekday=self.weekday,</font>
<font color="red"> 470.                              hour=self.hour,</font>
<font color="red"> 471.                              minute=self.minute,</font>
<font color="red"> 472.                              second=self.second,</font>
<font color="red"> 473.                              microsecond=self.microsecond)</font>
<font color="black"> 474. </font>
<font color="green"> 475.     __rmul__ = __mul__</font>
<font color="black"> 476. </font>
<font color="green"> 477.     def __eq__(self, other):</font>
<font color="red"> 478.         if not isinstance(other, relativedelta):</font>
<font color="red"> 479.             return False</font>
<font color="red"> 480.         if self.weekday or other.weekday:</font>
<font color="red"> 481.             if not self.weekday or not other.weekday:</font>
<font color="red"> 482.                 return False</font>
<font color="red"> 483.             if self.weekday.weekday != other.weekday.weekday:</font>
<font color="red"> 484.                 return False</font>
<font color="red"> 485.             n1, n2 = self.weekday.n, other.weekday.n</font>
<font color="red"> 486.             if n1 != n2 and not ((not n1 or n1 == 1) and (not n2 or n2 == 1)):</font>
<font color="red"> 487.                 return False</font>
<font color="red"> 488.         return (self.years == other.years and</font>
<font color="red"> 489.                 self.months == other.months and</font>
<font color="red"> 490.                 self.days == other.days and</font>
<font color="red"> 491.                 self.hours == other.hours and</font>
<font color="red"> 492.                 self.minutes == other.minutes and</font>
<font color="red"> 493.                 self.seconds == other.seconds and</font>
<font color="red"> 494.                 self.microseconds == other.microseconds and</font>
<font color="red"> 495.                 self.leapdays == other.leapdays and</font>
<font color="red"> 496.                 self.year == other.year and</font>
<font color="red"> 497.                 self.month == other.month and</font>
<font color="red"> 498.                 self.day == other.day and</font>
<font color="red"> 499.                 self.hour == other.hour and</font>
<font color="red"> 500.                 self.minute == other.minute and</font>
<font color="red"> 501.                 self.second == other.second and</font>
<font color="red"> 502.                 self.microsecond == other.microsecond)</font>
<font color="black"> 503. </font>
<font color="green"> 504.     def __ne__(self, other):</font>
<font color="red"> 505.         return not self.__eq__(other)</font>
<font color="black"> 506. </font>
<font color="green"> 507.     def __div__(self, other):</font>
<font color="red"> 508.         return self.__mul__(1/float(other))</font>
<font color="black"> 509. </font>
<font color="green"> 510.     __truediv__ = __div__</font>
<font color="black"> 511. </font>
<font color="green"> 512.     def __repr__(self):</font>
<font color="red"> 513.         l = []</font>
<font color="red"> 514.         for attr in [&quot;years&quot;, &quot;months&quot;, &quot;days&quot;, &quot;leapdays&quot;,</font>
<font color="red"> 515.                      &quot;hours&quot;, &quot;minutes&quot;, &quot;seconds&quot;, &quot;microseconds&quot;]:</font>
<font color="red"> 516.             value = getattr(self, attr)</font>
<font color="red"> 517.             if value:</font>
<font color="red"> 518.                 l.append(&quot;{attr}={value:+g}&quot;.format(attr=attr, value=value))</font>
<font color="red"> 519.         for attr in [&quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;weekday&quot;,</font>
<font color="red"> 520.                      &quot;hour&quot;, &quot;minute&quot;, &quot;second&quot;, &quot;microsecond&quot;]:</font>
<font color="red"> 521.             value = getattr(self, attr)</font>
<font color="red"> 522.             if value is not None:</font>
<font color="red"> 523.                 l.append(&quot;{attr}={value}&quot;.format(attr=attr, value=repr(value)))</font>
<font color="red"> 524.         return &quot;{classname}({attrs})&quot;.format(classname=self.__class__.__name__,</font>
<font color="red"> 525.                                              attrs=&quot;, &quot;.join(l))</font>
<font color="black"> 526. </font>
<font color="green"> 527. def _sign(x):</font>
<font color="red"> 528.     return int(copysign(1, x))</font>
<font color="black"> 529. </font>
<font color="black"> 530. # vim:ts=4:sw=4:et</font>
</pre>

