source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/botocore/translate.py</b><br>


file stats: <b>22 lines, 18 executed: 81.8% covered</b>
<pre>
<font color="black">   1. # Copyright (c) 2012-2013 Mitch Garnaat http://garnaat.org/</font>
<font color="black">   2. # Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.</font>
<font color="black">   3. #</font>
<font color="black">   4. # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You</font>
<font color="black">   5. # may not use this file except in compliance with the License. A copy of</font>
<font color="black">   6. # the License is located at</font>
<font color="black">   7. #</font>
<font color="black">   8. # http://aws.amazon.com/apache2.0/</font>
<font color="black">   9. #</font>
<font color="black">  10. # or in the &quot;license&quot; file accompanying this file. This file is</font>
<font color="black">  11. # distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF</font>
<font color="black">  12. # ANY KIND, either express or implied. See the License for the specific</font>
<font color="black">  13. # language governing permissions and limitations under the License.</font>
<font color="green">  14. import copy</font>
<font color="black">  15. </font>
<font color="green">  16. from botocore.utils import merge_dicts</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="black">  19. def build_retry_config(endpoint_prefix, retry_model, definitions,</font>
<font color="green">  20.                        client_retry_config=None):</font>
<font color="green">  21.     service_config = retry_model.get(endpoint_prefix, {})</font>
<font color="green">  22.     resolve_references(service_config, definitions)</font>
<font color="black">  23.     # We want to merge the global defaults with the service specific</font>
<font color="black">  24.     # defaults, with the service specific defaults taking precedence.</font>
<font color="black">  25.     # So we use the global defaults as the base.</font>
<font color="black">  26.     #</font>
<font color="black">  27.     # A deepcopy is done on the retry defaults because it ensures the</font>
<font color="black">  28.     # retry model has no chance of getting mutated when the service specific</font>
<font color="black">  29.     # configuration or client retry config is merged in.</font>
<font color="green">  30.     final_retry_config = {</font>
<font color="green">  31.         '__default__': copy.deepcopy(retry_model.get('__default__', {}))</font>
<font color="black">  32.     }</font>
<font color="green">  33.     resolve_references(final_retry_config, definitions)</font>
<font color="black">  34.     # The merge the service specific config on top.</font>
<font color="green">  35.     merge_dicts(final_retry_config, service_config)</font>
<font color="green">  36.     if client_retry_config is not None:</font>
<font color="red">  37.         _merge_client_retry_config(final_retry_config, client_retry_config)</font>
<font color="green">  38.     return final_retry_config</font>
<font color="black">  39. </font>
<font color="black">  40. </font>
<font color="green">  41. def _merge_client_retry_config(retry_config, client_retry_config):</font>
<font color="red">  42.     max_retry_attempts_override = client_retry_config.get('max_attempts')</font>
<font color="red">  43.     if max_retry_attempts_override is not None:</font>
<font color="black">  44.         # In the retry config, the max_attempts refers to the maximum number</font>
<font color="black">  45.         # of requests in general will be made. However, for the client's</font>
<font color="black">  46.         # retry config it refers to how many retry attempts will be made at</font>
<font color="black">  47.         # most. So to translate this number from the client config, one is</font>
<font color="black">  48.         # added to convert it to the maximum number request that will be made</font>
<font color="black">  49.         # by including the initial request.</font>
<font color="black">  50.         #</font>
<font color="black">  51.         # It is also important to note that if we ever support per operation</font>
<font color="black">  52.         # configuration in the retry model via the client, we will need to</font>
<font color="black">  53.         # revisit this logic to make sure max_attempts gets applied</font>
<font color="black">  54.         # per operation.</font>
<font color="black">  55.         retry_config['__default__'][</font>
<font color="red">  56.             'max_attempts'] = max_retry_attempts_override + 1</font>
<font color="black">  57. </font>
<font color="black">  58. </font>
<font color="green">  59. def resolve_references(config, definitions):</font>
<font color="black">  60.     &quot;&quot;&quot;Recursively replace $ref keys.</font>
<font color="black">  61. </font>
<font color="black">  62.     To cut down on duplication, common definitions can be declared</font>
<font color="black">  63.     (and passed in via the ``definitions`` attribute) and then</font>
<font color="black">  64.     references as {&quot;$ref&quot;: &quot;name&quot;}, when this happens the reference</font>
<font color="black">  65.     dict is placed with the value from the ``definition`` dict.</font>
<font color="black">  66. </font>
<font color="black">  67.     This is recursively done.</font>
<font color="black">  68. </font>
<font color="black">  69.     &quot;&quot;&quot;</font>
<font color="green">  70.     for key, value in config.items():</font>
<font color="green">  71.         if isinstance(value, dict):</font>
<font color="green">  72.             if len(value) == 1 and list(value.keys())[0] == '$ref':</font>
<font color="black">  73.                 # Then we need to resolve this reference.</font>
<font color="green">  74.                 config[key] = definitions[list(value.values())[0]]</font>
<font color="black">  75.             else:</font>
<font color="green">  76.                 resolve_references(value, definitions)</font>
</pre>

