source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/ndg/httpsclient/ssl_peer_verification.py</b><br>


file stats: <b>129 lines, 46 executed: 35.7% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;ndg_httpsclient - module containing SSL peer verification class.</font>
<font color="green">   2. &quot;&quot;&quot;</font>
<font color="green">   3. __author__ = &quot;P J Kershaw (STFC)&quot;</font>
<font color="green">   4. __date__ = &quot;09/12/11&quot;</font>
<font color="green">   5. __copyright__ = &quot;(C) 2012 Science and Technology Facilities Council&quot;</font>
<font color="green">   6. __license__ = &quot;BSD - see LICENSE file in top-level directory&quot;</font>
<font color="green">   7. __contact__ = &quot;Philip.Kershaw@stfc.ac.uk&quot;</font>
<font color="green">   8. __revision__ = '$Id$'</font>
<font color="green">   9. import re</font>
<font color="green">  10. import logging</font>
<font color="green">  11. log = logging.getLogger(__name__)</font>
<font color="black">  12. </font>
<font color="green">  13. try:</font>
<font color="green">  14.     from ndg.httpsclient.subj_alt_name import SubjectAltName</font>
<font color="green">  15.     from pyasn1.codec.der import decoder as der_decoder</font>
<font color="green">  16.     SUBJ_ALT_NAME_SUPPORT = True</font>
<font color="black">  17. </font>
<font color="red">  18. except ImportError as e:</font>
<font color="red">  19.     SUBJ_ALT_NAME_SUPPORT = False</font>
<font color="black">  20.     SUBJ_ALT_NAME_SUPPORT_MSG = (</font>
<font color="red">  21.         'SubjectAltName support is disabled - check pyasn1 package '</font>
<font color="black">  22.         'installation to enable'</font>
<font color="black">  23.     )</font>
<font color="red">  24.     import warnings</font>
<font color="red">  25.     warnings.warn(SUBJ_ALT_NAME_SUPPORT_MSG)</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. class ServerSSLCertVerification(object):</font>
<font color="black">  29.     &quot;&quot;&quot;Check server identity.  If hostname doesn't match, allow match of</font>
<font color="green">  30.     host's Distinguished Name against server DN setting&quot;&quot;&quot;</font>
<font color="green">  31.     DN_LUT = {</font>
<font color="green">  32.         'commonName':               'CN',</font>
<font color="green">  33.         'organisationalUnitName':   'OU',</font>
<font color="green">  34.         'organisation':             'O',</font>
<font color="green">  35.         'countryName':              'C',</font>
<font color="green">  36.         'emailAddress':             'EMAILADDRESS',</font>
<font color="green">  37.         'localityName':             'L',</font>
<font color="green">  38.         'stateOrProvinceName':      'ST',</font>
<font color="green">  39.         'streetAddress':            'STREET',</font>
<font color="green">  40.         'domainComponent':          'DC',</font>
<font color="green">  41.         'userid':                   'UID'</font>
<font color="black">  42.     }</font>
<font color="green">  43.     SUBJ_ALT_NAME_EXT_NAME = 'subjectAltName'</font>
<font color="green">  44.     PARSER_RE_STR = '/(%s)=' % '|'.join(list(DN_LUT.keys()) + \</font>
<font color="green">  45.                                         list(DN_LUT.values()))</font>
<font color="green">  46.     PARSER_RE = re.compile(PARSER_RE_STR)</font>
<font color="black">  47. </font>
<font color="green">  48.     __slots__ = ('__hostname', '__certDN', '__subj_alt_name_match')</font>
<font color="black">  49. </font>
<font color="green">  50.     def __init__(self, certDN=None, hostname=None, subj_alt_name_match=True):</font>
<font color="black">  51.         &quot;&quot;&quot;Override parent class __init__ to enable setting of certDN</font>
<font color="black">  52.         setting</font>
<font color="black">  53. </font>
<font color="black">  54.         @type certDN: string</font>
<font color="black">  55.         @param certDN: Set the expected Distinguished Name of the</font>
<font color="black">  56.         server to avoid errors matching hostnames.  This is useful</font>
<font color="black">  57.         where the hostname is not fully qualified</font>
<font color="black">  58.         @type hostname: string</font>
<font color="black">  59.         @param hostname: hostname to match against peer certificate</font>
<font color="black">  60.         subjectAltNames or subject common name</font>
<font color="black">  61.         @type subj_alt_name_match: bool</font>
<font color="black">  62.         @param subj_alt_name_match: flag to enable/disable matching of hostname</font>
<font color="black">  63.         against peer certificate subjectAltNames.  Nb. A setting of True will</font>
<font color="black">  64.         be ignored if the pyasn1 package is not installed</font>
<font color="black">  65.         &quot;&quot;&quot;</font>
<font color="red">  66.         self.__certDN = None</font>
<font color="red">  67.         self.__hostname = None</font>
<font color="black">  68. </font>
<font color="red">  69.         if certDN is not None:</font>
<font color="red">  70.             self.certDN = certDN</font>
<font color="black">  71. </font>
<font color="red">  72.         if hostname is not None:</font>
<font color="red">  73.             self.hostname = hostname</font>
<font color="black">  74. </font>
<font color="red">  75.         if subj_alt_name_match:</font>
<font color="red">  76.             if not SUBJ_ALT_NAME_SUPPORT:</font>
<font color="red">  77.                 log.warning('Overriding &quot;subj_alt_name_match&quot; keyword setting: '</font>
<font color="black">  78.                             'peer verification with subjectAltNames is disabled')</font>
<font color="red">  79.                 self.__subj_alt_name_match = False</font>
<font color="black">  80.             else:</font>
<font color="red">  81.                 self.__subj_alt_name_match = True</font>
<font color="black">  82.         else:</font>
<font color="red">  83.             log.debug('Disabling peer verification with subject '</font>
<font color="black">  84.                       'subjectAltNames!')</font>
<font color="red">  85.             self.__subj_alt_name_match = False</font>
<font color="black">  86. </font>
<font color="green">  87.     def __call__(self, connection, peerCert, errorStatus, errorDepth,</font>
<font color="black">  88.                  preverifyOK):</font>
<font color="black">  89.         &quot;&quot;&quot;Verify server certificate</font>
<font color="black">  90. </font>
<font color="black">  91.         @type connection: OpenSSL.SSL.Connection</font>
<font color="black">  92.         @param connection: SSL connection object</font>
<font color="black">  93.         @type peerCert: basestring</font>
<font color="black">  94.         @param peerCert: server host certificate as OpenSSL.crypto.X509</font>
<font color="black">  95.         instance</font>
<font color="black">  96.         @type errorStatus: int</font>
<font color="black">  97.         @param errorStatus: error status passed from caller.  This is the value</font>
<font color="black">  98.         returned by the OpenSSL C function X509_STORE_CTX_get_error().  Look-up</font>
<font color="black">  99.         x509_vfy.h in the OpenSSL source to get the meanings of the different</font>
<font color="black"> 100.         codes.  PyOpenSSL doesn't help you!</font>
<font color="black"> 101.         @type errorDepth: int</font>
<font color="black"> 102.         @param errorDepth: a non-negative integer representing where in the</font>
<font color="black"> 103.         certificate chain the error occurred. If it is zero it occured in the</font>
<font color="black"> 104.         end entity certificate, one if it is the certificate which signed the</font>
<font color="black"> 105.         end entity certificate and so on.</font>
<font color="black"> 106. </font>
<font color="black"> 107.         @type preverifyOK: int</font>
<font color="black"> 108.         @param preverifyOK: the error status - 0 = Error, 1 = OK of the current</font>
<font color="black"> 109.         SSL context irrespective of any verification checks done here.  If this</font>
<font color="black"> 110.         function yields an OK status, it should enforce the preverifyOK value</font>
<font color="black"> 111.         so that any error set upstream overrides and is honoured.</font>
<font color="black"> 112.         @rtype: int</font>
<font color="black"> 113.         @return: status code - 0/False = Error, 1/True = OK</font>
<font color="black"> 114.         &quot;&quot;&quot;</font>
<font color="red"> 115.         if peerCert.has_expired():</font>
<font color="black"> 116.             # Any expired certificate in the chain should result in an error</font>
<font color="red"> 117.             log.error('Certificate %r in peer certificate chain has expired',</font>
<font color="red"> 118.                       peerCert.get_subject())</font>
<font color="black"> 119. </font>
<font color="red"> 120.             return False</font>
<font color="black"> 121. </font>
<font color="red"> 122.         elif errorDepth == 0:</font>
<font color="black"> 123.             # Only interested in DN of last certificate in the chain - this must</font>
<font color="black"> 124.             # match the expected Server DN setting</font>
<font color="red"> 125.             peerCertSubj = peerCert.get_subject()</font>
<font color="red"> 126.             peerCertDN = peerCertSubj.get_components()</font>
<font color="red"> 127.             peerCertDN.sort()</font>
<font color="black"> 128. </font>
<font color="red"> 129.             if self.certDN is None:</font>
<font color="black"> 130.                 # Check hostname against peer certificate CN field instead:</font>
<font color="red"> 131.                 if self.hostname is None:</font>
<font color="red"> 132.                     log.error('No &quot;hostname&quot; or &quot;certDN&quot; set to check peer '</font>
<font color="black"> 133.                               'certificate against')</font>
<font color="red"> 134.                     return False</font>
<font color="black"> 135. </font>
<font color="black"> 136.                 # Check for subject alternative names</font>
<font color="red"> 137.                 if self.__subj_alt_name_match:</font>
<font color="red"> 138.                     dns_names = self._get_subj_alt_name(peerCert)</font>
<font color="red"> 139.                     if self.hostname in dns_names:</font>
<font color="red"> 140.                         return preverifyOK</font>
<font color="black"> 141. </font>
<font color="black"> 142.                 # If no subjectAltNames, default to check of subject Common Name</font>
<font color="red"> 143.                 if peerCertSubj.commonName == self.hostname:</font>
<font color="red"> 144.                     return preverifyOK</font>
<font color="black"> 145.                 else:</font>
<font color="red"> 146.                     log.error('Peer certificate CN %r doesn\'t match the '</font>
<font color="red"> 147.                               'expected CN %r', peerCertSubj.commonName,</font>
<font color="red"> 148.                               self.hostname)</font>
<font color="red"> 149.                     return False</font>
<font color="black"> 150.             else:</font>
<font color="red"> 151.                 if peerCertDN == self.certDN:</font>
<font color="red"> 152.                     return preverifyOK</font>
<font color="black"> 153.                 else:</font>
<font color="red"> 154.                     log.error('Peer certificate DN %r doesn\'t match the '</font>
<font color="red"> 155.                               'expected DN %r', peerCertDN, self.certDN)</font>
<font color="red"> 156.                     return False</font>
<font color="black"> 157.         else:</font>
<font color="red"> 158.             return preverifyOK</font>
<font color="black"> 159. </font>
<font color="green"> 160.     def get_verify_server_cert_func(self):</font>
<font color="red"> 161.         def verify_server_cert(connection, peerCert, errorStatus, errorDepth,</font>
<font color="black"> 162.                 preverifyOK):</font>
<font color="red"> 163.             return self.__call__(connection, peerCert, errorStatus,</font>
<font color="red"> 164.                                  errorDepth, preverifyOK)</font>
<font color="black"> 165. </font>
<font color="red"> 166.         return verify_server_cert</font>
<font color="black"> 167. </font>
<font color="green"> 168.     @classmethod</font>
<font color="black"> 169.     def _get_subj_alt_name(cls, peer_cert):</font>
<font color="black"> 170.         '''Extract subjectAltName DNS name settings from certificate extensions</font>
<font color="black"> 171. </font>
<font color="black"> 172.         @param peer_cert: peer certificate in SSL connection.  subjectAltName</font>
<font color="black"> 173.         settings if any will be extracted from this</font>
<font color="black"> 174.         @type peer_cert: OpenSSL.crypto.X509</font>
<font color="black"> 175.         '''</font>
<font color="black"> 176.         # Search through extensions</font>
<font color="red"> 177.         dns_name = []</font>
<font color="red"> 178.         general_names = SubjectAltName()</font>
<font color="red"> 179.         for i in range(peer_cert.get_extension_count()):</font>
<font color="red"> 180.             ext = peer_cert.get_extension(i)</font>
<font color="red"> 181.             ext_name = ext.get_short_name()</font>
<font color="red"> 182.             if ext_name == cls.SUBJ_ALT_NAME_EXT_NAME:</font>
<font color="black"> 183.                 # PyOpenSSL returns extension data in ASN.1 encoded form</font>
<font color="red"> 184.                 ext_dat = ext.get_data()</font>
<font color="red"> 185.                 decoded_dat = der_decoder.decode(ext_dat,</font>
<font color="red"> 186.                                                  asn1Spec=general_names)</font>
<font color="black"> 187. </font>
<font color="red"> 188.                 for name in decoded_dat:</font>
<font color="red"> 189.                     if isinstance(name, SubjectAltName):</font>
<font color="red"> 190.                         for entry in range(len(name)):</font>
<font color="red"> 191.                             component = name.getComponentByPosition(entry)</font>
<font color="red"> 192.                             dns_name.append(str(component.getComponent()))</font>
<font color="black"> 193. </font>
<font color="red"> 194.         return dns_name</font>
<font color="black"> 195. </font>
<font color="green"> 196.     def _getCertDN(self):</font>
<font color="red"> 197.         return self.__certDN</font>
<font color="black"> 198. </font>
<font color="green"> 199.     def _setCertDN(self, val):</font>
<font color="red"> 200.         if isinstance(val, str):</font>
<font color="black"> 201.             # Allow for quoted DN</font>
<font color="red"> 202.             certDN = val.strip('&quot;')</font>
<font color="black"> 203. </font>
<font color="red"> 204.             dnFields = self.__class__.PARSER_RE.split(certDN)</font>
<font color="red"> 205.             if len(dnFields) &lt; 2:</font>
<font color="red"> 206.                 raise TypeError('Error parsing DN string: &quot;%s&quot;' % certDN)</font>
<font color="black"> 207. </font>
<font color="red"> 208.             self.__certDN = list(zip(dnFields[1::2], dnFields[2::2]))</font>
<font color="red"> 209.             self.__certDN.sort()</font>
<font color="black"> 210. </font>
<font color="red"> 211.         elif not isinstance(val, list):</font>
<font color="red"> 212.             for i in val:</font>
<font color="red"> 213.                 if not len(i) == 2:</font>
<font color="red"> 214.                     raise TypeError('Expecting list of two element DN field, '</font>
<font color="black"> 215.                                     'DN field value pairs for &quot;certDN&quot; '</font>
<font color="black"> 216.                                     'attribute')</font>
<font color="red"> 217.             self.__certDN = val</font>
<font color="black"> 218.         else:</font>
<font color="red"> 219.             raise TypeError('Expecting list or string type for &quot;certDN&quot; '</font>
<font color="black"> 220.                             'attribute')</font>
<font color="black"> 221. </font>
<font color="green"> 222.     certDN = property(fget=_getCertDN,</font>
<font color="green"> 223.                       fset=_setCertDN,</font>
<font color="green"> 224.                       doc=&quot;Distinguished Name for Server Certificate&quot;)</font>
<font color="black"> 225. </font>
<font color="black"> 226.     # Get/Set Property methods</font>
<font color="green"> 227.     def _getHostname(self):</font>
<font color="red"> 228.         return self.__hostname</font>
<font color="black"> 229. </font>
<font color="green"> 230.     def _setHostname(self, val):</font>
<font color="red"> 231.         if not isinstance(val, str):</font>
<font color="red"> 232.             raise TypeError(&quot;Expecting string type for hostname &quot;</font>
<font color="black"> 233.                                  &quot;attribute&quot;)</font>
<font color="red"> 234.         self.__hostname = val</font>
<font color="black"> 235. </font>
<font color="green"> 236.     hostname = property(fget=_getHostname,</font>
<font color="green"> 237.                         fset=_setHostname,</font>
<font color="green"> 238.                         doc=&quot;hostname of server&quot;)</font>
</pre>

