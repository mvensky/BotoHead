source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/s3transfer/copies.py</b><br>


file stats: <b>167 lines, 54 executed: 32.3% covered</b>
<pre>
<font color="black">   1. # Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.</font>
<font color="black">   2. #</font>
<font color="black">   3. # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You</font>
<font color="black">   4. # may not use this file except in compliance with the License. A copy of</font>
<font color="black">   5. # the License is located at</font>
<font color="black">   6. #</font>
<font color="black">   7. # http://aws.amazon.com/apache2.0/</font>
<font color="black">   8. #</font>
<font color="black">   9. # or in the &quot;license&quot; file accompanying this file. This file is</font>
<font color="black">  10. # distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF</font>
<font color="black">  11. # ANY KIND, either express or implied. See the License for the specific</font>
<font color="black">  12. # language governing permissions and limitations under the License.</font>
<font color="green">  13. import copy</font>
<font color="green">  14. import math</font>
<font color="black">  15. </font>
<font color="green">  16. from s3transfer.tasks import Task</font>
<font color="green">  17. from s3transfer.tasks import SubmissionTask</font>
<font color="green">  18. from s3transfer.tasks import CreateMultipartUploadTask</font>
<font color="green">  19. from s3transfer.tasks import CompleteMultipartUploadTask</font>
<font color="green">  20. from s3transfer.utils import get_callbacks</font>
<font color="green">  21. from s3transfer.utils import calculate_range_parameter</font>
<font color="green">  22. from s3transfer.utils import get_filtered_dict</font>
<font color="green">  23. from s3transfer.utils import ChunksizeAdjuster</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="green">  26. class CopySubmissionTask(SubmissionTask):</font>
<font color="green">  27.     &quot;&quot;&quot;Task for submitting tasks to execute a copy&quot;&quot;&quot;</font>
<font color="black">  28. </font>
<font color="green">  29.     EXTRA_ARGS_TO_HEAD_ARGS_MAPPING = {</font>
<font color="green">  30.         'CopySourceIfMatch': 'IfMatch',</font>
<font color="green">  31.         'CopySourceIfModifiedSince': 'IfModifiedSince',</font>
<font color="green">  32.         'CopySourceIfNoneMatch': 'IfNoneMatch',</font>
<font color="green">  33.         'CopySourceIfUnmodifiedSince': 'IfUnmodifiedSince',</font>
<font color="green">  34.         'CopySourceSSECustomerKey': 'SSECustomerKey',</font>
<font color="green">  35.         'CopySourceSSECustomerAlgorithm': 'SSECustomerAlgorithm',</font>
<font color="green">  36.         'CopySourceSSECustomerKeyMD5': 'SSECustomerKeyMD5',</font>
<font color="green">  37.         'RequestPayer': 'RequestPayer'</font>
<font color="black">  38.     }</font>
<font color="black">  39. </font>
<font color="black">  40.     UPLOAD_PART_COPY_ARGS = [</font>
<font color="green">  41.         'CopySourceIfMatch',</font>
<font color="green">  42.         'CopySourceIfModifiedSince',</font>
<font color="green">  43.         'CopySourceIfNoneMatch',</font>
<font color="green">  44.         'CopySourceIfUnmodifiedSince',</font>
<font color="green">  45.         'CopySourceSSECustomerKey',</font>
<font color="green">  46.         'CopySourceSSECustomerAlgorithm',</font>
<font color="green">  47.         'CopySourceSSECustomerKeyMD5',</font>
<font color="green">  48.         'SSECustomerKey',</font>
<font color="green">  49.         'SSECustomerAlgorithm',</font>
<font color="green">  50.         'SSECustomerKeyMD5',</font>
<font color="green">  51.         'RequestPayer',</font>
<font color="black">  52.     ]</font>
<font color="black">  53. </font>
<font color="black">  54.     CREATE_MULTIPART_ARGS_BLACKLIST = [</font>
<font color="green">  55.         'CopySourceIfMatch',</font>
<font color="green">  56.         'CopySourceIfModifiedSince',</font>
<font color="green">  57.         'CopySourceIfNoneMatch',</font>
<font color="green">  58.         'CopySourceIfUnmodifiedSince',</font>
<font color="green">  59.         'CopySourceSSECustomerKey',</font>
<font color="green">  60.         'CopySourceSSECustomerAlgorithm',</font>
<font color="green">  61.         'CopySourceSSECustomerKeyMD5',</font>
<font color="green">  62.         'MetadataDirective'</font>
<font color="black">  63.     ]</font>
<font color="black">  64. </font>
<font color="black">  65.     COMPLETE_MULTIPART_ARGS = [</font>
<font color="green">  66.         'RequestPayer'</font>
<font color="black">  67.     ]</font>
<font color="black">  68. </font>
<font color="green">  69.     def _submit(self, client, config, osutil, request_executor,</font>
<font color="black">  70.                 transfer_future):</font>
<font color="black">  71.         &quot;&quot;&quot;</font>
<font color="black">  72.         :param client: The client associated with the transfer manager</font>
<font color="black">  73. </font>
<font color="black">  74.         :type config: s3transfer.manager.TransferConfig</font>
<font color="black">  75.         :param config: The transfer config associated with the transfer</font>
<font color="black">  76.             manager</font>
<font color="black">  77. </font>
<font color="black">  78.         :type osutil: s3transfer.utils.OSUtil</font>
<font color="black">  79.         :param osutil: The os utility associated to the transfer manager</font>
<font color="black">  80. </font>
<font color="black">  81.         :type request_executor: s3transfer.futures.BoundedExecutor</font>
<font color="black">  82.         :param request_executor: The request executor associated with the</font>
<font color="black">  83.             transfer manager</font>
<font color="black">  84. </font>
<font color="black">  85.         :type transfer_future: s3transfer.futures.TransferFuture</font>
<font color="black">  86.         :param transfer_future: The transfer future associated with the</font>
<font color="black">  87.             transfer request that tasks are being submitted for</font>
<font color="black">  88.         &quot;&quot;&quot;</font>
<font color="black">  89.         # Determine the size if it was not provided</font>
<font color="red">  90.         if transfer_future.meta.size is None:</font>
<font color="black">  91.             # If a size was not provided figure out the size for the</font>
<font color="black">  92.             # user. Note that we will only use the client provided to</font>
<font color="black">  93.             # the TransferManager. If the object is outside of the region</font>
<font color="black">  94.             # of the client, they may have to provide the file size themselves</font>
<font color="black">  95.             # with a completely new client.</font>
<font color="red">  96.             call_args = transfer_future.meta.call_args</font>
<font color="black">  97.             head_object_request = \</font>
<font color="red">  98.                 self._get_head_object_request_from_copy_source(</font>
<font color="red">  99.                     call_args.copy_source)</font>
<font color="red"> 100.             extra_args = call_args.extra_args</font>
<font color="black"> 101. </font>
<font color="black"> 102.             # Map any values that may be used in the head object that is</font>
<font color="black"> 103.             # used in the copy object</font>
<font color="red"> 104.             for param, value in extra_args.items():</font>
<font color="red"> 105.                 if param in self.EXTRA_ARGS_TO_HEAD_ARGS_MAPPING:</font>
<font color="black"> 106.                     head_object_request[</font>
<font color="red"> 107.                         self.EXTRA_ARGS_TO_HEAD_ARGS_MAPPING[param]] = value</font>
<font color="black"> 108. </font>
<font color="red"> 109.             response = call_args.source_client.head_object(</font>
<font color="red"> 110.                 **head_object_request)</font>
<font color="red"> 111.             transfer_future.meta.provide_transfer_size(</font>
<font color="red"> 112.                 response['ContentLength'])</font>
<font color="black"> 113. </font>
<font color="black"> 114.         # If it is greater than threshold do a multipart copy, otherwise</font>
<font color="black"> 115.         # do a regular copy object.</font>
<font color="red"> 116.         if transfer_future.meta.size &lt; config.multipart_threshold:</font>
<font color="red"> 117.             self._submit_copy_request(</font>
<font color="red"> 118.                 client, config, osutil, request_executor, transfer_future)</font>
<font color="black"> 119.         else:</font>
<font color="red"> 120.             self._submit_multipart_request(</font>
<font color="red"> 121.                 client, config, osutil, request_executor, transfer_future)</font>
<font color="black"> 122. </font>
<font color="green"> 123.     def _submit_copy_request(self, client, config, osutil, request_executor,</font>
<font color="black"> 124.                              transfer_future):</font>
<font color="red"> 125.         call_args = transfer_future.meta.call_args</font>
<font color="black"> 126. </font>
<font color="black"> 127.         # Get the needed progress callbacks for the task</font>
<font color="red"> 128.         progress_callbacks = get_callbacks(transfer_future, 'progress')</font>
<font color="black"> 129. </font>
<font color="black"> 130.         # Submit the request of a single copy.</font>
<font color="red"> 131.         self._transfer_coordinator.submit(</font>
<font color="red"> 132.             request_executor,</font>
<font color="red"> 133.             CopyObjectTask(</font>
<font color="red"> 134.                 transfer_coordinator=self._transfer_coordinator,</font>
<font color="red"> 135.                 main_kwargs={</font>
<font color="red"> 136.                     'client': client,</font>
<font color="red"> 137.                     'copy_source': call_args.copy_source,</font>
<font color="red"> 138.                     'bucket': call_args.bucket,</font>
<font color="red"> 139.                     'key': call_args.key,</font>
<font color="red"> 140.                     'extra_args': call_args.extra_args,</font>
<font color="red"> 141.                     'callbacks': progress_callbacks,</font>
<font color="red"> 142.                     'size': transfer_future.meta.size</font>
<font color="black"> 143.                 },</font>
<font color="red"> 144.                 is_final=True</font>
<font color="black"> 145.             )</font>
<font color="black"> 146.         )</font>
<font color="black"> 147. </font>
<font color="green"> 148.     def _submit_multipart_request(self, client, config, osutil,</font>
<font color="black"> 149.                                   request_executor, transfer_future):</font>
<font color="red"> 150.         call_args = transfer_future.meta.call_args</font>
<font color="black"> 151. </font>
<font color="black"> 152.         # Submit the request to create a multipart upload and make sure it</font>
<font color="black"> 153.         # does not include any of the arguments used for copy part.</font>
<font color="red"> 154.         create_multipart_extra_args = {}</font>
<font color="red"> 155.         for param, val in call_args.extra_args.items():</font>
<font color="red"> 156.             if param not in self.CREATE_MULTIPART_ARGS_BLACKLIST:</font>
<font color="red"> 157.                 create_multipart_extra_args[param] = val</font>
<font color="black"> 158. </font>
<font color="red"> 159.         create_multipart_future = self._transfer_coordinator.submit(</font>
<font color="red"> 160.             request_executor,</font>
<font color="red"> 161.             CreateMultipartUploadTask(</font>
<font color="red"> 162.                 transfer_coordinator=self._transfer_coordinator,</font>
<font color="red"> 163.                 main_kwargs={</font>
<font color="red"> 164.                     'client': client,</font>
<font color="red"> 165.                     'bucket': call_args.bucket,</font>
<font color="red"> 166.                     'key': call_args.key,</font>
<font color="red"> 167.                     'extra_args': create_multipart_extra_args,</font>
<font color="black"> 168.                 }</font>
<font color="black"> 169.             )</font>
<font color="black"> 170.         )</font>
<font color="black"> 171. </font>
<font color="black"> 172.         # Determine how many parts are needed based on filesize and</font>
<font color="black"> 173.         # desired chunksize.</font>
<font color="red"> 174.         part_size = config.multipart_chunksize</font>
<font color="red"> 175.         adjuster = ChunksizeAdjuster()</font>
<font color="red"> 176.         part_size = adjuster.adjust_chunksize(</font>
<font color="red"> 177.             part_size, transfer_future.meta.size)</font>
<font color="red"> 178.         num_parts = int(</font>
<font color="red"> 179.             math.ceil(transfer_future.meta.size / float(part_size)))</font>
<font color="black"> 180. </font>
<font color="black"> 181.         # Submit requests to upload the parts of the file.</font>
<font color="red"> 182.         part_futures = []</font>
<font color="red"> 183.         progress_callbacks = get_callbacks(transfer_future, 'progress')</font>
<font color="black"> 184. </font>
<font color="red"> 185.         for part_number in range(1, num_parts + 1):</font>
<font color="red"> 186.             extra_part_args = self._extra_upload_part_args(</font>
<font color="red"> 187.                 call_args.extra_args)</font>
<font color="black"> 188.             # The part number for upload part starts at 1 while the</font>
<font color="black"> 189.             # range parameter starts at zero, so just subtract 1 off of</font>
<font color="black"> 190.             # the part number</font>
<font color="red"> 191.             extra_part_args['CopySourceRange'] = calculate_range_parameter(</font>
<font color="red"> 192.                 part_size, part_number-1, num_parts, transfer_future.meta.size)</font>
<font color="black"> 193.             # Get the size of the part copy as well for the progress</font>
<font color="black"> 194.             # callbacks.</font>
<font color="red"> 195.             size = self._get_transfer_size(</font>
<font color="red"> 196.                 part_size, part_number-1, num_parts, transfer_future.meta.size</font>
<font color="black"> 197.             )</font>
<font color="red"> 198.             part_futures.append(</font>
<font color="red"> 199.                 self._transfer_coordinator.submit(</font>
<font color="red"> 200.                     request_executor,</font>
<font color="red"> 201.                     CopyPartTask(</font>
<font color="red"> 202.                         transfer_coordinator=self._transfer_coordinator,</font>
<font color="red"> 203.                         main_kwargs={</font>
<font color="red"> 204.                             'client': client,</font>
<font color="red"> 205.                             'copy_source': call_args.copy_source,</font>
<font color="red"> 206.                             'bucket': call_args.bucket,</font>
<font color="red"> 207.                             'key': call_args.key,</font>
<font color="red"> 208.                             'part_number': part_number,</font>
<font color="red"> 209.                             'extra_args': extra_part_args,</font>
<font color="red"> 210.                             'callbacks': progress_callbacks,</font>
<font color="red"> 211.                             'size': size</font>
<font color="black"> 212.                         },</font>
<font color="red"> 213.                         pending_main_kwargs={</font>
<font color="red"> 214.                             'upload_id': create_multipart_future</font>
<font color="black"> 215.                         }</font>
<font color="black"> 216.                     )</font>
<font color="black"> 217.                 )</font>
<font color="black"> 218.             )</font>
<font color="black"> 219. </font>
<font color="red"> 220.         complete_multipart_extra_args = self._extra_complete_multipart_args(</font>
<font color="red"> 221.             call_args.extra_args)</font>
<font color="black"> 222.         # Submit the request to complete the multipart upload.</font>
<font color="red"> 223.         self._transfer_coordinator.submit(</font>
<font color="red"> 224.             request_executor,</font>
<font color="red"> 225.             CompleteMultipartUploadTask(</font>
<font color="red"> 226.                 transfer_coordinator=self._transfer_coordinator,</font>
<font color="red"> 227.                 main_kwargs={</font>
<font color="red"> 228.                     'client': client,</font>
<font color="red"> 229.                     'bucket': call_args.bucket,</font>
<font color="red"> 230.                     'key': call_args.key,</font>
<font color="red"> 231.                     'extra_args': complete_multipart_extra_args,</font>
<font color="black"> 232.                 },</font>
<font color="red"> 233.                 pending_main_kwargs={</font>
<font color="red"> 234.                     'upload_id': create_multipart_future,</font>
<font color="red"> 235.                     'parts': part_futures</font>
<font color="black"> 236.                 },</font>
<font color="red"> 237.                 is_final=True</font>
<font color="black"> 238.             )</font>
<font color="black"> 239.         )</font>
<font color="black"> 240. </font>
<font color="green"> 241.     def _get_head_object_request_from_copy_source(self, copy_source):</font>
<font color="red"> 242.         if isinstance(copy_source, dict):</font>
<font color="red"> 243.             return copy.copy(copy_source)</font>
<font color="black"> 244.         else:</font>
<font color="red"> 245.             raise TypeError(</font>
<font color="red"> 246.                 'Expecting dictionary formatted: '</font>
<font color="black"> 247.                 '{&quot;Bucket&quot;: bucket_name, &quot;Key&quot;: key} '</font>
<font color="black"> 248.                 'but got %s or type %s.'</font>
<font color="red"> 249.                 % (copy_source, type(copy_source))</font>
<font color="black"> 250.             )</font>
<font color="black"> 251. </font>
<font color="green"> 252.     def _extra_upload_part_args(self, extra_args):</font>
<font color="black"> 253.         # Only the args in COPY_PART_ARGS actually need to be passed</font>
<font color="black"> 254.         # onto the upload_part_copy calls.</font>
<font color="red"> 255.         return get_filtered_dict(extra_args, self.UPLOAD_PART_COPY_ARGS)</font>
<font color="black"> 256. </font>
<font color="green"> 257.     def _extra_complete_multipart_args(self, extra_args):</font>
<font color="red"> 258.         return get_filtered_dict(extra_args, self.COMPLETE_MULTIPART_ARGS)</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def _get_transfer_size(self, part_size, part_index, num_parts,</font>
<font color="black"> 261.                            total_transfer_size):</font>
<font color="red"> 262.         if part_index == num_parts - 1:</font>
<font color="black"> 263.             # The last part may be different in size then the rest of the</font>
<font color="black"> 264.             # parts.</font>
<font color="red"> 265.             return total_transfer_size - (part_index * part_size)</font>
<font color="red"> 266.         return part_size</font>
<font color="black"> 267. </font>
<font color="black"> 268. </font>
<font color="green"> 269. class CopyObjectTask(Task):</font>
<font color="green"> 270.     &quot;&quot;&quot;Task to do a nonmultipart copy&quot;&quot;&quot;</font>
<font color="green"> 271.     def _main(self, client, copy_source, bucket, key, extra_args, callbacks,</font>
<font color="black"> 272.               size):</font>
<font color="black"> 273.         &quot;&quot;&quot;</font>
<font color="black"> 274.         :param client: The client to use when calling PutObject</font>
<font color="black"> 275.         :param copy_source: The CopySource parameter to use</font>
<font color="black"> 276.         :param bucket: The name of the bucket to copy to</font>
<font color="black"> 277.         :param key: The name of the key to copy to</font>
<font color="black"> 278.         :param extra_args: A dictionary of any extra arguments that may be</font>
<font color="black"> 279.             used in the upload.</font>
<font color="black"> 280.         :param callbacks: List of callbacks to call after copy</font>
<font color="black"> 281.         :param size: The size of the transfer. This value is passed into</font>
<font color="black"> 282.             the callbacks</font>
<font color="black"> 283. </font>
<font color="black"> 284.         &quot;&quot;&quot;</font>
<font color="red"> 285.         client.copy_object(</font>
<font color="red"> 286.             CopySource=copy_source, Bucket=bucket, Key=key, **extra_args)</font>
<font color="red"> 287.         for callback in callbacks:</font>
<font color="red"> 288.             callback(bytes_transferred=size)</font>
<font color="black"> 289. </font>
<font color="black"> 290. </font>
<font color="green"> 291. class CopyPartTask(Task):</font>
<font color="green"> 292.     &quot;&quot;&quot;Task to upload a part in a multipart copy&quot;&quot;&quot;</font>
<font color="green"> 293.     def _main(self, client, copy_source, bucket, key, upload_id, part_number,</font>
<font color="black"> 294.               extra_args, callbacks, size):</font>
<font color="black"> 295.         &quot;&quot;&quot;</font>
<font color="black"> 296.         :param client: The client to use when calling PutObject</font>
<font color="black"> 297.         :param copy_source: The CopySource parameter to use</font>
<font color="black"> 298.         :param bucket: The name of the bucket to upload to</font>
<font color="black"> 299.         :param key: The name of the key to upload to</font>
<font color="black"> 300.         :param upload_id: The id of the upload</font>
<font color="black"> 301.         :param part_number: The number representing the part of the multipart</font>
<font color="black"> 302.             upload</font>
<font color="black"> 303.         :param extra_args: A dictionary of any extra arguments that may be</font>
<font color="black"> 304.             used in the upload.</font>
<font color="black"> 305.         :param callbacks: List of callbacks to call after copy part</font>
<font color="black"> 306.         :param size: The size of the transfer. This value is passed into</font>
<font color="black"> 307.             the callbacks</font>
<font color="black"> 308. </font>
<font color="black"> 309.         :rtype: dict</font>
<font color="black"> 310.         :returns: A dictionary representing a part::</font>
<font color="black"> 311. </font>
<font color="black"> 312.             {'Etag': etag_value, 'PartNumber': part_number}</font>
<font color="black"> 313. </font>
<font color="black"> 314.             This value can be appended to a list to be used to complete</font>
<font color="black"> 315.             the multipart upload.</font>
<font color="black"> 316.         &quot;&quot;&quot;</font>
<font color="red"> 317.         response = client.upload_part_copy(</font>
<font color="red"> 318.             CopySource=copy_source, Bucket=bucket, Key=key,</font>
<font color="red"> 319.             UploadId=upload_id, PartNumber=part_number, **extra_args)</font>
<font color="red"> 320.         for callback in callbacks:</font>
<font color="red"> 321.             callback(bytes_transferred=size)</font>
<font color="red"> 322.         etag = response['CopyPartResult']['ETag']</font>
<font color="red"> 323.         return {'ETag': etag, 'PartNumber': part_number}</font>
</pre>

