source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/boto3/resources/action.py</b><br>


file stats: <b>90 lines, 23 executed: 25.6% covered</b>
<pre>
<font color="black">   1. # Copyright 2014 Amazon.com, Inc. or its affiliates. All Rights Reserved.</font>
<font color="black">   2. #</font>
<font color="black">   3. # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You</font>
<font color="black">   4. # may not use this file except in compliance with the License. A copy of</font>
<font color="black">   5. # the License is located at</font>
<font color="black">   6. #</font>
<font color="black">   7. # http://aws.amazon.com/apache2.0/</font>
<font color="black">   8. #</font>
<font color="black">   9. # or in the &quot;license&quot; file accompanying this file. This file is</font>
<font color="black">  10. # distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF</font>
<font color="black">  11. # ANY KIND, either express or implied. See the License for the specific</font>
<font color="black">  12. # language governing permissions and limitations under the License.</font>
<font color="black">  13. </font>
<font color="green">  14. import logging</font>
<font color="black">  15. </font>
<font color="green">  16. from botocore import xform_name</font>
<font color="black">  17. </font>
<font color="green">  18. from .params import create_request_parameters</font>
<font color="green">  19. from .response import RawHandler, ResourceHandler</font>
<font color="green">  20. from .model import Action</font>
<font color="black">  21. </font>
<font color="green">  22. from boto3.docs.docstring import ActionDocstring</font>
<font color="green">  23. from boto3.utils import inject_attribute</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="green">  26. logger = logging.getLogger(__name__)</font>
<font color="black">  27. </font>
<font color="black">  28. </font>
<font color="green">  29. class ServiceAction(object):</font>
<font color="black">  30.     &quot;&quot;&quot;</font>
<font color="black">  31.     A class representing a callable action on a resource, for example</font>
<font color="black">  32.     ``sqs.get_queue_by_name(...)`` or ``s3.Bucket('foo').delete()``.</font>
<font color="black">  33.     The action may construct parameters from existing resource identifiers</font>
<font color="black">  34.     and may return either a raw response or a new resource instance.</font>
<font color="black">  35. </font>
<font color="black">  36.     :type action_model: :py:class`~boto3.resources.model.Action`</font>
<font color="black">  37.     :param action_model: The action model.</font>
<font color="black">  38. </font>
<font color="black">  39.     :type factory: ResourceFactory</font>
<font color="black">  40.     :param factory: The factory that created the resource class to which</font>
<font color="black">  41.                     this action is attached.</font>
<font color="black">  42. </font>
<font color="black">  43.     :type service_context: :py:class:`~boto3.utils.ServiceContext`</font>
<font color="black">  44.     :param service_context: Context about the AWS service</font>
<font color="green">  45.     &quot;&quot;&quot;</font>
<font color="green">  46.     def __init__(self, action_model, factory=None, service_context=None):</font>
<font color="red">  47.         self._action_model = action_model</font>
<font color="black">  48. </font>
<font color="black">  49.         # In the simplest case we just return the response, but if a</font>
<font color="black">  50.         # resource is defined, then we must create these before returning.</font>
<font color="red">  51.         resource_response_model = action_model.resource</font>
<font color="red">  52.         if resource_response_model:</font>
<font color="red">  53.             self._response_handler = ResourceHandler(</font>
<font color="red">  54.                 search_path=resource_response_model.path,</font>
<font color="red">  55.                 factory=factory, resource_model=resource_response_model,</font>
<font color="red">  56.                 service_context=service_context,</font>
<font color="red">  57.                 operation_name=action_model.request.operation</font>
<font color="black">  58.             )</font>
<font color="black">  59.         else:</font>
<font color="red">  60.             self._response_handler = RawHandler(action_model.path)</font>
<font color="black">  61. </font>
<font color="green">  62.     def __call__(self, parent, *args, **kwargs):</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="black">  64.         Perform the action's request operation after building operation</font>
<font color="black">  65.         parameters and build any defined resources from the response.</font>
<font color="black">  66. </font>
<font color="black">  67.         :type parent: :py:class:`~boto3.resources.base.ServiceResource`</font>
<font color="black">  68.         :param parent: The resource instance to which this action is attached.</font>
<font color="black">  69.         :rtype: dict or ServiceResource or list(ServiceResource)</font>
<font color="black">  70.         :return: The response, either as a raw dict or resource instance(s).</font>
<font color="black">  71.         &quot;&quot;&quot;</font>
<font color="red">  72.         operation_name = xform_name(self._action_model.request.operation)</font>
<font color="black">  73. </font>
<font color="black">  74.         # First, build predefined params and then update with the</font>
<font color="black">  75.         # user-supplied kwargs, which allows overriding the pre-built</font>
<font color="black">  76.         # params if needed.</font>
<font color="red">  77.         params = create_request_parameters(parent, self._action_model.request)</font>
<font color="red">  78.         params.update(kwargs)</font>
<font color="black">  79. </font>
<font color="red">  80.         logger.debug('Calling %s:%s with %r', parent.meta.service_name,</font>
<font color="red">  81.                     operation_name, params)</font>
<font color="black">  82. </font>
<font color="red">  83.         response = getattr(parent.meta.client, operation_name)(**params)</font>
<font color="black">  84. </font>
<font color="red">  85.         logger.debug('Response: %r', response)</font>
<font color="black">  86. </font>
<font color="red">  87.         return self._response_handler(parent, params, response)</font>
<font color="black">  88. </font>
<font color="black">  89. </font>
<font color="green">  90. class BatchAction(ServiceAction):</font>
<font color="black">  91.     &quot;&quot;&quot;</font>
<font color="black">  92.     An action which operates on a batch of items in a collection, typically</font>
<font color="black">  93.     a single page of results from the collection's underlying service</font>
<font color="black">  94.     operation call. For example, this allows you to delete up to 999</font>
<font color="black">  95.     S3 objects in a single operation rather than calling ``.delete()`` on</font>
<font color="black">  96.     each one individually.</font>
<font color="black">  97. </font>
<font color="black">  98.     :type action_model: :py:class`~boto3.resources.model.Action`</font>
<font color="black">  99.     :param action_model: The action model.</font>
<font color="black"> 100. </font>
<font color="black"> 101.     :type factory: ResourceFactory</font>
<font color="black"> 102.     :param factory: The factory that created the resource class to which</font>
<font color="black"> 103.                     this action is attached.</font>
<font color="black"> 104. </font>
<font color="black"> 105.     :type service_context: :py:class:`~boto3.utils.ServiceContext`</font>
<font color="black"> 106.     :param service_context: Context about the AWS service</font>
<font color="green"> 107.     &quot;&quot;&quot;</font>
<font color="green"> 108.     def __call__(self, parent, *args, **kwargs):</font>
<font color="black"> 109.         &quot;&quot;&quot;</font>
<font color="black"> 110.         Perform the batch action's operation on every page of results</font>
<font color="black"> 111.         from the collection.</font>
<font color="black"> 112. </font>
<font color="black"> 113.         :type parent:</font>
<font color="black"> 114.             :py:class:`~boto3.resources.collection.ResourceCollection`</font>
<font color="black"> 115.         :param parent: The collection iterator to which this action</font>
<font color="black"> 116.                        is attached.</font>
<font color="black"> 117.         :rtype: list(dict)</font>
<font color="black"> 118.         :return: A list of low-level response dicts from each call.</font>
<font color="black"> 119.         &quot;&quot;&quot;</font>
<font color="red"> 120.         service_name = None</font>
<font color="red"> 121.         client = None</font>
<font color="red"> 122.         responses = []</font>
<font color="red"> 123.         operation_name = xform_name(self._action_model.request.operation)</font>
<font color="black"> 124. </font>
<font color="black"> 125.         # Unlike the simple action above, a batch action must operate</font>
<font color="black"> 126.         # on batches (or pages) of items. So we get each page, construct</font>
<font color="black"> 127.         # the necessary parameters and call the batch operation.</font>
<font color="red"> 128.         for page in parent.pages():</font>
<font color="red"> 129.             params = {}</font>
<font color="red"> 130.             for index, resource in enumerate(page):</font>
<font color="black"> 131.                 # There is no public interface to get a service name</font>
<font color="black"> 132.                 # or low-level client from a collection, so we get</font>
<font color="black"> 133.                 # these from the first resource in the collection.</font>
<font color="red"> 134.                 if service_name is None:</font>
<font color="red"> 135.                     service_name = resource.meta.service_name</font>
<font color="red"> 136.                 if client is None:</font>
<font color="red"> 137.                     client = resource.meta.client</font>
<font color="black"> 138. </font>
<font color="red"> 139.                 create_request_parameters(</font>
<font color="red"> 140.                     resource, self._action_model.request,</font>
<font color="red"> 141.                     params=params, index=index)</font>
<font color="black"> 142. </font>
<font color="red"> 143.             if not params:</font>
<font color="black"> 144.                 # There are no items, no need to make a call.</font>
<font color="red"> 145.                 break</font>
<font color="black"> 146. </font>
<font color="red"> 147.             params.update(kwargs)</font>
<font color="black"> 148. </font>
<font color="red"> 149.             logger.debug('Calling %s:%s with %r',</font>
<font color="red"> 150.                         service_name, operation_name, params)</font>
<font color="black"> 151. </font>
<font color="red"> 152.             response = getattr(client, operation_name)(**params)</font>
<font color="black"> 153. </font>
<font color="red"> 154.             logger.debug('Response: %r', response)</font>
<font color="black"> 155. </font>
<font color="red"> 156.             responses.append(</font>
<font color="red"> 157.                 self._response_handler(parent, params, response))</font>
<font color="black"> 158. </font>
<font color="red"> 159.         return responses</font>
<font color="black"> 160. </font>
<font color="black"> 161. </font>
<font color="green"> 162. class WaiterAction(object):</font>
<font color="black"> 163.     &quot;&quot;&quot;</font>
<font color="black"> 164.     A class representing a callable waiter action on a resource, for example</font>
<font color="black"> 165.     ``s3.Bucket('foo').wait_until_bucket_exists()``.</font>
<font color="black"> 166.     The waiter action may construct parameters from existing resource</font>
<font color="black"> 167.     identifiers.</font>
<font color="black"> 168. </font>
<font color="black"> 169.     :type waiter_model: :py:class`~boto3.resources.model.Waiter`</font>
<font color="black"> 170.     :param waiter_model: The action waiter.</font>
<font color="black"> 171.     :type waiter_resource_name: string</font>
<font color="black"> 172.     :param waiter_resource_name: The name of the waiter action for the</font>
<font color="black"> 173.                                  resource. It usually begins with a</font>
<font color="black"> 174.                                  ``wait_until_``</font>
<font color="green"> 175.     &quot;&quot;&quot;</font>
<font color="green"> 176.     def __init__(self, waiter_model, waiter_resource_name):</font>
<font color="red"> 177.         self._waiter_model = waiter_model</font>
<font color="red"> 178.         self._waiter_resource_name = waiter_resource_name</font>
<font color="black"> 179. </font>
<font color="green"> 180.     def __call__(self, parent, *args, **kwargs):</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="black"> 182.         Perform the wait operation after building operation</font>
<font color="black"> 183.         parameters.</font>
<font color="black"> 184. </font>
<font color="black"> 185.         :type parent: :py:class:`~boto3.resources.base.ServiceResource`</font>
<font color="black"> 186.         :param parent: The resource instance to which this action is attached.</font>
<font color="black"> 187.         &quot;&quot;&quot;</font>
<font color="red"> 188.         client_waiter_name = xform_name(self._waiter_model.waiter_name)</font>
<font color="black"> 189. </font>
<font color="black"> 190.         # First, build predefined params and then update with the</font>
<font color="black"> 191.         # user-supplied kwargs, which allows overriding the pre-built</font>
<font color="black"> 192.         # params if needed.</font>
<font color="red"> 193.         params = create_request_parameters(parent, self._waiter_model)</font>
<font color="red"> 194.         params.update(kwargs)</font>
<font color="black"> 195. </font>
<font color="red"> 196.         logger.debug('Calling %s:%s with %r',</font>
<font color="red"> 197.                     parent.meta.service_name,</font>
<font color="red"> 198.                     self._waiter_resource_name, params)</font>
<font color="black"> 199. </font>
<font color="red"> 200.         client = parent.meta.client</font>
<font color="red"> 201.         waiter = client.get_waiter(client_waiter_name)</font>
<font color="red"> 202.         response = waiter.wait(**params)</font>
<font color="black"> 203. </font>
<font color="red"> 204.         logger.debug('Response: %r', response)</font>
<font color="black"> 205. </font>
<font color="black"> 206. </font>
<font color="green"> 207. class CustomModeledAction(object):</font>
<font color="green"> 208.     &quot;&quot;&quot;A custom, modeled action to inject into a resource.&quot;&quot;&quot;</font>
<font color="green"> 209.     def __init__(self, action_name, action_model,</font>
<font color="black"> 210.                  function, event_emitter):</font>
<font color="black"> 211.         &quot;&quot;&quot;</font>
<font color="black"> 212.         :type action_name: str</font>
<font color="black"> 213.         :param action_name: The name of the action to inject, e.g.</font>
<font color="black"> 214.             'delete_tags'</font>
<font color="black"> 215. </font>
<font color="black"> 216.         :type action_model: dict</font>
<font color="black"> 217.         :param action_model: A JSON definition of the action, as if it were</font>
<font color="black"> 218.             part of the resource model.</font>
<font color="black"> 219. </font>
<font color="black"> 220.         :type function: function</font>
<font color="black"> 221.         :param function: The function to perform when the action is called.</font>
<font color="black"> 222.             The first argument should be 'self', which will be the resource</font>
<font color="black"> 223.             the function is to be called on.</font>
<font color="black"> 224. </font>
<font color="black"> 225.         :type event_emitter: :py:class:`botocore.hooks.BaseEventHooks`</font>
<font color="black"> 226.         :param event_emitter: The session event emitter.</font>
<font color="black"> 227.         &quot;&quot;&quot;</font>
<font color="red"> 228.         self.name = action_name</font>
<font color="red"> 229.         self.model = action_model</font>
<font color="red"> 230.         self.function = function</font>
<font color="red"> 231.         self.emitter = event_emitter</font>
<font color="black"> 232. </font>
<font color="green"> 233.     def inject(self, class_attributes, service_context, event_name, **kwargs):</font>
<font color="red"> 234.         resource_name = event_name.rsplit(&quot;.&quot;)[-1]</font>
<font color="red"> 235.         action = Action(self.name, self.model, {})</font>
<font color="red"> 236.         self.function.__name__ = self.name</font>
<font color="red"> 237.         self.function.__doc__ = ActionDocstring(</font>
<font color="red"> 238.             resource_name=resource_name,</font>
<font color="red"> 239.             event_emitter=self.emitter,</font>
<font color="red"> 240.             action_model=action,</font>
<font color="red"> 241.             service_model=service_context.service_model,</font>
<font color="red"> 242.             include_signature=False</font>
<font color="black"> 243.         )</font>
<font color="red"> 244.         inject_attribute(class_attributes, self.name, self.function)</font>
</pre>

