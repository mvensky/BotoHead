source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/botocore/vendored/requests/packages/urllib3/util/connection.py</b><br>


file stats: <b>56 lines, 32 executed: 57.1% covered</b>
<pre>
<font color="green">   1. import socket</font>
<font color="green">   2. try:</font>
<font color="green">   3.     from select import poll, POLLIN</font>
<font color="red">   4. except ImportError:  # `poll` doesn't exist on OSX and other platforms</font>
<font color="red">   5.     poll = False</font>
<font color="red">   6.     try:</font>
<font color="red">   7.         from select import select</font>
<font color="red">   8.     except ImportError:  # `select` doesn't exist on AppEngine.</font>
<font color="red">   9.         select = False</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. def is_connection_dropped(conn):  # Platform-specific</font>
<font color="black">  13.     &quot;&quot;&quot;</font>
<font color="black">  14.     Returns True if the connection is dropped and should be closed.</font>
<font color="black">  15. </font>
<font color="black">  16.     :param conn:</font>
<font color="black">  17.         :class:`httplib.HTTPConnection` object.</font>
<font color="black">  18. </font>
<font color="black">  19.     Note: For platforms like AppEngine, this will always return ``False`` to</font>
<font color="black">  20.     let the platform handle connection recycling transparently for us.</font>
<font color="black">  21.     &quot;&quot;&quot;</font>
<font color="green">  22.     sock = getattr(conn, 'sock', False)</font>
<font color="green">  23.     if sock is False:  # Platform-specific: AppEngine</font>
<font color="red">  24.         return False</font>
<font color="green">  25.     if sock is None:  # Connection already closed (such as by httplib).</font>
<font color="red">  26.         return True</font>
<font color="black">  27. </font>
<font color="green">  28.     if not poll:</font>
<font color="red">  29.         if not select:  # Platform-specific: AppEngine</font>
<font color="red">  30.             return False</font>
<font color="black">  31. </font>
<font color="red">  32.         try:</font>
<font color="red">  33.             return select([sock], [], [], 0.0)[0]</font>
<font color="red">  34.         except socket.error:</font>
<font color="red">  35.             return True</font>
<font color="black">  36. </font>
<font color="black">  37.     # This version is better on platforms that support it.</font>
<font color="green">  38.     p = poll()</font>
<font color="green">  39.     p.register(sock, POLLIN)</font>
<font color="green">  40.     for (fno, ev) in p.poll(0.0):</font>
<font color="green">  41.         if fno == sock.fileno():</font>
<font color="black">  42.             # Either data is buffered (bad), or the connection is dropped.</font>
<font color="green">  43.             return True</font>
<font color="black">  44. </font>
<font color="black">  45. </font>
<font color="black">  46. # This function is copied from socket.py in the Python 2.7 standard</font>
<font color="black">  47. # library test suite. Added to its signature is only `socket_options`.</font>
<font color="green">  48. def create_connection(address, timeout=socket._GLOBAL_DEFAULT_TIMEOUT,</font>
<font color="green">  49.                       source_address=None, socket_options=None):</font>
<font color="black">  50.     &quot;&quot;&quot;Connect to *address* and return the socket object.</font>
<font color="black">  51. </font>
<font color="black">  52.     Convenience function.  Connect to *address* (a 2-tuple ``(host,</font>
<font color="black">  53.     port)``) and return the socket object.  Passing the optional</font>
<font color="black">  54.     *timeout* parameter will set the timeout on the socket instance</font>
<font color="black">  55.     before attempting to connect.  If no *timeout* is supplied, the</font>
<font color="black">  56.     global default timeout setting returned by :func:`getdefaulttimeout`</font>
<font color="black">  57.     is used.  If *source_address* is set it must be a tuple of (host, port)</font>
<font color="black">  58.     for the socket to bind as a source address before making the connection.</font>
<font color="black">  59.     An host of '' or port 0 tells the OS to use the default.</font>
<font color="black">  60.     &quot;&quot;&quot;</font>
<font color="black">  61. </font>
<font color="green">  62.     host, port = address</font>
<font color="green">  63.     err = None</font>
<font color="green">  64.     for res in socket.getaddrinfo(host, port, 0, socket.SOCK_STREAM):</font>
<font color="green">  65.         af, socktype, proto, canonname, sa = res</font>
<font color="green">  66.         sock = None</font>
<font color="green">  67.         try:</font>
<font color="green">  68.             sock = socket.socket(af, socktype, proto)</font>
<font color="black">  69. </font>
<font color="black">  70.             # If provided, set socket level options before connecting.</font>
<font color="black">  71.             # This is the only addition urllib3 makes to this function.</font>
<font color="green">  72.             _set_socket_options(sock, socket_options)</font>
<font color="black">  73. </font>
<font color="green">  74.             if timeout is not socket._GLOBAL_DEFAULT_TIMEOUT:</font>
<font color="green">  75.                 sock.settimeout(timeout)</font>
<font color="green">  76.             if source_address:</font>
<font color="red">  77.                 sock.bind(source_address)</font>
<font color="green">  78.             sock.connect(sa)</font>
<font color="green">  79.             return sock</font>
<font color="black">  80. </font>
<font color="red">  81.         except socket.error as _:</font>
<font color="red">  82.             err = _</font>
<font color="red">  83.             if sock is not None:</font>
<font color="red">  84.                 sock.close()</font>
<font color="red">  85.                 sock = None</font>
<font color="black">  86. </font>
<font color="red">  87.     if err is not None:</font>
<font color="red">  88.         raise err</font>
<font color="black">  89.     else:</font>
<font color="red">  90.         raise socket.error(&quot;getaddrinfo returns an empty list&quot;)</font>
<font color="black">  91. </font>
<font color="black">  92. </font>
<font color="green">  93. def _set_socket_options(sock, options):</font>
<font color="green">  94.     if options is None:</font>
<font color="red">  95.         return</font>
<font color="black">  96. </font>
<font color="green">  97.     for opt in options:</font>
<font color="green">  98.         sock.setsockopt(*opt)</font>
</pre>

