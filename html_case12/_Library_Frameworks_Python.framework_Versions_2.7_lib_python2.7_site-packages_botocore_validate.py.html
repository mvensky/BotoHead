source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/botocore/validate.py</b><br>


file stats: <b>179 lines, 89 executed: 49.7% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;User input parameter validation.</font>
<font color="black">   2. </font>
<font color="black">   3. This module handles user input parameter validation</font>
<font color="black">   4. against a provided input model.</font>
<font color="black">   5. </font>
<font color="black">   6. Note that the objects in this module do *not* mutate any</font>
<font color="black">   7. arguments.  No type version happens here.  It is up to another</font>
<font color="black">   8. layer to properly convert arguments to any required types.</font>
<font color="black">   9. </font>
<font color="black">  10. Validation Errors</font>
<font color="black">  11. -----------------</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. &quot;&quot;&quot;</font>
<font color="black">  15. </font>
<font color="green">  16. from botocore.compat import six</font>
<font color="green">  17. import decimal</font>
<font color="green">  18. import json</font>
<font color="green">  19. from datetime import datetime</font>
<font color="black">  20. </font>
<font color="green">  21. from botocore.utils import parse_to_aware_datetime</font>
<font color="green">  22. from botocore.utils import is_json_value_header</font>
<font color="green">  23. from botocore.exceptions import ParamValidationError</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="green">  26. def validate_parameters(params, shape):</font>
<font color="black">  27.     &quot;&quot;&quot;Validates input parameters against a schema.</font>
<font color="black">  28. </font>
<font color="black">  29.     This is a convenience function that validates parameters against a schema.</font>
<font color="black">  30.     You can also instantiate and use the ParamValidator class directly if you</font>
<font color="black">  31.     want more control.</font>
<font color="black">  32. </font>
<font color="black">  33.     If there are any validation errors then a ParamValidationError</font>
<font color="black">  34.     will be raised.  If there are no validation errors than no exception</font>
<font color="black">  35.     is raised and a value of None is returned.</font>
<font color="black">  36. </font>
<font color="black">  37.     :param params: The user provided input parameters.</font>
<font color="black">  38. </font>
<font color="black">  39.     :type shape: botocore.model.Shape</font>
<font color="black">  40.     :param shape: The schema which the input parameters should</font>
<font color="black">  41.         adhere to.</font>
<font color="black">  42. </font>
<font color="black">  43.     :raise: ParamValidationError</font>
<font color="black">  44. </font>
<font color="black">  45.     &quot;&quot;&quot;</font>
<font color="red">  46.     validator = ParamValidator()</font>
<font color="red">  47.     report = validator.validate(params, shape)</font>
<font color="red">  48.     if report.has_errors():</font>
<font color="red">  49.         raise ParamValidationError(report=report.generate_report())</font>
<font color="black">  50. </font>
<font color="black">  51. </font>
<font color="green">  52. def type_check(valid_types):</font>
<font color="green">  53.     def _create_type_check_guard(func):</font>
<font color="green">  54.         def _on_passes_type_check(self, param, shape, errors, name):</font>
<font color="green">  55.             if _type_check(param, errors, name):</font>
<font color="green">  56.                 return func(self, param, shape, errors, name)</font>
<font color="black">  57. </font>
<font color="green">  58.         def _type_check(param, errors, name):</font>
<font color="green">  59.             if not isinstance(param, valid_types):</font>
<font color="red">  60.                 valid_type_names = [six.text_type(t) for t in valid_types]</font>
<font color="red">  61.                 errors.report(name, 'invalid type', param=param,</font>
<font color="red">  62.                               valid_types=valid_type_names)</font>
<font color="red">  63.                 return False</font>
<font color="green">  64.             return True</font>
<font color="black">  65. </font>
<font color="green">  66.         return _on_passes_type_check</font>
<font color="green">  67.     return _create_type_check_guard</font>
<font color="black">  68. </font>
<font color="black">  69. </font>
<font color="green">  70. def range_check(name, value, shape, error_type, errors):</font>
<font color="green">  71.     failed = False</font>
<font color="green">  72.     min_allowed = float('-inf')</font>
<font color="green">  73.     max_allowed = float('inf')</font>
<font color="green">  74.     if 'min' in shape.metadata:</font>
<font color="red">  75.         min_allowed = shape.metadata['min']</font>
<font color="red">  76.         if value &lt; min_allowed:</font>
<font color="red">  77.             failed = True</font>
<font color="green">  78.     if failed:</font>
<font color="red">  79.         errors.report(name, error_type, param=value,</font>
<font color="red">  80.                       valid_range=[min_allowed, max_allowed])</font>
<font color="black">  81. </font>
<font color="black">  82. </font>
<font color="green">  83. class ValidationErrors(object):</font>
<font color="green">  84.     def __init__(self):</font>
<font color="green">  85.         self._errors = []</font>
<font color="black">  86. </font>
<font color="green">  87.     def has_errors(self):</font>
<font color="green">  88.         if self._errors:</font>
<font color="red">  89.             return True</font>
<font color="green">  90.         return False</font>
<font color="black">  91. </font>
<font color="green">  92.     def generate_report(self):</font>
<font color="red">  93.         error_messages = []</font>
<font color="red">  94.         for error in self._errors:</font>
<font color="red">  95.             error_messages.append(self._format_error(error))</font>
<font color="red">  96.         return '\n'.join(error_messages)</font>
<font color="black">  97. </font>
<font color="green">  98.     def _format_error(self, error):</font>
<font color="red">  99.         error_type, name, additional = error</font>
<font color="red"> 100.         name = self._get_name(name)</font>
<font color="red"> 101.         if error_type == 'missing required field':</font>
<font color="red"> 102.             return 'Missing required parameter in %s: &quot;%s&quot;' % (</font>
<font color="red"> 103.                 name, additional['required_name'])</font>
<font color="red"> 104.         elif error_type == 'unknown field':</font>
<font color="red"> 105.             return 'Unknown parameter in %s: &quot;%s&quot;, must be one of: %s' % (</font>
<font color="red"> 106.                 name, additional['unknown_param'],</font>
<font color="red"> 107.                 ', '.join(additional['valid_names']))</font>
<font color="red"> 108.         elif error_type == 'invalid type':</font>
<font color="red"> 109.             return 'Invalid type for parameter %s, value: %s, type: %s, ' \</font>
<font color="red"> 110.                    'valid types: %s' % (name, additional['param'],</font>
<font color="red"> 111.                                         str(type(additional['param'])),</font>
<font color="red"> 112.                                         ', '.join(additional['valid_types']))</font>
<font color="red"> 113.         elif error_type == 'invalid range':</font>
<font color="red"> 114.             min_allowed = additional['valid_range'][0]</font>
<font color="red"> 115.             max_allowed = additional['valid_range'][1]</font>
<font color="red"> 116.             return ('Invalid range for parameter %s, value: %s, valid range: '</font>
<font color="red"> 117.                     '%s-%s' % (name, additional['param'],</font>
<font color="red"> 118.                                min_allowed, max_allowed))</font>
<font color="red"> 119.         elif error_type == 'invalid length':</font>
<font color="red"> 120.             min_allowed = additional['valid_range'][0]</font>
<font color="red"> 121.             max_allowed = additional['valid_range'][1]</font>
<font color="red"> 122.             return ('Invalid length for parameter %s, value: %s, valid range: '</font>
<font color="red"> 123.                     '%s-%s' % (name, additional['param'],</font>
<font color="red"> 124.                                min_allowed, max_allowed))</font>
<font color="red"> 125.         elif error_type == 'unable to encode to json':</font>
<font color="red"> 126.             return 'Invalid parameter %s must be json serializable: %s' \</font>
<font color="red"> 127.                 % (name, additional['type_error'])</font>
<font color="black"> 128. </font>
<font color="green"> 129.     def _get_name(self, name):</font>
<font color="red"> 130.         if not name:</font>
<font color="red"> 131.             return 'input'</font>
<font color="red"> 132.         elif name.startswith('.'):</font>
<font color="red"> 133.             return name[1:]</font>
<font color="black"> 134.         else:</font>
<font color="red"> 135.             return name</font>
<font color="black"> 136. </font>
<font color="green"> 137.     def report(self, name, reason, **kwargs):</font>
<font color="red"> 138.         self._errors.append((reason, name, kwargs))</font>
<font color="black"> 139. </font>
<font color="black"> 140. </font>
<font color="green"> 141. class ParamValidator(object):</font>
<font color="green"> 142.     &quot;&quot;&quot;Validates parameters against a shape model.&quot;&quot;&quot;</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def validate(self, params, shape):</font>
<font color="black"> 145.         &quot;&quot;&quot;Validate parameters against a shape model.</font>
<font color="black"> 146. </font>
<font color="black"> 147.         This method will validate the parameters against a provided shape model.</font>
<font color="black"> 148.         All errors will be collected before returning to the caller.  This means</font>
<font color="black"> 149.         that this method will not stop at the first error, it will return all</font>
<font color="black"> 150.         possible errors.</font>
<font color="black"> 151. </font>
<font color="black"> 152.         :param params: User provided dict of parameters</font>
<font color="black"> 153.         :param shape: A shape model describing the expected input.</font>
<font color="black"> 154. </font>
<font color="black"> 155.         :return: A list of errors.</font>
<font color="black"> 156. </font>
<font color="black"> 157.         &quot;&quot;&quot;</font>
<font color="green"> 158.         errors = ValidationErrors()</font>
<font color="green"> 159.         self._validate(params, shape, errors, name='')</font>
<font color="green"> 160.         return errors</font>
<font color="black"> 161. </font>
<font color="green"> 162.     def _check_special_validation_cases(self, shape):</font>
<font color="green"> 163.         if is_json_value_header(shape):</font>
<font color="red"> 164.             return self._validate_jsonvalue_string</font>
<font color="black"> 165. </font>
<font color="green"> 166.     def _validate(self, params, shape, errors, name):</font>
<font color="green"> 167.         special_validator = self._check_special_validation_cases(shape)</font>
<font color="green"> 168.         if special_validator:</font>
<font color="red"> 169.             special_validator(params, shape, errors, name)</font>
<font color="black"> 170.         else:</font>
<font color="green"> 171.             getattr(self, '_validate_%s' % shape.type_name)(</font>
<font color="green"> 172.                 params, shape, errors, name)</font>
<font color="black"> 173. </font>
<font color="green"> 174.     def _validate_jsonvalue_string(self, params, shape, errors, name):</font>
<font color="black"> 175.         # Check to see if a value marked as a jsonvalue can be dumped to</font>
<font color="black"> 176.         # a json string.</font>
<font color="red"> 177.         try:</font>
<font color="red"> 178.             json.dumps(params)</font>
<font color="red"> 179.         except (ValueError, TypeError) as e:</font>
<font color="red"> 180.             errors.report(name, 'unable to encode to json', type_error=e)</font>
<font color="black"> 181. </font>
<font color="green"> 182.     @type_check(valid_types=(dict,))</font>
<font color="black"> 183.     def _validate_structure(self, params, shape, errors, name):</font>
<font color="black"> 184.         # Validate required fields.</font>
<font color="green"> 185.         for required_member in shape.metadata.get('required', []):</font>
<font color="green"> 186.             if required_member not in params:</font>
<font color="red"> 187.                 errors.report(name, 'missing required field',</font>
<font color="red"> 188.                               required_name=required_member, user_params=params)</font>
<font color="green"> 189.         members = shape.members</font>
<font color="green"> 190.         known_params = []</font>
<font color="black"> 191.         # Validate known params.</font>
<font color="green"> 192.         for param in params:</font>
<font color="green"> 193.             if param not in members:</font>
<font color="red"> 194.                 errors.report(name, 'unknown field', unknown_param=param,</font>
<font color="red"> 195.                               valid_names=list(members))</font>
<font color="black"> 196.             else:</font>
<font color="green"> 197.                 known_params.append(param)</font>
<font color="black"> 198.         # Validate structure members.</font>
<font color="green"> 199.         for param in known_params:</font>
<font color="green"> 200.             self._validate(params[param], shape.members[param],</font>
<font color="green"> 201.                            errors, '%s.%s' % (name, param))</font>
<font color="black"> 202. </font>
<font color="green"> 203.     @type_check(valid_types=six.string_types)</font>
<font color="black"> 204.     def _validate_string(self, param, shape, errors, name):</font>
<font color="black"> 205.         # Validate range.  For a string, the min/max contraints</font>
<font color="black"> 206.         # are of the string length.</font>
<font color="black"> 207.         # Looks like:</font>
<font color="black"> 208.         # &quot;WorkflowId&quot;:{</font>
<font color="black"> 209.         #   &quot;type&quot;:&quot;string&quot;,</font>
<font color="black"> 210.         #   &quot;min&quot;:1,</font>
<font color="black"> 211.         #   &quot;max&quot;:256</font>
<font color="black"> 212.         #  }</font>
<font color="green"> 213.         range_check(name, len(param), shape, 'invalid length', errors)</font>
<font color="black"> 214. </font>
<font color="green"> 215.     @type_check(valid_types=(list, tuple))</font>
<font color="black"> 216.     def _validate_list(self, param, shape, errors, name):</font>
<font color="green"> 217.         member_shape = shape.member</font>
<font color="green"> 218.         range_check(name, len(param), shape, 'invalid length', errors)</font>
<font color="green"> 219.         for i, item in enumerate(param):</font>
<font color="green"> 220.             self._validate(item, member_shape, errors, '%s[%s]' % (name, i))</font>
<font color="black"> 221. </font>
<font color="green"> 222.     @type_check(valid_types=(dict,))</font>
<font color="black"> 223.     def _validate_map(self, param, shape, errors, name):</font>
<font color="red"> 224.         key_shape = shape.key</font>
<font color="red"> 225.         value_shape = shape.value</font>
<font color="red"> 226.         for key, value in param.items():</font>
<font color="red"> 227.             self._validate(key, key_shape, errors, &quot;%s (key: %s)&quot;</font>
<font color="red"> 228.                            % (name, key))</font>
<font color="red"> 229.             self._validate(value, value_shape, errors, '%s.%s' % (name, key))</font>
<font color="black"> 230. </font>
<font color="green"> 231.     @type_check(valid_types=six.integer_types)</font>
<font color="black"> 232.     def _validate_integer(self, param, shape, errors, name):</font>
<font color="green"> 233.         range_check(name, param, shape, 'invalid range', errors)</font>
<font color="black"> 234. </font>
<font color="green"> 235.     def _validate_blob(self, param, shape, errors, name):</font>
<font color="red"> 236.         if isinstance(param, (bytes, bytearray, six.text_type)):</font>
<font color="red"> 237.             return</font>
<font color="red"> 238.         elif hasattr(param, 'read'):</font>
<font color="black"> 239.             # File like objects are also allowed for blob types.</font>
<font color="red"> 240.             return</font>
<font color="black"> 241.         else:</font>
<font color="red"> 242.             errors.report(name, 'invalid type', param=param,</font>
<font color="red"> 243.                           valid_types=[str(bytes), str(bytearray),</font>
<font color="red"> 244.                                        'file-like object'])</font>
<font color="black"> 245. </font>
<font color="green"> 246.     @type_check(valid_types=(bool,))</font>
<font color="black"> 247.     def _validate_boolean(self, param, shape, errors, name):</font>
<font color="red"> 248.         pass</font>
<font color="black"> 249. </font>
<font color="green"> 250.     @type_check(valid_types=(float, decimal.Decimal) + six.integer_types)</font>
<font color="black"> 251.     def _validate_double(self, param, shape, errors, name):</font>
<font color="red"> 252.         range_check(name, param, shape, 'invalid range', errors)</font>
<font color="black"> 253. </font>
<font color="green"> 254.     _validate_float = _validate_double</font>
<font color="black"> 255. </font>
<font color="green"> 256.     @type_check(valid_types=six.integer_types)</font>
<font color="black"> 257.     def _validate_long(self, param, shape, errors, name):</font>
<font color="red"> 258.         range_check(name, param, shape, 'invalid range', errors)</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def _validate_timestamp(self, param, shape, errors, name):</font>
<font color="black"> 261.         # We don't use @type_check because datetimes are a bit</font>
<font color="black"> 262.         # more flexible.  You can either provide a datetime</font>
<font color="black"> 263.         # object, or a string that parses to a datetime.</font>
<font color="red"> 264.         is_valid_type = self._type_check_datetime(param)</font>
<font color="red"> 265.         if not is_valid_type:</font>
<font color="red"> 266.             valid_type_names = [six.text_type(datetime), 'timestamp-string']</font>
<font color="red"> 267.             errors.report(name, 'invalid type', param=param,</font>
<font color="red"> 268.                           valid_types=valid_type_names)</font>
<font color="black"> 269. </font>
<font color="green"> 270.     def _type_check_datetime(self, value):</font>
<font color="red"> 271.         try:</font>
<font color="red"> 272.             parse_to_aware_datetime(value)</font>
<font color="red"> 273.             return True</font>
<font color="red"> 274.         except (TypeError, ValueError, AttributeError):</font>
<font color="black"> 275.             # Yes, dateutil can sometimes raise an AttributeError</font>
<font color="black"> 276.             # when parsing timestamps.</font>
<font color="red"> 277.             return False</font>
<font color="black"> 278. </font>
<font color="black"> 279. </font>
<font color="green"> 280. class ParamValidationDecorator(object):</font>
<font color="green"> 281.     def __init__(self, param_validator, serializer):</font>
<font color="green"> 282.         self._param_validator = param_validator</font>
<font color="green"> 283.         self._serializer = serializer</font>
<font color="black"> 284. </font>
<font color="green"> 285.     def serialize_to_request(self, parameters, operation_model):</font>
<font color="green"> 286.         input_shape = operation_model.input_shape</font>
<font color="green"> 287.         if input_shape is not None:</font>
<font color="green"> 288.             report = self._param_validator.validate(parameters,</font>
<font color="green"> 289.                                                     operation_model.input_shape)</font>
<font color="green"> 290.             if report.has_errors():</font>
<font color="red"> 291.                 raise ParamValidationError(report=report.generate_report())</font>
<font color="green"> 292.         return self._serializer.serialize_to_request(parameters,</font>
<font color="green"> 293.                                                      operation_model)</font>
</pre>

