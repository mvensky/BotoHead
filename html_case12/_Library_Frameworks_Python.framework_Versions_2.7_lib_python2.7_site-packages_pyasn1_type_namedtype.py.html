source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/pyasn1/type/namedtype.py</b><br>


file stats: <b>168 lines, 62 executed: 36.9% covered</b>
<pre>
<font color="black">   1. #</font>
<font color="black">   2. # This file is part of pyasn1 software.</font>
<font color="black">   3. #</font>
<font color="black">   4. # Copyright (c) 2005-2017, Ilya Etingof &lt;etingof@gmail.com&gt;</font>
<font color="black">   5. # License: http://pyasn1.sf.net/license.html</font>
<font color="black">   6. #</font>
<font color="green">   7. import sys</font>
<font color="green">   8. from pyasn1.type import tagmap</font>
<font color="green">   9. from pyasn1.compat import octets</font>
<font color="green">  10. from pyasn1 import error</font>
<font color="black">  11. </font>
<font color="green">  12. __all__ = ['NamedType', 'OptionalNamedType', 'DefaultedNamedType', 'NamedTypes']</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class NamedType(object):</font>
<font color="black">  16.     &quot;&quot;&quot;Named type specification for constructed types</font>
<font color="green">  17.     &quot;&quot;&quot;</font>
<font color="green">  18.     isOptional = 0</font>
<font color="green">  19.     isDefaulted = 0</font>
<font color="black">  20. </font>
<font color="green">  21.     def __init__(self, name, t):</font>
<font color="green">  22.         self.__name = name</font>
<font color="green">  23.         self.__type = t</font>
<font color="black">  24. </font>
<font color="green">  25.     def __repr__(self):</font>
<font color="red">  26.         return '%s(%r, %r)' % (</font>
<font color="red">  27.             self.__class__.__name__, self.__name, self.__type</font>
<font color="black">  28.         )</font>
<font color="black">  29. </font>
<font color="green">  30.     def __eq__(self, other):</font>
<font color="red">  31.         return tuple(self) == tuple(other)</font>
<font color="black">  32. </font>
<font color="green">  33.     def __ne__(self, other):</font>
<font color="red">  34.         return tuple(self) != tuple(other)</font>
<font color="black">  35. </font>
<font color="green">  36.     def __lt__(self, other):</font>
<font color="red">  37.         return tuple(self) &lt; tuple(other)</font>
<font color="black">  38. </font>
<font color="green">  39.     def __le__(self, other):</font>
<font color="red">  40.         return tuple(self) &lt;= tuple(other)</font>
<font color="black">  41. </font>
<font color="green">  42.     def __gt__(self, other):</font>
<font color="red">  43.         return tuple(self) &gt; tuple(other)</font>
<font color="black">  44. </font>
<font color="green">  45.     def __ge__(self, other):</font>
<font color="red">  46.         return tuple(self) &gt;= tuple(other)</font>
<font color="black">  47. </font>
<font color="green">  48.     def __hash__(self):</font>
<font color="red">  49.         return hash(tuple(self))</font>
<font color="black">  50. </font>
<font color="green">  51.     def getType(self):</font>
<font color="red">  52.         return self.__type</font>
<font color="black">  53. </font>
<font color="green">  54.     def getName(self):</font>
<font color="red">  55.         return self.__name</font>
<font color="black">  56. </font>
<font color="green">  57.     def __getitem__(self, idx):</font>
<font color="red">  58.         if idx == 0:</font>
<font color="red">  59.             return self.__name</font>
<font color="red">  60.         if idx == 1:</font>
<font color="red">  61.             return self.__type</font>
<font color="red">  62.         raise IndexError()</font>
<font color="black">  63. </font>
<font color="black">  64. </font>
<font color="green">  65. class OptionalNamedType(NamedType):</font>
<font color="green">  66.     isOptional = 1</font>
<font color="black">  67. </font>
<font color="black">  68. </font>
<font color="green">  69. class DefaultedNamedType(NamedType):</font>
<font color="green">  70.     isDefaulted = 1</font>
<font color="black">  71. </font>
<font color="black">  72. </font>
<font color="green">  73. class NamedTypes(object):</font>
<font color="green">  74.     def __init__(self, *namedTypes):</font>
<font color="green">  75.         self.__namedTypes = namedTypes</font>
<font color="green">  76.         self.__namedTypesLen = len(self.__namedTypes)</font>
<font color="green">  77.         self.__minTagSet = None</font>
<font color="green">  78.         self.__tagToPosIdx = {}</font>
<font color="green">  79.         self.__nameToPosIdx = {}</font>
<font color="green">  80.         self.__tagMap = {False: None, True: None}</font>
<font color="green">  81.         self.__ambigiousTypes = {}</font>
<font color="black">  82. </font>
<font color="green">  83.     def __repr__(self):</font>
<font color="red">  84.         return '%s(%s)' % (</font>
<font color="red">  85.             self.__class__.__name__,</font>
<font color="red">  86.             ', '.join([repr(x) for x in self.__namedTypes])</font>
<font color="black">  87.         )</font>
<font color="black">  88. </font>
<font color="green">  89.     def __eq__(self, other):</font>
<font color="red">  90.         return tuple(self) == tuple(other)</font>
<font color="black">  91. </font>
<font color="green">  92.     def __ne__(self, other):</font>
<font color="red">  93.         return tuple(self) != tuple(other)</font>
<font color="black">  94. </font>
<font color="green">  95.     def __lt__(self, other):</font>
<font color="red">  96.         return tuple(self) &lt; tuple(other)</font>
<font color="black">  97. </font>
<font color="green">  98.     def __le__(self, other):</font>
<font color="red">  99.         return tuple(self) &lt;= tuple(other)</font>
<font color="black"> 100. </font>
<font color="green"> 101.     def __gt__(self, other):</font>
<font color="red"> 102.         return tuple(self) &gt; tuple(other)</font>
<font color="black"> 103. </font>
<font color="green"> 104.     def __ge__(self, other):</font>
<font color="red"> 105.         return tuple(self) &gt;= tuple(other)</font>
<font color="black"> 106. </font>
<font color="green"> 107.     def __hash__(self):</font>
<font color="red"> 108.         return hash(tuple(self))</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def __getitem__(self, idx):</font>
<font color="red"> 111.         if octets.isStringType(idx):</font>
<font color="red"> 112.             nameToPosIdx = self.__getNameToPosIdx()</font>
<font color="red"> 113.             return self.__namedTypes[nameToPosIdx[idx]]</font>
<font color="black"> 114.         else:</font>
<font color="red"> 115.             return self.__namedTypes[idx]</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def __contains__(self, key):</font>
<font color="red"> 118.         nameToPosIdx = self.__getNameToPosIdx()</font>
<font color="red"> 119.         return key in nameToPosIdx</font>
<font color="black"> 120. </font>
<font color="green"> 121.     def __iter__(self):</font>
<font color="red"> 122.         return (x[0] for x in self.__namedTypes)</font>
<font color="black"> 123. </font>
<font color="green"> 124.     if sys.version_info[0] &lt;= 2:</font>
<font color="green"> 125.         def __nonzero__(self):</font>
<font color="red"> 126.             return bool(self.__namedTypesLen)</font>
<font color="black"> 127.     else:</font>
<font color="red"> 128.         def __bool__(self):</font>
<font color="red"> 129.             return bool(self.__namedTypesLen)</font>
<font color="black"> 130. </font>
<font color="green"> 131.     def __len__(self):</font>
<font color="green"> 132.         return self.__namedTypesLen</font>
<font color="black"> 133. </font>
<font color="green"> 134.     def clone(self):</font>
<font color="red"> 135.         return self.__class__(*self.__namedTypes)</font>
<font color="black"> 136. </font>
<font color="green"> 137.     def getTypeByPosition(self, idx):</font>
<font color="red"> 138.         if idx &lt; 0 or idx &gt;= self.__namedTypesLen:</font>
<font color="red"> 139.             raise error.PyAsn1Error('Type position out of range')</font>
<font color="black"> 140.         else:</font>
<font color="red"> 141.             return self.__namedTypes[idx].getType()</font>
<font color="black"> 142. </font>
<font color="green"> 143.     def getPositionByType(self, tagSet):</font>
<font color="red"> 144.         if not self.__tagToPosIdx:</font>
<font color="red"> 145.             idx = self.__namedTypesLen</font>
<font color="red"> 146.             while idx &gt; 0:</font>
<font color="red"> 147.                 idx -= 1</font>
<font color="red"> 148.                 tagMap = self.__namedTypes[idx].getType().getTagMap() or tagmap.TagMap()</font>
<font color="red"> 149.                 for t in tagMap.getPosMap():</font>
<font color="red"> 150.                     if t in self.__tagToPosIdx:</font>
<font color="red"> 151.                         raise error.PyAsn1Error('Duplicate type %s' % (t,))</font>
<font color="red"> 152.                     self.__tagToPosIdx[t] = idx</font>
<font color="red"> 153.         try:</font>
<font color="red"> 154.             return self.__tagToPosIdx[tagSet]</font>
<font color="red"> 155.         except KeyError:</font>
<font color="red"> 156.             raise error.PyAsn1Error('Type %s not found' % (tagSet,))</font>
<font color="black"> 157. </font>
<font color="green"> 158.     def getNameByPosition(self, idx):</font>
<font color="red"> 159.         try:</font>
<font color="red"> 160.             return self.__namedTypes[idx].getName()</font>
<font color="red"> 161.         except IndexError:</font>
<font color="red"> 162.             raise error.PyAsn1Error('Type position out of range')</font>
<font color="black"> 163. </font>
<font color="green"> 164.     def __getNameToPosIdx(self):</font>
<font color="red"> 165.         if not self.__nameToPosIdx:</font>
<font color="red"> 166.             idx = self.__namedTypesLen</font>
<font color="red"> 167.             while idx &gt; 0:</font>
<font color="red"> 168.                 idx -= 1</font>
<font color="red"> 169.                 n = self.__namedTypes[idx].getName()</font>
<font color="red"> 170.                 if n in self.__nameToPosIdx:</font>
<font color="red"> 171.                     raise error.PyAsn1Error('Duplicate name %s' % (n,))</font>
<font color="red"> 172.                 self.__nameToPosIdx[n] = idx</font>
<font color="red"> 173.         return self.__nameToPosIdx</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def getPositionByName(self, name):</font>
<font color="red"> 176.         nameToPosIdx = self.__getNameToPosIdx()</font>
<font color="black"> 177. </font>
<font color="red"> 178.         try:</font>
<font color="red"> 179.             return nameToPosIdx[name]</font>
<font color="red"> 180.         except KeyError:</font>
<font color="red"> 181.             raise error.PyAsn1Error('Name %s not found' % (name,))</font>
<font color="black"> 182. </font>
<font color="green"> 183.     def __buildAmbigiousTagMap(self):</font>
<font color="red"> 184.         ambigiousTypes = ()</font>
<font color="red"> 185.         idx = self.__namedTypesLen</font>
<font color="red"> 186.         while idx &gt; 0:</font>
<font color="red"> 187.             idx -= 1</font>
<font color="red"> 188.             t = self.__namedTypes[idx]</font>
<font color="red"> 189.             if t.isOptional or t.isDefaulted:</font>
<font color="red"> 190.                 ambigiousTypes = (t,) + ambigiousTypes</font>
<font color="black"> 191.             else:</font>
<font color="red"> 192.                 ambigiousTypes = (t,)</font>
<font color="red"> 193.             self.__ambigiousTypes[idx] = NamedTypes(*ambigiousTypes)</font>
<font color="black"> 194. </font>
<font color="green"> 195.     def getTagMapNearPosition(self, idx):</font>
<font color="red"> 196.         if not self.__ambigiousTypes:</font>
<font color="red"> 197.             self.__buildAmbigiousTagMap()</font>
<font color="red"> 198.         try:</font>
<font color="red"> 199.             return self.__ambigiousTypes[idx].getTagMap()</font>
<font color="red"> 200.         except KeyError:</font>
<font color="red"> 201.             raise error.PyAsn1Error('Type position out of range')</font>
<font color="black"> 202. </font>
<font color="green"> 203.     def getPositionNearType(self, tagSet, idx):</font>
<font color="red"> 204.         if not self.__ambigiousTypes:</font>
<font color="red"> 205.             self.__buildAmbigiousTagMap()</font>
<font color="red"> 206.         try:</font>
<font color="red"> 207.             return idx + self.__ambigiousTypes[idx].getPositionByType(tagSet)</font>
<font color="red"> 208.         except KeyError:</font>
<font color="red"> 209.             raise error.PyAsn1Error('Type position out of range')</font>
<font color="black"> 210. </font>
<font color="green"> 211.     def genMinTagSet(self):</font>
<font color="red"> 212.         if self.__minTagSet is None:</font>
<font color="red"> 213.             for t in self.__namedTypes:</font>
<font color="red"> 214.                 __type = t.getType()</font>
<font color="red"> 215.                 tagSet = getattr(__type, 'getMinTagSet', __type.getTagSet)()</font>
<font color="red"> 216.                 if self.__minTagSet is None or tagSet &lt; self.__minTagSet:</font>
<font color="red"> 217.                     self.__minTagSet = tagSet</font>
<font color="red"> 218.         return self.__minTagSet</font>
<font color="black"> 219. </font>
<font color="green"> 220.     def getTagMap(self, uniq=False):</font>
<font color="red"> 221.         if self.__tagMap[uniq] is None:</font>
<font color="red"> 222.             tagMap = tagmap.TagMap()</font>
<font color="red"> 223.             for nt in self.__namedTypes:</font>
<font color="red"> 224.                 tagMap = tagMap.clone(</font>
<font color="red"> 225.                     nt.getType(), nt.getType().getTagMap() or tagmap.TagMap(), uniq</font>
<font color="black"> 226.                 )</font>
<font color="red"> 227.             self.__tagMap[uniq] = tagMap</font>
<font color="red"> 228.         return self.__tagMap[uniq]</font>
</pre>

