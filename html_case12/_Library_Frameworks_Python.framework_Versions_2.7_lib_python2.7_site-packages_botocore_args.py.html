source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/botocore/args.py</b><br>


file stats: <b>134 lines, 99 executed: 73.9% covered</b>
<pre>
<font color="black">   1. # Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.</font>
<font color="black">   2. #</font>
<font color="black">   3. # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You</font>
<font color="black">   4. # may not use this file except in compliance with the License. A copy of</font>
<font color="black">   5. # the License is located at</font>
<font color="black">   6. #</font>
<font color="black">   7. # http://aws.amazon.com/apache2.0/</font>
<font color="black">   8. #</font>
<font color="black">   9. # or in the &quot;license&quot; file accompanying this file. This file is</font>
<font color="black">  10. # distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF</font>
<font color="black">  11. # ANY KIND, either express or implied. See the License for the specific</font>
<font color="black">  12. # language governing permissions and limitations under the License.</font>
<font color="black">  13. &quot;&quot;&quot;Internal module to help with normalizing botocore client args.</font>
<font color="black">  14. </font>
<font color="black">  15. This module (and all function/classes within this module) should be</font>
<font color="black">  16. considered internal, and *not* a public API.</font>
<font color="black">  17. </font>
<font color="green">  18. &quot;&quot;&quot;</font>
<font color="green">  19. import copy</font>
<font color="green">  20. import logging</font>
<font color="black">  21. </font>
<font color="green">  22. import botocore.serialize</font>
<font color="green">  23. from botocore.signers import RequestSigner</font>
<font color="green">  24. from botocore.config import Config</font>
<font color="green">  25. from botocore.endpoint import EndpointCreator</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. logger = logging.getLogger(__name__)</font>
<font color="black">  29. </font>
<font color="black">  30. </font>
<font color="green">  31. class ClientArgsCreator(object):</font>
<font color="green">  32.     def __init__(self, event_emitter, user_agent, response_parser_factory,</font>
<font color="black">  33.                  loader, exceptions_factory):</font>
<font color="green">  34.         self._event_emitter = event_emitter</font>
<font color="green">  35.         self._user_agent = user_agent</font>
<font color="green">  36.         self._response_parser_factory = response_parser_factory</font>
<font color="green">  37.         self._loader = loader</font>
<font color="green">  38.         self._exceptions_factory = exceptions_factory</font>
<font color="black">  39. </font>
<font color="green">  40.     def get_client_args(self, service_model, region_name, is_secure,</font>
<font color="black">  41.                         endpoint_url, verify, credentials, scoped_config,</font>
<font color="black">  42.                         client_config, endpoint_bridge):</font>
<font color="green">  43.         final_args = self.compute_client_args(</font>
<font color="green">  44.             service_model, client_config, endpoint_bridge, region_name,</font>
<font color="green">  45.             endpoint_url, is_secure, scoped_config)</font>
<font color="black">  46. </font>
<font color="green">  47.         service_name = final_args['service_name']</font>
<font color="green">  48.         parameter_validation = final_args['parameter_validation']</font>
<font color="green">  49.         endpoint_config = final_args['endpoint_config']</font>
<font color="green">  50.         protocol = final_args['protocol']</font>
<font color="green">  51.         config_kwargs = final_args['config_kwargs']</font>
<font color="green">  52.         s3_config = final_args['s3_config']</font>
<font color="green">  53.         partition = endpoint_config['metadata'].get('partition', None)</font>
<font color="black">  54. </font>
<font color="green">  55.         signing_region = endpoint_config['signing_region']</font>
<font color="green">  56.         endpoint_region_name = endpoint_config['region_name']</font>
<font color="green">  57.         if signing_region is None and endpoint_region_name is None:</font>
<font color="black">  58.             signing_region, endpoint_region_name = \</font>
<font color="red">  59.                 self._get_default_s3_region(service_name, endpoint_bridge)</font>
<font color="red">  60.             config_kwargs['region_name'] = endpoint_region_name</font>
<font color="black">  61. </font>
<font color="green">  62.         event_emitter = copy.copy(self._event_emitter)</font>
<font color="green">  63.         signer = RequestSigner(</font>
<font color="green">  64.             service_name, signing_region,</font>
<font color="green">  65.             endpoint_config['signing_name'],</font>
<font color="green">  66.             endpoint_config['signature_version'],</font>
<font color="green">  67.             credentials, event_emitter)</font>
<font color="black">  68. </font>
<font color="green">  69.         config_kwargs['s3'] = s3_config</font>
<font color="green">  70.         new_config = Config(**config_kwargs)</font>
<font color="green">  71.         endpoint_creator = EndpointCreator(event_emitter)</font>
<font color="black">  72. </font>
<font color="green">  73.         endpoint = endpoint_creator.create_endpoint(</font>
<font color="green">  74.             service_model, region_name=endpoint_region_name,</font>
<font color="green">  75.             endpoint_url=endpoint_config['endpoint_url'], verify=verify,</font>
<font color="green">  76.             response_parser_factory=self._response_parser_factory,</font>
<font color="green">  77.             max_pool_connections=new_config.max_pool_connections,</font>
<font color="green">  78.             proxies=new_config.proxies,</font>
<font color="green">  79.             timeout=(new_config.connect_timeout, new_config.read_timeout))</font>
<font color="black">  80. </font>
<font color="green">  81.         serializer = botocore.serialize.create_serializer(</font>
<font color="green">  82.             protocol, parameter_validation)</font>
<font color="green">  83.         response_parser = botocore.parsers.create_parser(protocol)</font>
<font color="green">  84.         return {</font>
<font color="green">  85.             'serializer': serializer,</font>
<font color="green">  86.             'endpoint': endpoint,</font>
<font color="green">  87.             'response_parser': response_parser,</font>
<font color="green">  88.             'event_emitter': event_emitter,</font>
<font color="green">  89.             'request_signer': signer,</font>
<font color="green">  90.             'service_model': service_model,</font>
<font color="green">  91.             'loader': self._loader,</font>
<font color="green">  92.             'client_config': new_config,</font>
<font color="green">  93.             'partition': partition,</font>
<font color="green">  94.             'exceptions_factory': self._exceptions_factory</font>
<font color="black">  95.         }</font>
<font color="black">  96. </font>
<font color="green">  97.     def compute_client_args(self, service_model, client_config,</font>
<font color="black">  98.                             endpoint_bridge, region_name, endpoint_url,</font>
<font color="black">  99.                             is_secure, scoped_config):</font>
<font color="green"> 100.         service_name = service_model.endpoint_prefix</font>
<font color="green"> 101.         protocol = service_model.metadata['protocol']</font>
<font color="green"> 102.         parameter_validation = True</font>
<font color="green"> 103.         if client_config and not client_config.parameter_validation:</font>
<font color="red"> 104.             parameter_validation = False</font>
<font color="green"> 105.         elif scoped_config:</font>
<font color="green"> 106.             raw_value = str(scoped_config.get('parameter_validation', ''))</font>
<font color="green"> 107.             if raw_value.lower() == 'false':</font>
<font color="red"> 108.                 parameter_validation = False</font>
<font color="black"> 109. </font>
<font color="green"> 110.         endpoint_config = endpoint_bridge.resolve(</font>
<font color="green"> 111.             service_name, region_name, endpoint_url, is_secure)</font>
<font color="black"> 112. </font>
<font color="black"> 113.         # Override the user agent if specified in the client config.</font>
<font color="green"> 114.         user_agent = self._user_agent</font>
<font color="green"> 115.         if client_config is not None:</font>
<font color="red"> 116.             if client_config.user_agent is not None:</font>
<font color="red"> 117.                 user_agent = client_config.user_agent</font>
<font color="red"> 118.             if client_config.user_agent_extra is not None:</font>
<font color="red"> 119.                 user_agent += ' %s' % client_config.user_agent_extra</font>
<font color="black"> 120. </font>
<font color="black"> 121.         # Create a new client config to be passed to the client based</font>
<font color="black"> 122.         # on the final values. We do not want the user to be able</font>
<font color="black"> 123.         # to try to modify an existing client with a client config.</font>
<font color="green"> 124.         config_kwargs = dict(</font>
<font color="green"> 125.             region_name=endpoint_config['region_name'],</font>
<font color="green"> 126.             signature_version=endpoint_config['signature_version'],</font>
<font color="green"> 127.             user_agent=user_agent)</font>
<font color="green"> 128.         if client_config is not None:</font>
<font color="red"> 129.             config_kwargs.update(</font>
<font color="red"> 130.                 connect_timeout=client_config.connect_timeout,</font>
<font color="red"> 131.                 read_timeout=client_config.read_timeout,</font>
<font color="red"> 132.                 max_pool_connections=client_config.max_pool_connections,</font>
<font color="red"> 133.                 proxies=client_config.proxies,</font>
<font color="red"> 134.                 retries=client_config.retries</font>
<font color="black"> 135.             )</font>
<font color="green"> 136.         s3_config = self.compute_s3_config(scoped_config,</font>
<font color="green"> 137.                                            client_config)</font>
<font color="green"> 138.         return {</font>
<font color="green"> 139.             'service_name': service_name,</font>
<font color="green"> 140.             'parameter_validation': parameter_validation,</font>
<font color="green"> 141.             'user_agent': user_agent,</font>
<font color="green"> 142.             'endpoint_config': endpoint_config,</font>
<font color="green"> 143.             'protocol': protocol,</font>
<font color="green"> 144.             'config_kwargs': config_kwargs,</font>
<font color="green"> 145.             's3_config': s3_config,</font>
<font color="black"> 146.         }</font>
<font color="black"> 147. </font>
<font color="green"> 148.     def compute_s3_config(self, scoped_config, client_config):</font>
<font color="green"> 149.         s3_configuration = None</font>
<font color="black"> 150. </font>
<font color="black"> 151.         # Check the scoped config first.</font>
<font color="green"> 152.         if scoped_config is not None:</font>
<font color="green"> 153.             s3_configuration = scoped_config.get('s3')</font>
<font color="black"> 154.             # Until we have proper validation of the config file (including</font>
<font color="black"> 155.             # nested types), we have to account for the fact that the s3</font>
<font color="black"> 156.             # key could be parsed as a string, e.g 's3 = foo'.</font>
<font color="black"> 157.             # In the case we'll ignore the key for now.</font>
<font color="green"> 158.             if not isinstance(s3_configuration, dict):</font>
<font color="green"> 159.                 logger.debug(&quot;The s3 config key is not a dictionary type, &quot;</font>
<font color="green"> 160.                              &quot;ignoring its value of: %s&quot;, s3_configuration)</font>
<font color="green"> 161.                 s3_configuration = None</font>
<font color="black"> 162. </font>
<font color="black"> 163.             # Convert logic for several s3 keys in the scoped config</font>
<font color="black"> 164.             # so that the various strings map to the appropriate boolean value.</font>
<font color="green"> 165.             if s3_configuration:</font>
<font color="red"> 166.                 boolean_keys = ['use_accelerate_endpoint',</font>
<font color="red"> 167.                                 'use_dualstack_endpoint',</font>
<font color="red"> 168.                                 'payload_signing_enabled']</font>
<font color="red"> 169.                 s3_configuration = self._convert_config_to_bool(</font>
<font color="red"> 170.                     s3_configuration, boolean_keys)</font>
<font color="black"> 171. </font>
<font color="black"> 172.         # Next specific client config values takes precedence over</font>
<font color="black"> 173.         # specific values in the scoped config.</font>
<font color="green"> 174.         if client_config is not None:</font>
<font color="red"> 175.             if client_config.s3 is not None:</font>
<font color="red"> 176.                 if s3_configuration is None:</font>
<font color="red"> 177.                     s3_configuration = client_config.s3</font>
<font color="black"> 178.                 else:</font>
<font color="black"> 179.                     # The current s3_configuration dictionary may be</font>
<font color="black"> 180.                     # from a source that only should be read from so</font>
<font color="black"> 181.                     # we want to be safe and just make a copy of it to modify</font>
<font color="black"> 182.                     # before it actually gets updated.</font>
<font color="red"> 183.                     s3_configuration = s3_configuration.copy()</font>
<font color="red"> 184.                     s3_configuration.update(client_config.s3)</font>
<font color="black"> 185. </font>
<font color="green"> 186.         return s3_configuration</font>
<font color="black"> 187. </font>
<font color="green"> 188.     def _convert_config_to_bool(self, config_dict, keys):</font>
<font color="black"> 189.         # Make sure any further modifications to this section of the config</font>
<font color="black"> 190.         # will not affect the scoped config by making a copy of it.</font>
<font color="red"> 191.         config_copy = config_dict.copy()</font>
<font color="red"> 192.         present_keys = [k for k in keys if k in config_copy]</font>
<font color="red"> 193.         for key in present_keys:</font>
<font color="black"> 194.             # Normalize on different possible values of True</font>
<font color="red"> 195.             if config_copy[key] in [True, 'True', 'true']:</font>
<font color="red"> 196.                 config_copy[key] = True</font>
<font color="black"> 197.             else:</font>
<font color="red"> 198.                 config_copy[key] = False</font>
<font color="red"> 199.         return config_copy</font>
<font color="black"> 200. </font>
<font color="green"> 201.     def _get_default_s3_region(self, service_name, endpoint_bridge):</font>
<font color="black"> 202.         # If a user is providing a custom URL, the endpoint resolver will</font>
<font color="black"> 203.         # refuse to infer a signing region. If we want to default to s3v4,</font>
<font color="black"> 204.         # we have to account for this.</font>
<font color="red"> 205.         if service_name == 's3':</font>
<font color="red"> 206.             endpoint = endpoint_bridge.resolve('s3')</font>
<font color="red"> 207.             return endpoint['signing_region'], endpoint['region_name']</font>
<font color="red"> 208.         return None, None</font>
</pre>

