source file: <b>/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/pyasn1/type/constraint.py</b><br>


file stats: <b>154 lines, 82 executed: 53.2% covered</b>
<pre>
<font color="black">   1. #</font>
<font color="black">   2. # This file is part of pyasn1 software.</font>
<font color="black">   3. #</font>
<font color="black">   4. # Copyright (c) 2005-2017, Ilya Etingof &lt;etingof@gmail.com&gt;</font>
<font color="black">   5. # License: http://pyasn1.sf.net/license.html</font>
<font color="black">   6. #</font>
<font color="black">   7. # Original concept and code by Mike C. Fletcher.</font>
<font color="black">   8. #</font>
<font color="green">   9. import sys</font>
<font color="green">  10. from pyasn1.type import error</font>
<font color="black">  11. </font>
<font color="green">  12. __all__ = ['SingleValueConstraint', 'ContainedSubtypeConstraint', 'ValueRangeConstraint',</font>
<font color="green">  13.            'ValueSizeConstraint', 'PermittedAlphabetConstraint', 'InnerTypeConstraint',</font>
<font color="green">  14.            'ConstraintsExclusion', 'ConstraintsIntersection', 'ConstraintsUnion']</font>
<font color="black">  15. </font>
<font color="black">  16. </font>
<font color="green">  17. class AbstractConstraint(object):</font>
<font color="black">  18.     &quot;&quot;&quot;Abstract base-class for constraint objects</font>
<font color="black">  19. </font>
<font color="black">  20.        Constraints should be stored in a simple sequence in the</font>
<font color="black">  21.        namespace of their client Asn1Item sub-classes in cases</font>
<font color="black">  22.        when ASN.1 constraint is define.</font>
<font color="green">  23.     &quot;&quot;&quot;</font>
<font color="black">  24. </font>
<font color="green">  25.     def __init__(self, *values):</font>
<font color="green">  26.         self._valueMap = {}</font>
<font color="green">  27.         self._setValues(values)</font>
<font color="green">  28.         self.__hashedValues = None</font>
<font color="black">  29. </font>
<font color="green">  30.     def __call__(self, value, idx=None):</font>
<font color="green">  31.         try:</font>
<font color="green">  32.             self._testValue(value, idx)</font>
<font color="red">  33.         except error.ValueConstraintError:</font>
<font color="red">  34.             raise error.ValueConstraintError(</font>
<font color="red">  35.                 '%s failed at: %r' % (self, sys.exc_info()[1])</font>
<font color="black">  36.             )</font>
<font color="black">  37. </font>
<font color="green">  38.     def __repr__(self):</font>
<font color="red">  39.         return '%s(%s)' % (</font>
<font color="red">  40.             self.__class__.__name__,</font>
<font color="red">  41.             ', '.join([repr(x) for x in self._values])</font>
<font color="black">  42.         )</font>
<font color="black">  43. </font>
<font color="green">  44.     def __eq__(self, other):</font>
<font color="red">  45.         return self is other and True or self._values == other</font>
<font color="black">  46. </font>
<font color="green">  47.     def __ne__(self, other):</font>
<font color="red">  48.         return self._values != other</font>
<font color="black">  49. </font>
<font color="green">  50.     def __lt__(self, other):</font>
<font color="red">  51.         return self._values &lt; other</font>
<font color="black">  52. </font>
<font color="green">  53.     def __le__(self, other):</font>
<font color="red">  54.         return self._values &lt;= other</font>
<font color="black">  55. </font>
<font color="green">  56.     def __gt__(self, other):</font>
<font color="red">  57.         return self._values &gt; other</font>
<font color="black">  58. </font>
<font color="green">  59.     def __ge__(self, other):</font>
<font color="red">  60.         return self._values &gt;= other</font>
<font color="black">  61. </font>
<font color="green">  62.     if sys.version_info[0] &lt;= 2:</font>
<font color="green">  63.         def __nonzero__(self):</font>
<font color="red">  64.             return bool(self._values)</font>
<font color="black">  65.     else:</font>
<font color="red">  66.         def __bool__(self):</font>
<font color="red">  67.             return bool(self._values)</font>
<font color="black">  68. </font>
<font color="green">  69.     def __hash__(self):</font>
<font color="green">  70.         if self.__hashedValues is None:</font>
<font color="green">  71.             self.__hashedValues = hash((self.__class__.__name__, self._values))</font>
<font color="green">  72.         return self.__hashedValues</font>
<font color="black">  73. </font>
<font color="green">  74.     def _setValues(self, values):</font>
<font color="green">  75.         self._values = values</font>
<font color="black">  76. </font>
<font color="green">  77.     def _testValue(self, value, idx):</font>
<font color="red">  78.         raise error.ValueConstraintError(value)</font>
<font color="black">  79. </font>
<font color="black">  80.     # Constraints derivation logic</font>
<font color="green">  81.     def getValueMap(self):</font>
<font color="green">  82.         return self._valueMap</font>
<font color="black">  83. </font>
<font color="green">  84.     def isSuperTypeOf(self, otherConstraint):</font>
<font color="red">  85.         return self in otherConstraint.getValueMap() or \</font>
<font color="red">  86.                otherConstraint is self or otherConstraint == self</font>
<font color="black">  87. </font>
<font color="green">  88.     def isSubTypeOf(self, otherConstraint):</font>
<font color="red">  89.         return otherConstraint in self._valueMap or \</font>
<font color="red">  90.                otherConstraint is self or otherConstraint == self</font>
<font color="black">  91. </font>
<font color="black">  92. </font>
<font color="green">  93. class SingleValueConstraint(AbstractConstraint):</font>
<font color="green">  94.     &quot;&quot;&quot;Value must be part of defined values constraint&quot;&quot;&quot;</font>
<font color="black">  95. </font>
<font color="green">  96.     def _testValue(self, value, idx):</font>
<font color="black">  97.         # XXX index vals for performance?</font>
<font color="green">  98.         if value not in self._values:</font>
<font color="red">  99.             raise error.ValueConstraintError(value)</font>
<font color="black"> 100. </font>
<font color="black"> 101. </font>
<font color="green"> 102. class ContainedSubtypeConstraint(AbstractConstraint):</font>
<font color="green"> 103.     &quot;&quot;&quot;Value must satisfy all of defined set of constraints&quot;&quot;&quot;</font>
<font color="black"> 104. </font>
<font color="green"> 105.     def _testValue(self, value, idx):</font>
<font color="red"> 106.         for c in self._values:</font>
<font color="red"> 107.             c(value, idx)</font>
<font color="black"> 108. </font>
<font color="black"> 109. </font>
<font color="green"> 110. class ValueRangeConstraint(AbstractConstraint):</font>
<font color="green"> 111.     &quot;&quot;&quot;Value must be within start and stop values (inclusive)&quot;&quot;&quot;</font>
<font color="black"> 112. </font>
<font color="green"> 113.     def _testValue(self, value, idx):</font>
<font color="red"> 114.         if value &lt; self.start or value &gt; self.stop:</font>
<font color="red"> 115.             raise error.ValueConstraintError(value)</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def _setValues(self, values):</font>
<font color="green"> 118.         if len(values) != 2:</font>
<font color="red"> 119.             raise error.PyAsn1Error(</font>
<font color="red"> 120.                 '%s: bad constraint values' % (self.__class__.__name__,)</font>
<font color="black"> 121.             )</font>
<font color="green"> 122.         self.start, self.stop = values</font>
<font color="green"> 123.         if self.start &gt; self.stop:</font>
<font color="red"> 124.             raise error.PyAsn1Error(</font>
<font color="red"> 125.                 '%s: screwed constraint values (start &gt; stop): %s &gt; %s' % (</font>
<font color="red"> 126.                     self.__class__.__name__,</font>
<font color="red"> 127.                     self.start, self.stop</font>
<font color="black"> 128.                 )</font>
<font color="black"> 129.             )</font>
<font color="green"> 130.         AbstractConstraint._setValues(self, values)</font>
<font color="black"> 131. </font>
<font color="black"> 132. </font>
<font color="green"> 133. class ValueSizeConstraint(ValueRangeConstraint):</font>
<font color="green"> 134.     &quot;&quot;&quot;len(value) must be within start and stop values (inclusive)&quot;&quot;&quot;</font>
<font color="black"> 135. </font>
<font color="green"> 136.     def _testValue(self, value, idx):</font>
<font color="red"> 137.         l = len(value)</font>
<font color="red"> 138.         if l &lt; self.start or l &gt; self.stop:</font>
<font color="red"> 139.             raise error.ValueConstraintError(value)</font>
<font color="black"> 140. </font>
<font color="black"> 141. </font>
<font color="green"> 142. class PermittedAlphabetConstraint(SingleValueConstraint):</font>
<font color="green"> 143.     def _setValues(self, values):</font>
<font color="red"> 144.         self._values = ()</font>
<font color="red"> 145.         for v in values:</font>
<font color="red"> 146.             self._values = self._values + tuple(v)</font>
<font color="black"> 147. </font>
<font color="green"> 148.     def _testValue(self, value, idx):</font>
<font color="red"> 149.         for v in value:</font>
<font color="red"> 150.             if v not in self._values:</font>
<font color="red"> 151.                 raise error.ValueConstraintError(value)</font>
<font color="black"> 152. </font>
<font color="black"> 153. </font>
<font color="black"> 154. # This is a bit kludgy, meaning two op modes within a single constraint</font>
<font color="green"> 155. class InnerTypeConstraint(AbstractConstraint):</font>
<font color="green"> 156.     &quot;&quot;&quot;Value must satisfy type and presense constraints&quot;&quot;&quot;</font>
<font color="black"> 157. </font>
<font color="green"> 158.     def _testValue(self, value, idx):</font>
<font color="red"> 159.         if self.__singleTypeConstraint:</font>
<font color="red"> 160.             self.__singleTypeConstraint(value)</font>
<font color="red"> 161.         elif self.__multipleTypeConstraint:</font>
<font color="red"> 162.             if idx not in self.__multipleTypeConstraint:</font>
<font color="red"> 163.                 raise error.ValueConstraintError(value)</font>
<font color="red"> 164.             constraint, status = self.__multipleTypeConstraint[idx]</font>
<font color="red"> 165.             if status == 'ABSENT':  # XXX presense is not checked!</font>
<font color="red"> 166.                 raise error.ValueConstraintError(value)</font>
<font color="red"> 167.             constraint(value)</font>
<font color="black"> 168. </font>
<font color="green"> 169.     def _setValues(self, values):</font>
<font color="red"> 170.         self.__multipleTypeConstraint = {}</font>
<font color="red"> 171.         self.__singleTypeConstraint = None</font>
<font color="red"> 172.         for v in values:</font>
<font color="red"> 173.             if isinstance(v, tuple):</font>
<font color="red"> 174.                 self.__multipleTypeConstraint[v[0]] = v[1], v[2]</font>
<font color="black"> 175.             else:</font>
<font color="red"> 176.                 self.__singleTypeConstraint = v</font>
<font color="red"> 177.         AbstractConstraint._setValues(self, values)</font>
<font color="black"> 178. </font>
<font color="black"> 179. </font>
<font color="black"> 180. # Boolean ops on constraints</font>
<font color="black"> 181. </font>
<font color="green"> 182. class ConstraintsExclusion(AbstractConstraint):</font>
<font color="green"> 183.     &quot;&quot;&quot;Value must not fit the single constraint&quot;&quot;&quot;</font>
<font color="black"> 184. </font>
<font color="green"> 185.     def _testValue(self, value, idx):</font>
<font color="red"> 186.         try:</font>
<font color="red"> 187.             self._values[0](value, idx)</font>
<font color="red"> 188.         except error.ValueConstraintError:</font>
<font color="red"> 189.             return</font>
<font color="black"> 190.         else:</font>
<font color="red"> 191.             raise error.ValueConstraintError(value)</font>
<font color="black"> 192. </font>
<font color="green"> 193.     def _setValues(self, values):</font>
<font color="red"> 194.         if len(values) != 1:</font>
<font color="red"> 195.             raise error.PyAsn1Error('Single constraint expected')</font>
<font color="red"> 196.         AbstractConstraint._setValues(self, values)</font>
<font color="black"> 197. </font>
<font color="black"> 198. </font>
<font color="green"> 199. class AbstractConstraintSet(AbstractConstraint):</font>
<font color="green"> 200.     &quot;&quot;&quot;Value must not satisfy the single constraint&quot;&quot;&quot;</font>
<font color="black"> 201. </font>
<font color="green"> 202.     def __getitem__(self, idx): return self._values[idx]</font>
<font color="black"> 203. </font>
<font color="green"> 204.     def __add__(self, value): return self.__class__(self, value)</font>
<font color="black"> 205. </font>
<font color="green"> 206.     def __radd__(self, value): return self.__class__(value, self)</font>
<font color="black"> 207. </font>
<font color="green"> 208.     def __len__(self): return len(self._values)</font>
<font color="black"> 209. </font>
<font color="black"> 210.     # Constraints inclusion in sets</font>
<font color="black"> 211. </font>
<font color="green"> 212.     def _setValues(self, values):</font>
<font color="green"> 213.         self._values = values</font>
<font color="green"> 214.         for v in values:</font>
<font color="green"> 215.             self._valueMap[v] = 1</font>
<font color="green"> 216.             self._valueMap.update(v.getValueMap())</font>
<font color="black"> 217. </font>
<font color="black"> 218. </font>
<font color="green"> 219. class ConstraintsIntersection(AbstractConstraintSet):</font>
<font color="green"> 220.     &quot;&quot;&quot;Value must satisfy all constraints&quot;&quot;&quot;</font>
<font color="black"> 221. </font>
<font color="green"> 222.     def _testValue(self, value, idx):</font>
<font color="green"> 223.         for v in self._values:</font>
<font color="green"> 224.             v(value, idx)</font>
<font color="black"> 225. </font>
<font color="black"> 226. </font>
<font color="green"> 227. class ConstraintsUnion(AbstractConstraintSet):</font>
<font color="green"> 228.     &quot;&quot;&quot;Value must satisfy at least one constraint&quot;&quot;&quot;</font>
<font color="black"> 229. </font>
<font color="green"> 230.     def _testValue(self, value, idx):</font>
<font color="red"> 231.         for v in self._values:</font>
<font color="red"> 232.             try:</font>
<font color="red"> 233.                 v(value, idx)</font>
<font color="red"> 234.             except error.ValueConstraintError:</font>
<font color="red"> 235.                 pass</font>
<font color="black"> 236.             else:</font>
<font color="red"> 237.                 return</font>
<font color="red"> 238.         raise error.ValueConstraintError(</font>
<font color="red"> 239.             'all of %s failed for \&quot;%s\&quot;' % (self._values, value)</font>
<font color="black"> 240.         )</font>
<font color="black"> 241. </font>
<font color="black"> 242. # XXX</font>
<font color="black"> 243. # add tests for type check</font>
</pre>

